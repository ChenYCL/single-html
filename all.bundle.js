!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="/",i(i.s=0)}([function(t,e,i){i(1)},function(t,e){marmoset={},function(t){"use strict";function e(t,e,n){if(this.name=e.partName,this.animatedProperties=[],this.sceneObjectType=e.sceneObjectType,this.skinningRigIndex=e.skinningRigIndex,this.id=n,this.mesh=this.skinningRig=0,this.materialIndex=this.lightIndex=this.meshIndex=-1,this.emissiveProperty=this.offsetVProperty=this.offsetUProperty=this.material=0,this.debugMe=e.debugMe,this.debugString="",this.hasTransform=!1,this.modelPartIndex=e.modelPartIndex,this.modelPartFPS=e.modelPartFPS,this.modelPartScale=e.modelPartScale,this.parentIndex=e.parentIndex,this.startTime=e.startTime,this.endTime=e.endTime,this.animationLength=this.endTime-this.startTime,this.totalFrames=e.totalFrames,this.turnTableSpinOffset=this.turnTableSpin=this.spinProperty=this.dispersionProperty=this.lightIllumProperty=this.skyIllumProperty=this.opacityProperty=this.spotSharpnessProperty=this.spotAngleProperty=this.distanceProperty=this.brightnessProperty=this.blueProperty=this.greenProperty=this.redProperty=this.visibleProperty=0,e.animatedProperties){n=e.animatedProperties.length;for(var r=0;r<n;++r){var o=e.animatedProperties[r],a=new i;a.name=o.name,this.animatedProperties.push(a),"Red"!=a.name||this.redProperty||(this.redProperty=a),"Green"!=a.name||this.greenProperty||(this.greenProperty=a),"Blue"!=a.name||this.blueProperty||(this.blueProperty=a),"Brightness"!=a.name||this.brightnessProperty||(this.brightnessProperty=a),"Distance"!=a.name||this.distanceProperty||(this.distanceProperty=a),"Spot Angle"!=a.name||this.spotAngleProperty||(this.spotAngleProperty=a),"Spot Sharpness"!=a.name||this.spotSharpnessProperty||(this.spotSharpnessProperty=a),"Opacity"!=a.name||this.opacityProperty||(this.opacityProperty=a),"Sky Illumination"!=a.name||this.skyIllumProperty||(this.skyIllumProperty=a),"Light Illumination"!=a.name||this.lightIllumProperty||(this.lightIllumProperty=a),"Dispersion"!=a.name||this.dispersionProperty||(this.dispersionProperty=a),"Visible"!=a.name||this.visibleProperty||(this.visibleProperty=a),"Spin Rate"==a.name&&(this.spinProperty=a),"OffsetU"==a.name&&(this.offsetUProperty=a),"OffsetV"==a.name&&(this.offsetVProperty=a),"EmissiveIntensity"==a.name&&(this.emissiveProperty=a)}}this.keyframesSharedBufferUShorts=this.keyframesSharedBufferFloats=this.keyFramesByteStream=0,(t=t.get(e.file))&&(this.keyFramesByteStream=new l(t.data),this.unPackKeyFrames()),this.animatedLocalTransform=new s(this),this.hasTransform=this.animatedLocalTransform.hasTranslation||this.animatedLocalTransform.hasRotation||this.animatedLocalTransform.hasScale,this.cachedWorldTransform0=T.identity(),this.cachedWorldTransform1=T.identity(),this.cachedWorldTransform2=T.identity(),this.cachedWorldTransform3=T.identity(),this.cachedFrame3=this.cachedFrame2=this.cachedFrame1=this.cachedFrame0=-10,this.cachedFrameUse3=this.cachedFrameUse2=this.cachedFrameUse1=this.cachedFrameUse0=0,this.useFixedLocalTransform=this.useFixedWorldTransform=!1}function i(){this.currentValue=0,this.keyframeBufferStartIndexFloat=-1,this.lastValue=this.interpolationOffsetUShort=this.frameIndexOffsetUShort=this.weighOutOffsetFloat=this.weighInOffsetFloat=this.valueOffsetFloat=this.indexUShortSkip=this.indexFloatSkip=this.interpolationType=this.bytesPerKeyFrame=this.keyframePackingType=0,this.lastFramePercent=-10,this.enable=!0,this.name="NONE",this.splineKF0=new y(0,0),this.splineKF1=new y(0,0),this.splineKF2=new y(0,0),this.splineKF3=new y(0,0),this.debugMe=!0,this.debugString="",this.lastSearchIndex=1,this.savedSearchIndex=0,this.splineKF0.frameIndex=0,this.splineKF1.frameIndex=1,this.splineKF2.frameIndex=2,this.splineKF3.frameIndex=3,this.numKeyframes=0}function s(t){var e=t.animatedProperties;for(this.TX=this.TY=this.TZ=this.RX=this.RY=this.RZ=this.SX=this.SY=this.SZ=0,this.hostObject=t,this.matrix=T.identity(),this.cachedmatrix0=T.identity(),this.cachedmatrix1=T.identity(),this.cachedmatrix2=T.identity(),this.cachedmatrix3=T.identity(),this.cachedFrame3=this.cachedFrame2=this.cachedFrame1=this.cachedFrame0=-1,this.cachedFrameUse3=this.cachedFrameUse2=this.cachedFrameUse1=this.cachedFrameUse0=0,this.debugString="",t=0;t<e.length;t++){var i=e[t];"Translation X"==i.name?this.TX=i:"Translation Y"==i.name?this.TY=i:"Translation Z"==i.name?this.TZ=i:"Rotation X"==i.name?this.RX=i:"Rotation Y"==i.name?this.RY=i:"Rotation Z"==i.name?this.RZ=i:"Scale X"==i.name?this.SX=i:"Scale Y"==i.name?this.SY=i:"Scale Z"==i.name&&(this.SZ=i)}this.hasTranslation=this.TX&&this.TY&&this.TZ,this.hasRotation=this.RX&&this.RY&&this.RZ,this.hasScale=this.SX&&this.SY&&this.SZ,this.lockTransform=!1}function n(t,i){if(this.originalFPS=1,this.name=i.name,this.totalSeconds=i.length,this.originalFPS=i.originalFPS,this.totalFrames=i.totalFrames,this.expectedNumAnimatedObjects=i.numAnimatedObjects,this.animatedObjects=[],this.sceneTransform=T.identity(),this.debugString="",i.animatedObjects)for(var s=i.animatedObjects.length,n=0;n<s;++n){var r=new e(t,i.animatedObjects[n],n);this.animatedObjects.push(r),this.debugString+=r.debugString}this.meshObjects=[],this.lightObjects=[],this.materialObjects=[],this.turnTableObjects=[],this.cameraObjects=[]}function r(t){for(this.files=[],t=new l(t);!t.empty();){var e={};e.name=t.readCString(),e.type=t.readCString();var i=t.readUint32(),s=t.readUint32(),n=t.readUint32();if(e.data=t.readBytes(s),!(e.data.length<s)){if(1&i&&(e.data=this.decompress(e.data,n),null===e.data))continue;this.files[e.name]=e}}}function o(t){this.digits=new Uint16Array(t||0)}function a(t){for(var e=0;e<t.length;++e){var i=t[e].bounds;if(void 0===this.min)this.min=[i.min[0],i.min[1],i.min[2]],this.max=[i.max[0],i.max[1],i.max[2]];else for(var s=0;s<3;++s)this.min[s]=Math.min(i.min[s],this.min[s]),this.max[s]=Math.max(i.max[s],this.max[s])}this.min=this.min?this.min:[0,0,0],this.max=this.max?this.max:[0,0,0],this.center=[.5*(this.min[0]+this.max[0]),.5*(this.min[1]+this.max[1]),.5*(this.min[2]+this.max[2])],this.radius=[this.max[0]-this.center[0],this.max[1]-this.center[1],this.max[2]-this.center[2]],this.radiusDiagonal=Math.sqrt(this.radius[0]*this.radius[0]+this.radius[1]*this.radius[1]+this.radius[2]*this.radius[2])}function h(t){this.name="none",this.text="default text",this.title="none",this.debugString=this.imagePath="",this.controlRect=new d(t),this.defaultAlpha=.5,this.focusAlpha=1,this.updateAlphas=!0,this.linkedBackground=this.backgroundOffsetY=this.backgroundOffsetX=this.edgePixelsY=this.edgePixelsX=this.backgroundBottomMiddle=this.backgroundBottomRight=this.backgroundBottomLeft=this.backgroundMiddleMiddle=this.backgroundMiddleRight=this.backgroundMiddleLeft=this.backgroundTopMiddle=this.backgroundTopRight=this.backgroundTopLeft=this.backgroundMiddle=this.backgroundRight=this.backgroundLeft=0}function l(t){this.bytes=new Uint8Array(t)}function d(t){this.name="none",this.title="frame",this.yPercent=this.xPercent=0,this.heightPercent=this.widthPercent=1,this.debugString="",this.parentControlRect=0,this.childControlRects=[],this.clicked=this.mouseDown=this.mouseOver=!1,this.localMouseYPercent=this.localMouseXPercent=0,this.enabled=this.visible=!0,this.opacity=1,this.guiScreen=t,this.id=this.callBack=this.linkedControl=0}function c(t,e,i,s){var n=!1,o=t+(-1==t.indexOf("?")?"?":"&")+"thumb=1",a=function(t){return(t=new r(t).extract("thumbnail.jpg"))?N.parseFile(t,e,s):n?i&&i():(n=!0,R.fetchBinaryIncremental(o,a,i,394240)),0};R.fetchBinaryIncremental(o,a,i,65536)}function u(t,e){this.desc=e,this.gl=t,this.iblShader=t.shaderCache.fromURLs("fogvert.glsl","fogfrag.glsl",["#define FOG_IBL"]);var i=["#define FOG_DIR"];this.dirShader=t.shaderCache.fromURLs("fogvert.glsl","fogfrag.glsl",i),i.push("#define FOG_SHADOWS"),this.dirShaderShadow=t.shaderCache.fromURLs("fogvert.glsl","fogfrag.glsl",i),i=["#define FOG_SPOT"],this.spotShader=t.shaderCache.fromURLs("fogvert.glsl","fogfrag.glsl",i),i.push("#define FOG_SHADOWS"),this.spotShaderShadow=t.shaderCache.fromURLs("fogvert.glsl","fogfrag.glsl",i),i=["#define FOG_OMNI"],this.omniShaderShadow=this.omniShader=t.shaderCache.fromURLs("fogvert.glsl","fogfrag.glsl",i),this.fullscreenTriangle=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.fullscreenTriangle),i=new Float32Array([0,0,2,0,0,2]),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null)}function f(t,e){this.gl=t,this.fbo=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this.fbo),e&&(this.width=e.width,this.height=e.height,e.color0&&(this.color0=e.color0,t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.color0.id,0),this.width=e.color0.desc.width,this.height=e.color0.desc.height),e.depth?(this.depth=e.depth,t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,this.depth.id,0)):(this.depthBuffer=e.depthBuffer,e.createDepth&&!this.depthBuffer&&(this.depthBuffer=f.createDepthBuffer(t,this.width,this.height)),this.depthBuffer&&(t.bindRenderbuffer(t.RENDERBUFFER,this.depthBuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer),t.bindRenderbuffer(t.RENDERBUFFER,null)))),this.valid=e&&e.ignoreStatus||t.checkFramebufferStatus(t.FRAMEBUFFER)==t.FRAMEBUFFER_COMPLETE,t.bindFramebuffer(t.FRAMEBUFFER,null)}e.prototype.setFixedWorldTransform=function(t){this.useFixedWorldTransform=!0,T.copy(this.cachedWorldTransform0,t)},e.prototype.setFixedLocalTransform=function(t){this.useFixedLocalTransform=!0,this.animatedLocalTransform.lockTransform=!0,T.copy(this.animatedLocalTransform.cachedmatrix0,t)},e.prototype.getCachedWorldTransform=function(t){return this.useFixedWorldTransform?0:t==this.cachedFrame0?this.cachedmatrix0:t==this.cachedFrame1?this.cachedmatrix1:t==this.cachedFrame2?this.cachedmatrix2:t==this.cachedFrame3?this.cachedmatrix3:0},e.prototype.getFreeCachedWorldTransform=function(t){return this.useFixedWorldTransform?0:(this.cachedFrameUse0--,this.cachedFrameUse1--,this.cachedFrameUse2--,this.cachedFrameUse3--,this.cachedFrameUse0<=this.cachedFrameUse1&&this.cachedFrameUse0<=this.cachedFrameUse2&&this.cachedFrameUse0<=this.cachedFrameUse3?(this.cachedFrame0=t,this.cachedFrameUse0=0,this.cachedWorldTransform0):this.cachedFrameUse1<=this.cachedFrameUse0&&this.cachedFrameUse1<=this.cachedFrameUse2&&this.cachedFrameUse1<=this.cachedFrameUse3?(this.cachedFrame1=t,this.cachedFrameUse1=0,this.cachedWorldTransform1):this.cachedFrameUse2<=this.cachedFrameUse0&&this.cachedFrameUse2<=this.cachedFrameUse1&&this.cachedFrameUse2<=this.cachedFrameUse3?(this.cachedFrame2=t,this.cachedFrameUse2=0,this.cachedWorldTransform2):(this.cachedFrame3=t,this.cachedFrameUse3=0,this.cachedWorldTransform3))},e.prototype.unPackKeyFrames=function(){if(this.keyFramesByteStream){var t=new Float32Array(this.keyFramesByteStream.bytes.buffer),e=new Uint32Array(this.keyFramesByteStream.bytes.buffer),i=new Uint16Array(this.keyFramesByteStream.bytes.buffer),s=new Uint8Array(this.keyFramesByteStream.bytes.buffer);this.keyframesSharedBufferFloats=t;t=0,t=1+(e=(this.keyframesSharedBufferUShorts=e)[0]),e=this.animatedProperties.length;for(var n=0;n<e;n++){var r=this.animatedProperties[n],o=2+2*n,a=2*o;r.keyframeBufferStartIndexFloat=t,r.numKeyframes=i[o],r.keyframePackingType=s[2+a],r.interpolationType=s[3+a],r.indexFloatSkip=0,(r.indexUShortSkip=0)<r.numKeyframes&&(0==r.keyframePackingType?(r.bytesPerKeyFrame=16,r.indexFloatSkip=4,r.indexUShortSkip=8,r.valueOffsetFloat=0,r.weighInOffsetFloat=1,r.weighOutOffsetFloat=2,r.frameIndexOffsetUShort=6,r.interpolationOffsetUShort=7):1==r.keyframePackingType?(r.bytesPerKeyFrame=8,r.indexFloatSkip=2,r.indexUShortSkip=4,r.valueOffsetFloat=0,r.weighInOffsetFloat=0,r.weighOutOffsetFloat=0,r.frameIndexOffsetUShort=2,r.interpolationOffsetUShort=3):2==r.keyframePackingType&&(r.bytesPerKeyFrame=4,r.indexFloatSkip=1,r.indexUShortSkip=2,r.valueOffsetFloat=0,r.weighInOffsetFloat=0,r.weighOutOffsetFloat=0,r.frameIndexOffsetUShort=0,r.interpolationOffsetUShort=0)),t+=r.numKeyframes*r.indexFloatSkip}}},e.prototype.setupSkinningRig=function(t,e,i,s){var n=T.identity(),r=T.identity(),o=(o=i*(a=t.animatedObjects[e]).modelPartFPS)-Math.floor(o),a=(i=Math.floor(t.getObjectAnimationFramePercent(a,i)))+1,h=1-o,l=s.skinningClusters.length;if(0<l)for(var d=0;d<l;d++){(c=s.skinningClusters[d]).solveClusterTransformAtFrame(t,e,i,n),c.solveClusterTransformAtFrame(t,e,a,r);for(var c=c.matrix,u=0;u<16;u++)c[u]=n[u]*h+r[u]*o}},e.prototype.evaluateLocalTransformAtFramePercent=function(t,e,i,s){var n;this.useFixedLocalTransform?T.copy(e,this.animatedLocalTransform.cachedmatrix0):(n=0,s&&(n=this.animatedLocalTransform.getCachedTransform(t)),n?T.copy(e,n):((n=this.animatedLocalTransform.getFreeCachedTransform(t))?(this.animatedLocalTransform.evaluateMatrix(n,this.totalFrames,t,i),T.copy(e,n)):this.animatedLocalTransform.evaluateMatrix(e,this.totalFrames,t,i),0!=this.turnTableSpin&&(t=T.rotation(T.empty(),this.turnTableSpin,1),T.mul(e,e,t))))},e.prototype.hasAnimatedTransform=function(){var t=this.animatedLocalTransform;return!!(t.TX&&1<t.TX.numKeyframes||t.TY&&1<t.TY.numKeyframes||t.TZ&&1<t.TZ.numKeyframes||t.RX&&1<t.RX.numKeyframes||t.RY&&1<t.RY.numKeyframes||t.RZ&&1<t.RZ.numKeyframes||t.SX&&1<t.SX.numKeyframes||t.SY&&1<t.SY.numKeyframes||t.SZ&&1<t.SZ.numKeyframes)},i.prototype.evaluateCurve=function(t,e){var i=this.splineKF1.frameIndex,s=this.splineKF2.frameIndex,n=this.splineKF1.value,r=this.splineKF2.value,o=i-(this.splineKF2.frameIndex-this.splineKF0.frameIndex),a=s-(this.splineKF1.frameIndex-this.splineKF3.frameIndex),h=n-(this.splineKF2.value-this.splineKF0.value)*this.splineKF1.weighOut,l=r-(this.splineKF1.value-this.splineKF3.value)*this.splineKF2.weighIn;return 3==this.splineKF1.interpolation&&(o=i-(this.splineKF2.frameIndex-this.splineKF1.frameIndex),h=n-this.splineKF1.weighOut),3==this.splineKF2.interpolation&&(a=s-(this.splineKF1.frameIndex-this.splineKF2.frameIndex),l=r+this.splineKF2.weighIn),o=(t-o)/(i-o),i=(t-i)/(s-i),s=(t-s)/(a-s),((h*(1-o)+n*o)*(1-i)+(a=n*(1-i)+r*i)*i)*(1-i)+((r*(1-s)+l*s)*i+a*(1-i))*i},i.prototype.evaluate=function(t,e,i){if(!i)return e;if(0==this.numKeyframes)return this.lastValue=e;if(1==this.numKeyframes)return this.lastValue=2==this.keyframePackingType?i.keyframesSharedBufferFloats[this.keyframeBufferStartIndexFloat]:i.keyframesSharedBufferFloats[this.keyframeBufferStartIndexFloat+this.valueOffsetFloat];if(this.lastFramePercent==t)return this.lastValue;var s=this.keyframeBufferStartIndexFloat,n=2*this.keyframeBufferStartIndexFloat;if(this.lastValue=e,this.lastFramePercent=t,2==this.keyframePackingType){var r=t-(e=Math.floor(t));return t>=this.numKeyframes&&(e-=Math.floor(t/this.numKeyframes)*this.numKeyframes),e>=this.numKeyframes-1?this.lastValue=i.keyframesSharedBufferFloats[s+(this.numKeyframes-1)]:e<0?this.lastValue=i.keyframesSharedBufferFloats[s]:0==r?this.lastValue=i.keyframesSharedBufferFloats[s+e]:(t=n=i.keyframesSharedBufferFloats[s+e],++e>=this.numKeyframes&&(e-=this.numKeyframes),0<=e&&e<this.numKeyframes?t=n*(1-r)+i.keyframesSharedBufferFloats[s+e]*r:i.debugString+="<br>bad lerp frame "+e+" of "+this.numKeyframes,this.lastValue=t)}var o=this.numKeyframes;r=i.keyframesSharedBufferUShorts[n+this.frameIndexOffsetUShort];if(t>=i.keyframesSharedBufferUShorts[n+(o-1)*this.indexUShortSkip+this.frameIndexOffsetUShort])return this.lastValue=i.keyframesSharedBufferFloats[s+(o-1)*this.indexFloatSkip+this.valueOffsetFloat];if(t<r)return this.lastValue=i.keyframesSharedBufferFloats[s+this.valueOffsetFloat];this.lastSearchIndex<this.numKeyframes&&t>i.keyframesSharedBufferUShorts[n+this.lastSearchIndex*this.indexUShortSkip+this.frameIndexOffsetUShort]&&(this.lastSearchIndex=1);for(var a=this.lastSearchIndex;a<o;a++){r=s+a*this.indexFloatSkip;var h=s+(a-1)*this.indexFloatSkip,l=n+a*this.indexUShortSkip,d=n+(a-1)*this.indexUShortSkip;if(t>=i.keyframesSharedBufferUShorts[d+this.frameIndexOffsetUShort]&&t<=i.keyframesSharedBufferUShorts[l+this.frameIndexOffsetUShort]){this.lastSearchIndex=a;var c=i.keyframesSharedBufferUShorts[d+this.interpolationOffsetUShort];if(2==c){this.lastValue=t=t>=i.keyframesSharedBufferUShorts[l+this.frameIndexOffsetUShort]?i.keyframesSharedBufferFloats[r+this.valueOffsetFloat]:i.keyframesSharedBufferFloats[h+this.valueOffsetFloat];break}if(0==c){s=i.keyframesSharedBufferUShorts[d+this.frameIndexOffsetUShort],e=i.keyframesSharedBufferFloats[h+this.valueOffsetFloat],n=i.keyframesSharedBufferFloats[r+this.valueOffsetFloat],r=(t-s)/(i.keyframesSharedBufferUShorts[l+this.frameIndexOffsetUShort]-s),this.lastValue=t=e*(1-r)+n*r;break}if(1==c||3==c){var u=c=!1,f=0,m=i.keyframesSharedBufferFloats[h+this.valueOffsetFloat],p=i.keyframesSharedBufferFloats[r+this.valueOffsetFloat],g=0,x=0,y=(d=i.keyframesSharedBufferUShorts[d+this.frameIndexOffsetUShort],l=i.keyframesSharedBufferUShorts[l+this.frameIndexOffsetUShort],0),v=1,b=1,S=1,T=1,C=1,w=1,R=1,A=1;0!=this.weighInOffsetFloat&&(b=i.keyframesSharedBufferFloats[h+this.weighInOffsetFloat],S=i.keyframesSharedBufferFloats[r+this.weighInOffsetFloat],w=i.keyframesSharedBufferFloats[h+this.weighOutOffsetFloat],R=i.keyframesSharedBufferFloats[r+this.weighOutOffsetFloat]),1<a&&(c=!0,f=i.keyframesSharedBufferFloats[s+(a-2)*this.indexFloatSkip+this.valueOffsetFloat],x=i.keyframesSharedBufferUShorts[n+(a-2)*this.indexUShortSkip+this.frameIndexOffsetUShort],0!=this.weighInOffsetFloat&&(v=i.keyframesSharedBufferFloats[s+(a-2)*this.indexFloatSkip+this.weighInOffsetFloat],C=i.keyframesSharedBufferFloats[s+(a-2)*this.indexFloatSkip+this.weighOutOffsetFloat])),a<o-1&&(u=!0,g=i.keyframesSharedBufferFloats[s+(a+1)*this.indexFloatSkip+this.valueOffsetFloat],y=i.keyframesSharedBufferUShorts[n+(a+1)*this.indexUShortSkip+this.frameIndexOffsetUShort],0!=this.weighInOffsetFloat&&(T=i.keyframesSharedBufferFloats[s+(a+1)*this.indexFloatSkip+this.weighInOffsetFloat],A=i.keyframesSharedBufferFloats[s+(a+1)*this.indexFloatSkip+this.weighOutOffsetFloat])),c&&u?(this.splineKF0.value=f,this.splineKF1.value=m,this.splineKF2.value=p,this.splineKF3.value=g,this.splineKF0.frameIndex=x,this.splineKF1.frameIndex=d,this.splineKF2.frameIndex=l,this.splineKF3.frameIndex=y,this.splineKF0.weighIn=v,this.splineKF0.weighOut=C,this.splineKF1.weighIn=b,this.splineKF1.weighOut=w,this.splineKF2.weighIn=S,this.splineKF2.weighOut=R,this.splineKF3.weighIn=T,this.splineKF3.weighOut=A):(this.splineKF0.value=m,this.splineKF1.value=m,this.splineKF2.value=p,this.splineKF3.value=p,this.splineKF0.frameIndex=d,this.splineKF1.frameIndex=d,this.splineKF2.frameIndex=l,this.splineKF3.frameIndex=l,this.splineKF1.weighIn=b,this.splineKF2.weighIn=S,this.splineKF1.weighOut=w,this.splineKF2.weighOut=R,u?(this.splineKF3.value=g,this.splineKF3.frameIndex=y,this.splineKF3.weighIn=T,this.splineKF3.weighOut=A):(this.splineKF3.frameIndex++,this.splineKF3.value=this.splineKF1.value,this.splineKF3.weighIn=1,this.splineKF3.weighOut=1),c?(this.splineKF0.value=f,this.splineKF0.frameIndex=x,this.splineKF0.weighIn=v,this.splineKF0.weighOut=C):(this.splineKF0.value=this.splineKF2.value,this.splineKF0.weighIn=1,this.splineKF0.weighOut=1,0<this.splineKF0.frameIndex?this.splineKF0.frameIndex--:(this.splineKF1.frameIndex++,this.splineKF2.frameIndex++,this.splineKF3.frameIndex++,t++))),this.lastValue=t=this.evaluateCurve(t,e);break}}}return this.lastValue},s.prototype.getTRSValue=function(t,e,i){return e?(e.evaluate(t,i,this.hostObject),""!=e.debugString&&(this.debugString+=e.debugString),e.lastValue):i},s.prototype.evaluateMatrix=function(t,e,i,s){var n,r;this.lockTransform?T.copy(t,this.cachedmatrix0):(r=n=e=n=e=r=0,r=n=e=1,this.hasRotation?(r=this.getTRSValue(i,this.RX,0),e=this.getTRSValue(i,this.RY,0),n=this.getTRSValue(i,this.RZ,0),s?(this.matrix=T.rotation(T.empty(),n,2),s=T.rotation(T.empty(),r,0),T.mul(s,s,this.matrix),this.matrix=T.rotation(T.empty(),e,1)):(this.matrix=T.rotation(T.empty(),r,0),s=T.rotation(T.empty(),e,1),T.mul(s,s,this.matrix),this.matrix=T.rotation(T.empty(),n,2)),T.mul(this.matrix,this.matrix,s)):T.copy(this.matrix,T.identity()),this.hasTranslation&&(e=this.getTRSValue(i,this.TX,0),n=this.getTRSValue(i,this.TY,0),r=this.getTRSValue(i,this.TZ,0),this.matrix[12]=e,this.matrix[13]=n,this.matrix[14]=r),this.hasScale&&(e=this.getTRSValue(i,this.SX,1),n=this.getTRSValue(i,this.SY,1),r=this.getTRSValue(i,this.SZ,1),this.matrix[0]*=e,this.matrix[4]*=n,this.matrix[8]*=r,this.matrix[1]*=e,this.matrix[5]*=n,this.matrix[9]*=r,this.matrix[2]*=e,this.matrix[6]*=n,this.matrix[10]*=r,this.matrix[3]*=e,this.matrix[7]*=n,this.matrix[11]*=r),T.copy(t,this.matrix))},s.prototype.clearCachedTransforms=function(){this.cachedFrame3=this.cachedFrame2=this.cachedFrame1=this.cachedFrame0=-1,this.cachedFrameUse3=this.cachedFrameUse2=this.cachedFrameUse1=this.cachedFrameUse0=0,this.TX&&(this.TX.lastFramePercent=-10),this.TY&&(this.TY.lastFramePercent=-10),this.TZ&&(this.TZ.lastFramePercent=-10),this.RX&&(this.RX.lastFramePercent=-10),this.RY&&(this.RY.lastFramePercent=-10),this.RZ&&(this.RZ.lastFramePercent=-10),this.SX&&(this.SX.lastFramePercent=-10),this.SY&&(this.SY.lastFramePercent=-10),this.SZ&&(this.SZ.lastFramePercent=-10),this.lockTransform=!1},s.prototype.getCachedTransform=function(t){return this.lockTransform?0:this.cachedFrame0==t?this.cachedmatrix0:this.cachedFrame1==t?this.cachedmatrix1:this.cachedFrame2==t?this.cachedmatrix2:this.cachedFrame3==t?this.cachedmatrix3:0},s.prototype.getFreeCachedTransform=function(t){return this.lockTransform?0:(this.cachedFrameUse0--,this.cachedFrameUse1--,this.cachedFrameUse2--,this.cachedFrameUse3--,this.cachedFrameUse0<=this.cachedFrameUse1&&this.cachedFrameUse0<=this.cachedFrameUse2&&this.cachedFrameUse0<=this.cachedFrameUse3||this.cachedFrame0==t?(this.cachedFrame0=t,this.cachedFrameUse0=0,this.cachedmatrix0):this.cachedFrameUse1<=this.cachedFrameUse0&&this.cachedFrameUse1<=this.cachedFrameUse2&&this.cachedFrameUse1<=this.cachedFrameUse3||this.cachedFrame1==t?(this.cachedFrame1=t,this.cachedFrameUse1=0,this.cachedmatrix1):this.cachedFrameUse2<=this.cachedFrameUse0&&this.cachedFrameUse2<=this.cachedFrameUse1&&this.cachedFrameUse2<=this.cachedFrameUse3||this.cachedFrame2==t?(this.cachedFrame2=t,this.cachedFrameUse2=0,this.cachedmatrix2):(this.cachedFrame3=t,this.cachedFrameUse3=0,this.cachedmatrix3))},n.prototype.evaluateModelPartTransformAtFrame=function(t,e,i,s){T.copy(i,T.identity());for(var n=0;n<100;n++){var r=this.animatedObjects[t];if(t==r.parentIndex)break;if(r.useFixedWorldTransform){T.mul(i,r.cachedWorldTransform0,i);break}var o=0;if(s&&(o=r.getCachedWorldTransform(e)),o){T.mul(i,o,i);break}o=T.identity(),r.evaluateLocalTransformAtFramePercent(e,o,!1,s),T.mul(i,o,i),t==r.parentIndex&&(n=100),t=r.parentIndex}},n.prototype.lerpModelPartTransform=function(t,e,i,s){var n=this.animatedObjects[t];if(n.useFixedWorldTransform)T.copy(i,n.cachedWorldTransform0);else{var r=(r=e*n.modelPartFPS)-Math.floor(r),o=Math.floor(this.getObjectAnimationFramePercent(n,e)),a=o+1,h=e=0;for(s&&(e=n.getCachedWorldTransform(o),h=n.getCachedWorldTransform(a)),e||((e=n.getFreeCachedWorldTransform(o))||(e=T.identity()),this.evaluateModelPartTransformAtFrame(t,o,e,s)),h||((h=n.getFreeCachedWorldTransform(a))||(h=T.identity()),this.evaluateModelPartTransformAtFrame(t,a,h,s)),t=1-r,s=0;s<16;s++)i[s]=e[s]*t+h[s]*r}},n.prototype.getModelPartTransform=function(t,e,i,s){this.lerpModelPartTransform(t,e,i,s)},n.prototype.getAnimatedLocalTransform=function(t,e,i,s){t=this.animatedObjects[t];var n,r=this.animatedObjects[t.parentIndex],o=r.modelPartIndex!=r.id,a=T.identity();this.getModelPartTransform(t.modelPartIndex,e,a,s),o?(o=T.identity(),n=T.identity(),this.getModelPartTransform(r.modelPartIndex,e,o,s),T.invert(n,o),T.mul(i,n,a),i[12]*=t.modelPartScale,i[13]*=t.modelPartScale,i[14]*=t.modelPartScale):T.copy(i,a)},n.prototype.isVisibleAtFramePercent=function(t,e){for(var i=t,s=0,n=0;n<100;n++){if((s=this.animatedObjects[i]).visibleProperty){if(s.visibleProperty.evaluate(e,1,s),""!=s.debugString||""!=s.visibleProperty.debugString)return this.debugString+=s.debugString,this.debugString+=s.visibleProperty.debugString,!1;if(0==s.visibleProperty.lastValue)return!1}i==s.parentIndex&&(n=100),i=s.parentIndex}return!0},n.prototype.getWorldTransform=function(t,e,i,s,n){if((t=this.animatedObjects[t]).useFixedWorldTransform)T.copy(i,t.cachedWorldTransform0);else{var r,o=this.getObjectAnimationFramePercent(t,e),a=T.identity();if(t.evaluateLocalTransformAtFramePercent(o,a,!0,n),(o=t.modelPartIndex!=t.id)&&(o=T.identity(),r=T.identity(),T.copy(r,a),this.getAnimatedLocalTransform(t.id,e,o),T.mul(a,o,r)),T.copy(i,a),t.parentIndex!=t.id)for(var h=t.parentIndex,l=0;l<100;l++)t=this.animatedObjects[h],o=this.getObjectAnimationFramePercent(t,e),a=T.identity(),t.evaluateLocalTransformAtFramePercent(o,a,!0,n),(o=t.modelPartIndex!=t.id)?(o=T.identity(),this.getAnimatedLocalTransform(t.id,e,o),r=T.identity(),T.mul(r,a,i),T.mul(i,o,r)):(r=T.identity(),T.copy(r,i),T.mul(i,a,r)),h==t.parentIndex&&(l=100),h=t.parentIndex;i[12]*=s,i[13]*=s,i[14]*=s}},n.prototype.hasParentInHierarchy=function(t,e){for(var i=t.parentIndex,s=0;s<100;s++){if((t=this.animatedObjects[i]).id==e)return!0;i==t.parentIndex&&(s=100),i=t.parentIndex}return!1},n.prototype.hasParentTypeInHierarchy=function(t,e){for(var i=t.parentIndex,s=0;s<100;s++){if((t=this.animatedObjects[i]).sceneObjectType==e)return!0;i==t.parentIndex&&(s=100),i=t.parentIndex}return!1},n.prototype.searchAnimationUpHierarchy=function(t){for(var e=t.id,i=0;i<100;i++){if((t=this.animatedObjects[e]).animatedLocalTransform&&(t.hasAnimatedTransform()||t.id!=t.modelPartIndex&&this.searchAnimationUpHierarchy(this.animatedObjects[t.modelPartIndex])))return!0;e==t.parentIndex&&(i=100),e=t.parentIndex}return!1},n.prototype.hasAnimationInHierarchy=function(t){return!!(this.searchAnimationUpHierarchy(t)||t.id!=t.modelPartIndex&&this.searchAnimationUpHierarchy(this.animatedObjects[t.modelPartIndex])||this.hasParentTypeInHierarchy(t,"TurnTableSO")||this.hasParentTypeInHierarchy(t,"CameraSO")||"CameraSO"==t.sceneObjectType)},n.prototype.getObjectAnimationFramePercent=function(t,e){if(0==this.totalFrames||0==t.animationLength)return 0;if(t.endTime==this.totalSeconds)return e*t.modelPartFPS;var i=e/t.animationLength;i=Math.floor(i);return(i=(e-=t.animationLength*i)*t.modelPartFPS)>=t.totalFrames+1&&(i=t.totalFrames),i},r.prototype.get=function(t){return this.files[t]},r.prototype.extract=function(t){var e=this.files[t];return delete this.files[t],e},r.prototype.checkSignature=function(t){if(!t)return!1;var e=this.get(t.name+".sig");if(!e)return!1;if(!(e=JSON.parse(String.fromCharCode.apply(null,e.data))))return!1;for(var i=5381,s=0;s<t.data.length;++s)i=33*i+t.data[s]&4294967295;return(t=new o).setBytes([0,233,33,170,116,86,29,195,228,46,189,3,185,31,245,19,159,105,73,190,158,80,175,38,210,116,221,229,171,134,104,144,140,5,99,255,208,78,248,215,172,44,79,83,5,244,152,19,92,137,112,10,101,142,209,100,244,92,190,125,28,0,185,54,143,247,49,37,15,254,142,180,185,232,50,219,11,186,106,116,78,212,10,105,53,26,14,181,80,47,87,213,182,19,126,151,86,109,182,224,37,135,80,59,22,93,125,68,214,106,209,152,235,157,249,245,48,76,203,0,0,95,200,246,243,229,85,79,169],!0),(s=new o).setBytes(e[0]),s.powmod(65537,t).toInt32()==i},r.prototype.decompress=function(t,e){var i=new Uint8Array(e),s=0,n=new Uint32Array(4096),r=new Uint32Array(4096),o=256,a=t.length,h=0,l=1,d=0,c=1;i[s++]=t[0];for(var u=1;!(a<=(c=u+(u>>1))+1);u++){d=t[c+1],c=t[c];var f=1&u?d<<4|c>>4:(15&d)<<8|c;if(f<o)if(f<256)d=s,c=1,i[s++]=f;else{d=s,c=r[f];for(var m=(f=n[f])+c;f<m;)i[s++]=i[f++]}else{if(f!=o)break;for(d=s,c=l+1,m=(f=h)+l;f<m;)i[s++]=i[f++];i[s++]=i[h]}n[o]=h,r[o++]=l+1,h=d,l=c,o=4096<=o?256:o}return s==e?i:null},o.prototype.setBytes=function(t,e){var i=(t.length+1)/2|0;if(this.digits=new Uint16Array(i),e){var s=0;for(i=t.length-1;0<=i;i-=2)this.digits[s++]=t[i]+(0<i?256*t[i-1]:0)}else for(s=0;s<i;++s)this.digits[s]=t[2*s]+256*t[2*s+1];this.trim()},o.prototype.toInt32=function(){var t=0;return 0<this.digits.length&&(t=this.digits[0],1<this.digits.length&&(t|=this.digits[1]<<16)),t},o.prototype.lessThan=function(t){if(this.digits.length==t.digits.length)for(var e=this.digits.length-1;0<=e;--e){var i=this.digits[e],s=t.digits[e];if(i!=s)return i<s}return this.digits.length<t.digits.length},o.prototype.shiftRight=function(){for(var t=0,e=this.digits,i=e.length-1;0<=i;--i){var s=e[i];e[i]=s>>1|t<<15,t=s}this.trim()},o.prototype.shiftLeft=function(t){if(0<t){for(var e=t/16|0,i=16-(t%=16),s=this.digits.length+e+1,n=new o(s),r=0;r<s;++r)n.digits[r]=65535&((r<e||r>=this.digits.length+e?0:this.digits[r-e])<<t|(r<1+e?0:this.digits[r-e-1])>>>i);return n.trim(),n}return new o(this)},o.prototype.bitCount=function(){var t=0;if(0<this.digits.length){t=16*(this.digits.length-1);for(var e=this.digits[this.digits.length-1];e;)e>>>=1,++t}return t},o.prototype.sub=function(t){var e=this.digits,i=t.digits,s=this.digits.length;t=t.digits.length;for(var n=0,r=0;r<s;++r){var o=e[r],a=r<t?i[r]:0;o=o+((n=o<(a+=n)?1:0)<<16);e[r]=o-a&65535}this.trim()},o.prototype.mul=function(t){for(var e=new o(this.digits.length+t.digits.length),i=e.digits,s=0;s<this.digits.length;++s)for(var n=this.digits[s],r=0;r<t.digits.length;++r)for(var a=n*t.digits[r],h=s+r;a;){var l=(65535&a)+i[h];i[h]=65535&l,a>>>=16,a+=l>>>16,++h}return e.trim(),e},o.prototype.mod=function(t){if(this.digits.length<=0||t.digits.length<=0)return new o(0);var e=new o(this.digits);if(!this.lessThan(t)){for(var i=(i=new o(t.digits)).shiftLeft(e.bitCount()-i.bitCount());!e.lessThan(t);)i.lessThan(e)&&e.sub(i),i.shiftRight();e.trim()}return e},o.prototype.powmod=function(t,e){for(var i=new o([1]),s=this.mod(e);t;)1&t&&(i=i.mul(s).mod(e)),t>>>=1,s=s.mul(s).mod(e);return i},o.prototype.trim=function(){for(var t=this.digits.length;0<t&&0==this.digits[t-1];)--t;t!=this.digits.length&&(this.digits=this.digits.subarray(0,t))},h.prototype.setBackground3x1=function(t,e,i,s,n,r,o){this.backgroundOffsetX=e,this.backgroundOffsetY=i,this.edgePixelsX=o,this.backgroundLeft=t.addImage(s),this.backgroundMiddle=t.addImage(n),this.backgroundRight=t.addImage(r),this.backgroundLeft.linkedControl.style.zIndex="0",this.backgroundMiddle.linkedControl.style.zIndex="0",this.backgroundRight.linkedControl.style.zIndex="0",this.setOpacity(this.defaultAlpha)},h.prototype.setBackground3x3=function(t,e,i,s,n,r,o,a,h,l,d,c,u,f){this.backgroundOffsetX=e,this.backgroundOffsetY=i,this.edgePixelsX=u,this.edgePixelsY=f,this.backgroundTopLeft=t.addImage(s),this.backgroundMiddleLeft=t.addImage(o),this.backgroundBottomLeft=t.addImage(l),this.backgroundTopMiddle=t.addImage(n),this.backgroundMiddleMiddle=t.addImage(a),this.backgroundBottomMiddle=t.addImage(d),this.backgroundTopRight=t.addImage(r),this.backgroundMiddleRight=t.addImage(h),this.backgroundBottomRight=t.addImage(c),this.backgroundTopLeft.linkedControl.style.zIndex="0",this.backgroundTopRight.linkedControl.style.zIndex="0",this.backgroundTopMiddle.linkedControl.style.zIndex="0",this.backgroundMiddleLeft.linkedControl.style.zIndex="0",this.backgroundMiddleRight.linkedControl.style.zIndex="0",this.backgroundMiddleMiddle.linkedControl.style.zIndex="0",this.backgroundBottomLeft.linkedControl.style.zIndex="0",this.backgroundBottomRight.linkedControl.style.zIndex="0",this.backgroundBottomMiddle.linkedControl.style.zIndex="0",this.setOpacity(this.defaultAlpha)},h.prototype.alignBackground=function(){var t,e=(r=this.controlRect).guiScreen,i=e.left*(1-r.getScreenXPercent()),s=e.bottom*(1-r.getScreenYPercent()),n=e.width*r.getScreenWidthPercent(),r=e.height*r.getScreenHeightPercent();s+=this.backgroundOffsetY,i+=this.backgroundOffsetX;this.backgroundTopLeft&&this.backgroundTopRight&&this.backgroundTopMiddle&&this.backgroundMiddleLeft&&this.backgroundMiddleRight&&this.backgroundMiddleMiddle&&this.backgroundBottomLeft&&this.backgroundBottomRight&&this.backgroundBottomMiddle&&(e=n-2*this.edgePixelsX,t=r-2*this.edgePixelsY,this.backgroundTopLeft.linkedControl.style.height=this.edgePixelsY+"px",this.backgroundTopMiddle.linkedControl.style.height=this.edgePixelsY+"px",this.backgroundTopRight.linkedControl.style.height=this.edgePixelsY+"px",this.backgroundBottomLeft.linkedControl.style.height=this.edgePixelsY+"px",this.backgroundBottomMiddle.linkedControl.style.height=this.edgePixelsY+"px",this.backgroundBottomRight.linkedControl.style.height=this.edgePixelsY+"px",this.backgroundMiddleLeft.linkedControl.style.height=t+"px",this.backgroundMiddleMiddle.linkedControl.style.height=t+"px",this.backgroundMiddleRight.linkedControl.style.height=t+"px",this.backgroundTopLeft.linkedControl.style.width=this.edgePixelsX+"px",this.backgroundBottomLeft.linkedControl.style.width=this.edgePixelsX+"px",this.backgroundMiddleLeft.linkedControl.style.width=this.edgePixelsX+"px",this.backgroundTopRight.linkedControl.style.width=this.edgePixelsX+"px",this.backgroundBottomRight.linkedControl.style.width=this.edgePixelsX+"px",this.backgroundMiddleRight.linkedControl.style.width=this.edgePixelsX+"px",this.backgroundTopMiddle.linkedControl.style.width=e+"px",this.backgroundBottomMiddle.linkedControl.style.width=e+"px",this.backgroundMiddleMiddle.linkedControl.style.width=e+"px",this.backgroundTopLeft.linkedControl.style.left=i+"px",this.backgroundBottomLeft.linkedControl.style.left=i+"px",this.backgroundMiddleLeft.linkedControl.style.left=i+"px",i+=this.edgePixelsX,this.backgroundTopMiddle.linkedControl.style.left=i+"px",this.backgroundBottomMiddle.linkedControl.style.left=i+"px",this.backgroundMiddleMiddle.linkedControl.style.left=i+"px",i+=e,this.backgroundTopRight.linkedControl.style.left=i+"px",this.backgroundBottomRight.linkedControl.style.left=i+"px",this.backgroundMiddleRight.linkedControl.style.left=i+"px",this.backgroundBottomLeft.linkedControl.style.bottom=s+"px",this.backgroundBottomMiddle.linkedControl.style.bottom=s+"px",this.backgroundBottomRight.linkedControl.style.bottom=s+"px",s+=this.edgePixelsY,this.backgroundMiddleLeft.linkedControl.style.bottom=s+"px",this.backgroundMiddleRight.linkedControl.style.bottom=s+"px",this.backgroundMiddleMiddle.linkedControl.style.bottom=s+"px",s+=t,this.backgroundTopLeft.linkedControl.style.bottom=s+"px",this.backgroundTopMiddle.linkedControl.style.bottom=s+"px",this.backgroundTopRight.linkedControl.style.bottom=s+"px"),this.backgroundLeft&&this.backgroundRight&&this.backgroundMiddle&&(n-=2*this.edgePixelsX,this.backgroundLeft.linkedControl.style.bottom=s+"px",this.backgroundMiddle.linkedControl.style.bottom=s+"px",this.backgroundRight.linkedControl.style.bottom=s+"px",this.backgroundLeft.linkedControl.style.height=r+"px",this.backgroundMiddle.linkedControl.style.height=r+"px",this.backgroundRight.linkedControl.style.height=r+"px",this.backgroundLeft.linkedControl.style.width=this.edgePixelsX+"px",this.backgroundMiddle.linkedControl.style.width=n+"px",this.backgroundRight.linkedControl.style.width=this.edgePixelsX+"px",this.backgroundLeft.linkedControl.style.left=i+"px",i+=this.edgePixelsX,this.backgroundMiddle.linkedControl.style.left=i+"px",this.backgroundRight.linkedControl.style.left=i+n+"px")},h.prototype.setOpacity=function(t){this.controlRect.linkedControl.style.opacity=t,this.backgroundLeft&&(this.backgroundLeft.linkedControl.style.opacity=t),this.backgroundRight&&(this.backgroundRight.linkedControl.style.opacity=t),this.backgroundMiddle&&(this.backgroundMiddle.linkedControl.style.opacity=t),this.backgroundTopLeft&&(this.backgroundTopLeft.linkedControl.style.opacity=t),this.backgroundTopRight&&(this.backgroundTopRight.linkedControl.style.opacity=t),this.backgroundTopMiddle&&(this.backgroundTopMiddle.linkedControl.style.opacity=t),this.backgroundMiddleLeft&&(this.backgroundMiddleLeft.linkedControl.style.opacity=t),this.backgroundMiddleRight&&(this.backgroundMiddleRight.linkedControl.style.opacity=t),this.backgroundMiddleMiddle&&(this.backgroundMiddleMiddle.linkedControl.style.opacity=t),this.backgroundBottomLeft&&(this.backgroundBottomLeft.linkedControl.style.opacity=t),this.backgroundBottomRight&&(this.backgroundBottomRight.linkedControl.style.opacity=t),this.backgroundBottomMiddle&&(this.backgroundBottomMiddle.linkedControl.style.opacity=t)},h.prototype.setBackgroundVisible=function(t){this.backgroundLeft&&this.backgroundLeft.showControl(t),this.backgroundRight&&this.backgroundRight.showControl(t),this.backgroundMiddle&&this.backgroundMiddle.showControl(t),this.backgroundTopLeft&&this.backgroundTopLeft.showControl(t),this.backgroundTopRight&&this.backgroundTopRight.showControl(t),this.backgroundTopMiddle&&this.backgroundTopMiddle.showControl(t),this.backgroundMiddleLeft&&this.backgroundMiddleLeft.showControl(t),this.backgroundMiddleRight&&this.backgroundMiddleRight.showControl(t),this.backgroundMiddleMiddle&&this.backgroundMiddleMiddle.showControl(t),this.backgroundBottomLeft&&this.backgroundBottomLeft.showControl(t),this.backgroundBottomRight&&this.backgroundBottomRight.showControl(t),this.backgroundBottomMiddle&&this.backgroundBottomMiddle.showControl(t)},h.prototype.setVisible=function(t){this.controlRect.showControl(t),this.setBackgroundVisible(t)},h.prototype.linkControl=function(t){(this.controlRect.linkedControl=t).onmouseover=function(){this.updateAlphas&&(this.setOpacity(this.focusAlpha),this.controlRect.mouseOver=!0,this.linkedBackground&&this.linkedBackground.setOpacity(this.focusAlpha))}.bind(this),t.onmouseout=function(){this.updateAlphas&&(this.setOpacity(this.defaultAlpha),this.controlRect.mouseOver=!1,this.linkedBackground&&this.linkedBackground.setOpacity(this.defaultAlpha))}.bind(this)},l.prototype.empty=function(){return this.bytes.length<=0},l.prototype.readCString=function(){for(var t=this.bytes,e=t.length,i=0;i<e;++i)if(0==t[i])return t=String.fromCharCode.apply(null,this.bytes.subarray(0,i)),this.bytes=this.bytes.subarray(i+1),t;return null},l.prototype.asString=function(){for(var t="",e=0;e<this.bytes.length;++e)t+=String.fromCharCode(this.bytes[e]);return t},l.prototype.readBytes=function(t){var e=this.bytes.subarray(0,t);return this.bytes=this.bytes.subarray(t),e},l.prototype.readUint32=function(){var t=this.bytes,e=t[0]|t[1]<<8|t[2]<<16|t[3]<<24;return this.bytes=t.subarray(4),e},l.prototype.readUint8=function(){var t=this.bytes,e=t[0];return this.bytes=t.subarray(1),e},l.prototype.readUint16=function(){var t=this.bytes,e=t[0]|t[1]<<8;return this.bytes=t.subarray(2),e},l.prototype.readFloat32=function(){var t=new Uint8Array(this.bytes);t=new Float32Array(t.buffer);return this.bytes=this.bytes.subarray(4),t[0]},l.prototype.seekUint32=function(t){return(t=this.bytes.subarray(4*t))[0]|t[1]<<8|t[2]<<16|t[3]<<24},l.prototype.seekFloat32=function(t){return t=new Uint8Array(this.bytes.subarray(4*t)),new Float32Array(t.buffer)[0]},l.prototype.getMatrix=function(t){return new Float32Array(this.bytes.buffer,64*t,16)},d.prototype.getScreenWidth=function(){if(this.linkedControl)return this.guiScreen.width*this.getScreenWidthPercent()},d.prototype.getScreenHeight=function(){if(this.linkedControl)return this.guiScreen.height*this.getScreenHeightPercent()},d.prototype.updateElement=function(){var t,e,i,s,n=this.linkedControl;n&&(t=this.guiScreen.left*(1-this.getScreenXPercent()),e=this.guiScreen.bottom*(1-this.getScreenYPercent()),i=this.guiScreen.width*this.getScreenWidthPercent(),s=this.guiScreen.height*this.getScreenHeightPercent(),n.style.left=t+"px",n.style.bottom=e+"px",n.style.width=i+"px",n.style.height=s+"px")},d.prototype.updateElement=function(){var t,e,i,s,n=this.linkedControl;n&&(t=this.guiScreen.left*(1-this.getScreenXPercent()),e=this.guiScreen.bottom*(1-this.getScreenYPercent()),i=this.guiScreen.width*this.getScreenWidthPercent(),s=this.guiScreen.height*this.getScreenHeightPercent(),n.style.left=t+"px",n.style.bottom=e+"px",n.style.width=i+"px",n.style.height=s+"px")},d.prototype.updateChildElements=function(){this.updateElement();for(var t=0;t<this.childControlRects.length;t++)this.childControlRects[t].updateChildElements()},d.prototype.set=function(t,e,i,s){this.xPercent=t,this.yPercent=e,this.widthPercent=i,this.heightPercent=s},d.prototype.linkControl=function(t){(this.linkedControl=t).onmouseover=function(){this.mouseOver=!0}.bind(this),t.onmouseout=function(){this.mouseOver=!1}.bind(this),t.onmousedown=function(){this.mouseDown=!0}.bind(this),t.onmouseup=function(){this.mouseDown=!1}.bind(this),t.onclick=function(){this.callBack&&this.callBack(this),this.clicked=!0}.bind(this)},d.prototype.showControl=function(t){this.visible=t,this.linkedControl&&(this.linkedControl.style.display=t?"block":"none")},d.prototype.setOpacity=function(t){this.opacity=t,this.linkedControl&&(this.linkedControl.style.opacity=t)},d.prototype.hasChildControlRect=function(t){for(var e=0;e<this.childControlRects.length;e++)if(this.childControlRects[e]==t)return!0;return!1},d.prototype.registerChildControlRect=function(t){this.hasChildControlRect(t)||(this.childControlRects.push(t),t.parentControlRect=this)},d.prototype.getScreenWidthPercent=function(){var t=this.widthPercent;return this.parentControlRect&&(t*=this.parentControlRect.getScreenWidthPercent()),t},d.prototype.getScreenHeightPercent=function(){var t=this.heightPercent;return this.parentControlRect&&(t*=this.parentControlRect.getScreenHeightPercent()),t},d.prototype.getScreenXPercent=function(){var t=this.xPercent;return this.parentControlRect&&(t*=this.parentControlRect.getScreenWidthPercent(),t+=this.parentControlRect.getScreenXPercent()),t},d.prototype.getScreenYPercent=function(){var t=this.yPercent;return this.parentControlRect&&(t*=this.parentControlRect.getScreenHeightPercent(),t+=this.parentControlRect.getScreenYPercent()),t},(t=void 0===t?{}:t).embed=function(t,e){var i,s,n,r,o,a=(e=function(t){if(t=t||{},document.location.search)for(var e=document.location.search.substring(1).split("&"),i=0;i<e.length;++i){var s=e[i].split("=");t[s[0]]=s[1]}return e=function(t){if(0|t)return!0;for(var e="true True TRUE yes Yes YES".split(" "),i=0;i<e.length;++i)if(t===e[i])return!0;return!1},t.width=t.width||800,t.height=t.height||600,t.autoStart=e(t.autoStart),t.pagePreset=e(t.pagePreset),t.fullFrame=e(t.fullFrame)||e(t.bare),t.fullFrame=!t.pagePreset&&t.fullFrame,t}(e)).thumbnailURL;return e.pagePreset?(i=new W(e.width,e.height,t,!!a),document.body.style.backgroundColor="#d7e4da",(s=document.createElement("div")).style.position="relative",s.style.backgroundColor="#e4e7e4",s.style.width=e.width+12+"px",s.style.height=e.height+6+16+"px",s.style.margin="auto",s.style.boxShadow="3px 5px 12px 0px grey",document.body.appendChild(s),(n=document.createElement("div")).style.position="relative",n.style.left="6px",n.style.top="6px",s.appendChild(n),n.appendChild(i.domRoot),i.mobile||(s.style.resize="both",s.style.overflow="hidden",r=[s.style.width,s.style.height],(o=function(){m.active()?s.style.resize="none":(s.style.resize="both",r[0]==s.style.width&&r[1]==s.style.height||(r[0]=s.style.width,r[1]=s.style.height,i.resize(s.clientWidth-12,s.clientHeight-6-16))),window.setTimeout(o,100)})())):(i=new W(e.fullFrame?window.innerWidth:e.width,e.fullFrame?window.innerHeight:e.height,t,!!a),document.body.appendChild(i.domRoot),e.fullFrame&&(i.domRoot.style.position="absolute",i.domRoot.style.left=i.domRoot.style.top=0,window.addEventListener("resize",(function(){m.active()||i.resize(window.innerWidth,window.innerHeight)})))),i.ui.setThumbnailURL(a),e.autoStart&&i.loadScene(),i},t.fetchThumbnail=c,u.prototype.draw=function(t,e){var i=this.gl,s=t.view,n=s.projectionMatrix,r=T.empty();T.mul(r,s.viewMatrix,s.projectionMatrix),T.invert(r,s.viewProjectionMatrix),r=[n[10]+n[11],-n[14],-2*n[11]],n=[-2/n[0],-2/n[5],(1-n[8])/n[0],(1-n[9])/n[5]],i.enable(i.BLEND),i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA);for(var o=0;o<t.lights.count+1;++o){var a=o-1,h=a<t.lights.shadowCount,l=0==o?this.iblShader:0<t.lights.spot[3*a]?h?this.spotShaderShadow:this.spotShader:0<t.lights.getLightPos(a)[3]?this.omniShader:h?this.dirShaderShadow:this.dirShader;l.bind();var d=l.params;if(i.uniform3fv(d.uDepthToZ,r),i.uniform4fv(d.uUnproject,n),i.uniformMatrix4fv(d.uInvViewMatrix,!1,s.transform),i.uniform1f(d.uFogInvDistance,1/this.desc.distance),i.uniform1f(d.uFogOpacity,this.desc.opacity*(1-t.stripData.activeFade())),i.uniform1f(d.uFogDispersion,1-this.desc.dispersion),(u=[0,0,0])[this.desc.type]=1,i.uniform3fv(d.uFogType,u),i.uniform3fv(d.uFogColor,this.desc.color),i.uniform1f(d.uFogIllum,0==o?this.desc.skyIllum:this.desc.lightIllum),i.uniformMatrix4fv(d.uLightMatrix,!1,t.lights.invMatrix),0==o){for(a=new Float32Array(t.sky.diffuseCoefficients),h=4;h<16;++h)a[h]*=1-this.desc.dispersion;for(h=16;h<36;++h)a[h]*=1-this.desc.dispersion*this.desc.dispersion;i.uniform4fv(d.uFogLightSphere,a)}else{var c=t.lights.getLightPos(a),u=(c=T.mul4(V.empty(),t.lights.invMatrix,c[0],c[1],c[2],c[3]),t.lights.getLightDir(a));u=T.mulVec(V.empty(),t.lights.invMatrix,u[0],u[1],u[2]);i.uniform4fv(d.uLightPosition,c),i.uniform3fv(d.uLightColor,t.lights.getColor(a));c=.01745329251*t.lights.spot[3*a];var f=Math.cos(.5*c);i.uniform4fv(d.uSpotParams,[-u[0],-u[1],-u[2],0<c?f*f:0]),i.uniform4fv(d.uLightAttenuation,[t.lights.parameters[3*a+0],t.lights.parameters[3*a+1],t.lights.parameters[3*a+2],f]),h&&(h=T.mul(T.empty(),t.lights.finalTransformBuffer.subarray(16*a),t.lights.matrix),i.uniformMatrix4fv(d.uShadowProj,!1,h),t.shadow.depthTextures[a].bind(l.samplers.uShadowMap),a=0,1<t.postRender.sampleCount&&(a=t.postRender.currentSample()/t.postRender.sampleCount),i.uniform1f(d.uDitherOffset,a),i.uniform3fv(d.uAABBMin,t.bounds.min),i.uniform3fv(d.uAABBMax,t.bounds.max),a=V.lerp(V.empty(),t.bounds.min,t.bounds.max,.5),h=V.distance(a,t.bounds.min),i.uniform4f(d.uCylinder,a[0],a[1],a[2],h*h))}e.bind(l.samplers.tDepth),l=l.attribs.vCoord,i.bindBuffer(i.ARRAY_BUFFER,this.fullscreenTriangle),i.enableVertexAttribArray(l),i.vertexAttribPointer(l,2,i.FLOAT,!1,0,0),i.drawArrays(i.TRIANGLES,0,3),i.disableVertexAttribArray(l),i.bindBuffer(i.ARRAY_BUFFER,null)}i.disable(i.BLEND)},u.prototype.complete=function(){return this.iblShader.complete()&&this.dirShader.complete()&&this.dirShaderShadow.complete()&&this.spotShader.complete()&&this.spotShaderShadow.complete()&&this.omniShader.complete()&&this.omniShaderShadow.complete()},f.createDepthBuffer=function(t,e,i){var s=t.createRenderbuffer();return t.bindRenderbuffer(t.RENDERBUFFER,s),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e,i),t.bindRenderbuffer(t.RENDERBUFFER,null),s},f.prototype.bind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo),this.gl.viewport(0,0,this.width,this.height)},f.bindNone=function(t){t.bindFramebuffer(t.FRAMEBUFFER,null)};var m={support:function(){return!!(document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled)},begin:function(t,e){var i,s=t.requestFullscreen||t.webkitRequestFullScreen||t.mozRequestFullScreen||t.msRequestFullscreen;s&&(i=function(){m.active()||(document.removeEventListener("fullscreenchange",i),document.removeEventListener("webkitfullscreenchange",i),document.removeEventListener("mozfullscreenchange",i),document.removeEventListener("MSFullscreenChange",i)),e&&e()},document.addEventListener("fullscreenchange",i),document.addEventListener("webkitfullscreenchange",i),document.addEventListener("mozfullscreenchange",i),document.addEventListener("MSFullscreenChange",i),s.bind(t)())},end:function(){var t=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen;t&&t.bind(document)()},active:function(){return!!(document.fullscreenElement||document.webkitIsFullScreen||document.mozFullScreenElement||document.msFullscreenElement)}};function p(t){this.debugString="GUIRegion",this.name="Default",this.controlRect=new d(t),this.yPercent=this.xPercent=0,this.heightPercent=this.widthPercent=1,this.guiScreen=t}function g(t){this.init=!1,this.ui=t,this.bottom=this.left=this.height=this.width=0,this.clicked=this.mouseDown=!1,this.playbackControls=0,t=1,window.devicePixelRatio&&(2<window.devicePixelRatio?t=4:1<window.devicePixelRatio&&(t=2)),this.imageSetNumber=t}function x(t){this.onTap=[],this.onSingleTap=[],this.onDoubleTap=[],this.onDrag=[],this.onZoom=[],this.onPan=[],this.onPan2=[],this.onAnything=[],this.mouseDownCount=0,this.macHax=0<=navigator.platform.toUpperCase().indexOf("MAC"),t&&this.attach(t)}function y(t,e){t&&e?(this.frameIndex=e.frameIndex,this.value=e.value,this.interpolation=e.interpolation,this.weighIn=e.weighIn,this.weighOut=e.weighOut):(this.interpolation=this.value=this.frameIndex=0,this.weighOut=this.weighIn=1)}function v(t,e){for(var i in this.rotation=this.shadowCount=this.count=0,this.positions=[],this.directions=[],this.matrixWeights=[],this.matrix=T.identity(),this.invMatrix=T.identity(),this.defaultmatrix=T.identity(),this.defaultviewmatrix=T.identity(),t)this[i]=t[i];this.count=this.positions.length/4,this.count=Math.min(6,this.count),this.shadowCount=Math.min(3,this.shadowCount),this.positions=new Float32Array(this.positions),this.positionBuffer=new Float32Array(this.positions),this.directions=new Float32Array(this.directions),this.directionBuffer=new Float32Array(this.directions),this.colors=new Float32Array(this.colors),this.colorsBuffer=new Float32Array(this.colors),this.modelViewBuffer=new Float32Array(16*this.shadowCount),this.projectionBuffer=new Float32Array(16*this.shadowCount),this.finalTransformBuffer=new Float32Array(16*this.shadowCount),this.inverseTransformBuffer=new Float32Array(16*this.shadowCount),this.shadowTexelPadProjections=new Float32Array(4*this.shadowCount),this.shadowsNeedUpdate=new Uint8Array(this.shadowCount);for(var s=0;s<this.shadowsNeedUpdate.length;++s)this.shadowsNeedUpdate[s]=1;for(T.rotation(this.matrix,this.rotation,1),T.transpose(this.invMatrix,this.matrix),T.copy(this.defaultmatrix,this.matrix),T.copy(this.defaultviewmatrix,e.viewMatrix),s=0;s<this.count;++s){i=this.positions.subarray(4*s,4*s+4);var n=this.directions.subarray(3*s,3*s+3);1==this.matrixWeights[s]?(T.mul4(i,this.matrix,i[0],i[1],i[2],i[3]),T.mulVec(n,this.matrix,n[0],n[1],n[2])):2==this.matrixWeights[s]&&(T.mul4(i,e.viewMatrix,i[0],i[1],i[2],i[3]),T.mulVec(n,e.viewMatrix,n[0],n[1],n[2]))}}function b(t){this.name="none",this.text="default text",this.title="none",this.debugString=this.imagePath="",this.controlRect=new d(t),this.textEntries=[],this.textOffsetsX=[],this.textOffsetsY=[],this.buttons=[],this.listBoxEntryHeight=20,this.selectedItemText="",this.selectedIndex=-1,this.localPixelsY=0,this.localPixelsX=100,this.labelPixelDrop=0,this.labelPixelInset=10,this.labelTextHeight=16,this.closed=!1,this.defaultButtonText=this.spacerMiddle=this.spacerRight=this.spacerLeft=this.spacerControl=0,this.listBoxButtons=[],this.listBoxRegion=new p(t),this.guiScreen=t,this.lastMouseOverIndex=-1,this.selectionChangedCallback=0,this.debugString=""}function S(t,e,i){this.gl=t,this.name=i.name;var s={mipmap:!0,aniso:t.hints.mobile?0:4,clamp:!!i.textureWrapClamp,mirror:!!i.textureWrapMirror},n={mipmap:s.mipmap,clamp:s.clamp,mirror:s.mirror,nofilter:i.textureFilterNearest||!1};if(n.nofilter||(n.aniso=t.hints.mobile?2:4),this.textures={albedo:t.textureCache.fromFilesMergeAlpha(e.get(i.albedoTex),e.get(i.alphaTex),n),reflectivity:t.textureCache.fromFilesMergeAlpha(e.get(i.reflectivityTex),e.get(i.glossTex),s),normal:t.textureCache.fromFile(e.get(i.normalTex),s),extras:t.textureCache.fromFilesMergeAlpha(e.get(i.extrasTex),e.get(i.extrasTexA),s)},this.extrasTexCoordRanges={},i.extrasTexCoordRanges)for(var r in i.extrasTexCoordRanges)this.extrasTexCoordRanges[r]=new Float32Array(i.extrasTexCoordRanges[r].scaleBias);this.textures.extras||((e=new U(t,{width:1,height:1})).loadArray(new Uint8Array([255,255,255,255])),this.textures.extras=e);var o=i.blendTint||[1,1,1];e={none:function(){t.disable(t.BLEND)},alpha:function(){t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE_MINUS_DST_ALPHA,t.ONE)},add:function(){t.enable(t.BLEND),t.blendColor(o[0],o[1],o[2],1),t.blendFunc(t.ONE,t.CONSTANT_COLOR)}},this.blend=e[i.blend]||e.none,this.alphaTest=i.alphaTest||0,this.usesBlending=this.blend!==e.none,this.usesRefraction=!!i.refraction,this.shadowAlphaTest=this.alphaTest,this.shadowAlphaTest<=0&&this.blend===e.alpha&&(this.shadowAlphaTest=.5),this.castShadows=this.blend!==e.add,this.horizonOcclude=i.horizonOcclude||0,this.fresnel=new Float32Array(i.fresnel?i.fresnel:[1,1,1]),this.emissiveIntensity=i.emissiveIntensity||1,n=!(s=[]),0<i.lightCount&&s.push("#define LIGHT_COUNT "+i.lightCount),0<i.shadowCount&&(r=Math.min(i.lightCount,i.shadowCount),this.usesRefraction&&t.limits.textureCount<=8&&(r=2<r?2:r),s.push("#define SHADOW_COUNT "+r)),0<i.alphaTest&&s.push("#define ALPHA_TEST"),this.blend===e.alpha?s.push("#define TRANSPARENCY_DITHER"):this.blend===e.none&&s.push("#define NOBLEND"),t.hints.mobile&&s.push("#define MOBILE"),t.ext.textureDepth&&s.push("#define SHADOW_NATIVE_DEPTH"),r=function(t){return 1/(2/3*3.1415962*(t*t+t+1))},i.useSkin&&(s.push("#define SKIN"),this.skinParams=i.skinParams||{subdermisColor:[1,1,1],transColor:[1,0,0,1],fresnelColor:[.2,.2,.2,.5],fresnelOcc:1,fresnelGlossMask:1,transSky:.5,shadowBlur:.5,normalSmooth:.5,transScatter:0,transDepth:0,millimeterScale:1},this.extrasTexCoordRanges.subdermisTex||s.push("#define SKIN_NO_SUBDERMIS_TEX"),this.extrasTexCoordRanges.translucencyTex||s.push("#define SKIN_NO_TRANSLUCENCY_TEX"),this.extrasTexCoordRanges.fuzzTex||s.push("#define SKIN_NO_FUZZ_TEX"),void 0===this.skinParams.version&&(this.skinParams.version=1),2==this.skinParams.version?(s.push("#define SKIN_VERSION_2"),this.skinParams.shadowBlur*=4,this.skinParams.shadowBlur=Math.min(this.skinParams.shadowBlur,40),this.skinParams.transIntegral=r(.5*this.skinParams.transScatter),this.skinParams.fresnelIntegral=1/3.14159*(1-.5*this.skinParams.fresnelColor[3]),this.skinParams.transSky=0):(s.push("#define SKIN_VERSION_1"),this.skinParams.shadowBlur=8*Math.min(this.skinParams.shadowBlur,1),this.skinParams.transDepth=0,this.skinParams.transScatter=this.skinParams.transColor[3],this.skinParams.transIntegral=1/3.14159*(1-.5*this.skinParams.transScatter),this.skinParams.fresnelIntegral=1/3.14159*(1-.5*this.skinParams.fresnelColor[3]),this.skinParams.transSky*=1.25,this.skinParams.transIntegral*=1.25)),i.aniso&&(s.push("#define ANISO"),this.anisoParams=i.anisoParams||{strength:1,tangent:[1,0,0],integral:.5},this.extrasTexCoordRanges.anisoTex||s.push("#define ANISO_NO_DIR_TEX")),i.microfiber&&(s.push("#define MICROFIBER"),this.microfiberParams=i.microfiberParams||{fresnelColor:[.2,.2,.2,.5],fresnelOcc:1,fresnelGlossMask:1},this.microfiberParams.fresnelIntegral=1/3.14159*(1-.5*this.microfiberParams.fresnelColor[3]),this.extrasTexCoordRanges.fuzzTex||s.push("#define MICROFIBER_NO_FUZZ_TEX")),i.refraction&&(s.push("#define REFRACTION"),this.refractionParams=i.refractionParams||{distantBackground:!1,tint:[1,1,1],useAlbedoTint:!1,IOR:1.5},this.extrasTexCoordRanges.refractionMaskTex||s.push("#define REFRACTION_NO_MASK_TEX")),i.vertexColor&&(s.push("#define VERTEX_COLOR"),i.vertexColorsRGB&&s.push("#define VERTEX_COLOR_SRGB"),i.vertexColorAlpha&&s.push("#define VERTEX_COLOR_ALPHA")),this.horizonSmoothing=i.horizonSmoothing||0,0<this.horizonSmoothing&&s.push("#define HORIZON_SMOOTHING"),i.unlitDiffuse&&s.push("#define DIFFUSE_UNLIT"),this.extrasTexCoordRanges.emissiveTex&&(s.push("#define EMISSIVE"),i.emissiveSecondaryUV&&(s.push("#define EMISSIVE_SECONDARY_UV"),n=!0)),this.extrasTexCoordRanges.aoTex&&(s.push("#define AMBIENT_OCCLUSION"),i.aoSecondaryUV&&(s.push("#define AMBIENT_OCCLUSION_SECONDARY_UV"),n=!0)),i.tangentOrthogonalize&&s.push("#define TSPACE_ORTHOGONALIZE"),i.tangentNormalize&&s.push("#define TSPACE_RENORMALIZE"),i.tangentGenerateBitangent&&s.push("#define TSPACE_COMPUTE_BITANGENT"),n&&s.push("#define TEXCOORD_SECONDARY"),this.vOffset=this.uOffset=0,s.push("#define UV_OFFSET "),this.shader=t.shaderCache.fromURLs("matvert.glsl","matfrag.glsl",s),s.push("#define STRIPVIEW"),this.stripShader=t.shaderCache.fromURLs("matvert.glsl","matfrag.glsl",s),this.wireShader=t.shaderCache.fromURLs("wirevert.glsl","wirefrag.glsl"),this.blend===e.alpha&&(this.prepassShader=t.shaderCache.fromURLs("alphaprepassvert.glsl","alphaprepassfrag.glsl"))}p.prototype.addImageElement=function(e,i){var s=this.guiScreen.ui.menuCluster.contents,n=document.createElement("input");e.linkControl(n),this.guiScreen.updateElement(e),n.type="image",n.src=t.dataLocale+i,n.style.position="absolute",n.style.border="none",n.style.outline="0px",n.style.zIndex="1",n.title=i,n.style.opacity=e.opacity;var r=new XMLHttpRequest;return r.open("HEAD",n.src,!0),r.onload=function(t){t.appendChild(this)}.bind(n,s),r.send(),n},p.prototype.addImage=function(t){var e=new d(this.guiScreen);return this.addImageElement(e,t),e},p.prototype.addTextButton=function(e,i,s,n,r,o){var a=new h(this.guiScreen);return a.name="none",a.text=e,a.controlRect.set(i,s,n,r),a.controlRect.opacity=o,this.controlRect.registerChildControlRect(a.controlRect),i=this.guiScreen.ui.menuCluster.contents,(s=document.createElement("text")).style.color="white",s.style.fontFamily="Arial",s.style.fontSize=t.largeUI?"14px":"12px",s.style.textShadow="2px 2px 3px #000000",i.appendChild(s),a.controlRect.linkControl(s),this.guiScreen.updateElement(a.controlRect),s.type="text",s.name="text",s.style.position="absolute",s.style.border="none",s.style.outline="0px",s.style.zIndex="2",s.innerHTML=e,s.style.opacity=a.controlRect.opacity,a.linkControl(s),a},g.prototype.setSize=function(t,e){this.width=t,this.height=e,this.left=-t,this.bottom=-e,this.playbackControls&&this.playbackControls.resize(this)},g.prototype.setupActiveView=function(t){this.init||(this.init=!0,(this.ui=t).viewer.scene.sceneAnimator&&(this.playbackControls=new A(this),this.playbackControls.resize(this)))},g.prototype.updateElement=function(t){var e,i,s,n=t.linkedControl;n&&(e=this.left*(1-t.getScreenXPercent()),i=this.bottom*(1-t.getScreenYPercent()),s=this.width*t.getScreenWidthPercent(),t=this.height*t.getScreenHeightPercent(),n.style.left=e+"px",n.style.bottom=i+"px",n.style.width=s+"px",n.style.height=t+"px")},x.prototype.attach=function(t){this.element=t;var e=function(t){for(var e=0;e<this.onAnything.length;++e)this.onAnything[e]();t.preventDefault()}.bind(this);this.mouseStates=[{pressed:!1,position:[0,0],downPosition:[0,0]},{pressed:!1,position:[0,0],downPosition:[0,0]},{pressed:!1,position:[0,0],downPosition:[0,0]}],this.lastTapPos=[0,0],t=function(t){var i,s;t.target===this.element&&(this.mouseDownCount++,(i=this.mouseStates[t.button])&&(i.pressed=!0,s=this.element.getBoundingClientRect(),i.position[0]=i.downPosition[0]=t.clientX-s.left,i.position[1]=i.downPosition[1]=t.clientY-s.top,e(t)))}.bind(this),this.element.addEventListener("mousedown",t),t=function(t){var i=this.mouseStates[t.button];if(i){var s=this.element.getBoundingClientRect(),n=t.clientX-s.left;s=t.clientY-s.top;if(i.pressed=!1,i.position[0]=n,i.position[1]=s,0==t.button&&t.target==this.element&&Math.abs(i.position[0]-i.downPosition[0])+Math.abs(i.position[1]-i.downPosition[1])<10){for(var r=0;r<this.onTap.length;++r)this.onTap[r](n,s);if(this.needSingleClick=!0,window.setTimeout(function(t,e){if(this.needSingleClick){for(var i=0;i<this.onSingleTap.length;++i)this.onSingleTap[i](t,e);this.needSingleClick=!1}}.bind(this,n,s),301),i=!1,void 0!==this.doubleClickTimer&&(r=Math.abs(n-this.lastTapPos[0])+Math.abs(s-this.lastTapPos[1])<8,Date.now()-this.doubleClickTimer<300&&r))for(i=!0,this.needSingleClick=!1,r=0;r<this.onDoubleTap.length;++r)this.onDoubleTap[r](n,s);this.doubleClickTimer=Date.now(),i&&(this.doubleClickTimer=-1e9),this.lastTapPos[0]=n,this.lastTapPos[1]=s}}e(t)}.bind(this),this.element.addEventListener("mouseup",t),t=function(t){for(var i=!1,s=this.element.getBoundingClientRect(),n=0;n<3;++n){var r=this.mouseStates[n];if(r.pressed){i=t.clientX-s.left;var o=t.clientY-s.top,a=i-r.position[0],h=o-r.position[1];if(r.position[0]=i,r.position[1]=o,2==n&&t.altKey)for(r=0;r<this.onZoom.length;++r)this.onZoom[r](2*h);else if(1<=n||t.ctrlKey)for(r=0;r<this.onPan.length;++r)this.onPan[r](a,h);else if(0==n)if(t.shiftKey)for(r=0;r<this.onPan2.length;++r)this.onPan2[r](a,h);else for(r=0;r<this.onDrag.length;++r)this.onDrag[r](i,o,a,h);i=!0}}i&&e(t)}.bind(this),this.element.addEventListener("mousemove",t),t=function(t){var i=0;t.deltaY?(i=-.4*t.deltaY,1==t.deltaMode?i*=16:2==t.deltaMode&&(i*=this.element.clientHeight)):t.wheelDelta?i=this.macHax&&120==Math.abs(t.wheelDelta)?.08*t.wheelDelta:.4*t.wheelDelta:t.detail&&(i=-10*t.detail);for(var s=0;s<this.onZoom.length;++s)this.onZoom[s](i);e(t)}.bind(this),this.element.addEventListener("mousewheel",t),this.element.addEventListener("DOMMouseScroll",t),this.element.addEventListener("wheel",t),t=function(t){for(var e=0;e<this.mouseStates.length;++e)this.mouseStates[e].pressed=!1;t.preventDefault()}.bind(this),this.element.addEventListener("mouseleave",t),this.element.addEventListener("contextmenu",(function(t){t.preventDefault()})),this.touches={},this.tapPossible=!1,this.touchCountFloor=0,t=function(t){for(var i,s=this.element.getBoundingClientRect(),n=!1,r=0;r<t.changedTouches.length;++r)t.target===this.element&&((n={x:(i=t.changedTouches[r]).clientX-s.left,y:i.clientY-s.top}).startX=n.x,n.startY=n.y,this.touches[i.identifier]=n,n=!0);for(this.tapPossible=1==t.touches.length,i=s=0;i<this.touches.length;++i)s++;s>this.touchCountFloor&&(this.touchCountFloor=s),n&&e(t)}.bind(this),this.element.addEventListener("touchstart",t),t=function(t){for(var i=!1,s=0;s<t.changedTouches.length;++s){var n=t.changedTouches[s],r=this.touches[n.identifier];if(r){if(this.tapPossible){var o=this.element.getBoundingClientRect();i=n.clientX-o.left,o=n.clientY-o.top;if(Math.max(Math.abs(i-r.startX),Math.abs(o-r.startY))<24){for(s=0;s<this.onTap.length;++s)this.onTap[s](i,o);if(this.needSingleTap=!0,window.setTimeout(function(t,e){if(this.needSingleTap){for(var i=0;i<this.onSingleTap.length;++i)this.onSingleTap[i](t,e);this.needSingleTap=!1}}.bind(this,i,o),501),r=!1,void 0!==this.doubleTapTimer){var a=Math.max(Math.abs(i-this.lastTapPos[0]),Math.abs(o-this.lastTapPos[1]))<24,h=Date.now()-this.doubleTapTimer<500;if(a&&h)for(r=!0,s=0;s<this.onDoubleTap.length;++s)this.onDoubleTap[s](i,o)}this.doubleTapTimer=Date.now(),r&&(this.doubleTapTimer=-1e9),this.lastTapPos[0]=i,this.lastTapPos[1]=o}this.tapPossible=!1}delete this.touches[n.identifier],i=!0}}for(n=s=0;n<this.touches.length;++n)s++;s<=0&&(this.touchCountFloor=0),i&&e(t)}.bind(this),this.element.addEventListener("touchend",t),this.element.addEventListener("touchcancel",t),this.element.addEventListener("touchleave",t),t=function(t){for(var i=[],s=0;s<t.touches.length;++s)t.touches[s].target===this.element&&i.push(t.touches[s]);var n=this.element.getBoundingClientRect();if(1==i.length&&this.touchCountFloor<=1){var r=i[0],o=this.touches[r.identifier];if(o){var a=r.clientX-n.left,h=(r=r.clientY-n.top,n=a-o.x,r-o.y);for(o.x=a,o.y=r,s=0;s<this.onDrag.length;++s)this.onDrag[s](a,r,n,h,t.shiftKey)}}else if(2==i.length&&this.touchCountFloor<=2){if(h=i[0],s=this.touches[h.identifier],r=i[1],o=this.touches[r.identifier],s&&o){a=h.clientX-n.left,h=h.clientY-n.top;var l=r.clientX-n.left,d=r.clientY-n.top,c=Math.sqrt((a-l)*(a-l)+(h-d)*(h-d)),u=Math.sqrt((s.x-o.x)*(s.x-o.x)+(s.y-o.y)*(s.y-o.y)),f=Math.abs(c-u),m=(n=(a-s.x+l-o.x)/2,r=(h-s.y+d-o.y)/2,Math.sqrt(n*n+r*r));if(s.x=a,s.y=h,o.x=l,o.y=d,0<f)for(o=f/(f+m),s=0;s<this.onZoom.length;++s)this.onZoom[s](2*(c-u)*o);if(0<m)for(o=m/(f+m),s=0;s<this.onDrag.length;++s)this.onPan[s](n*o,r*o)}}else if(3<=i.length){for(s=u=c=l=h=0;s<i.length;++s)r=i[s],o=this.touches[r.identifier],c+=a=r.clientX-n.left,u+=r=r.clientY-n.top,o&&(h+=o.x,l+=o.y,o.x=a,o.y=r);for(h/=i.length,l/=i.length,c/=i.length,u/=i.length,s=0;s<this.onPan2.length;++s)this.onPan2[s](c-h,u-l)}0<i.length&&e(t)}.bind(this),this.element.addEventListener("touchmove",t)},v.prototype.getLightPos=function(t){return this.positionBuffer.subarray(4*t,4*t+4)},v.prototype.setLightDistance=function(t,e){e<=0&&(e=1e-5),this.parameters[3*t+2]=1/e},v.prototype.setLightSpotAngle=function(t,e){e<=0&&(e=1e-6),this.spot[3*t]=e;var i=Math.sin(3.1415926/180*e/2);this.spot[3*t+2]=1/(i*i)*this.spot[3*t+1]},v.prototype.setLightSpotSharpness=function(t,e){this.spot[3*t+1]=e,this.setLightSpotAngle(this.spot[3*t])},v.prototype.setLightPos=function(t,e){this.positions[4*t+0]=e[0],this.positions[4*t+1]=e[1],this.positions[4*t+2]=e[2];var i=this.positions.subarray(4*t,4*t+4);1==this.matrixWeights[t]?T.mul4(i,this.defaultmatrix,e[0],e[1],e[2],i[3]):2==this.matrixWeights[t]&&T.mul4(i,this.defaultviewmatrix,e[0],e[1],e[2],i[3])},v.prototype.setLightDir=function(t,e){this.directions[3*t+0]=e[0],this.directions[3*t+1]=e[1],this.directions[3*t+2]=e[2];var i=this.directions.subarray(3*t,3*t+3);1==this.matrixWeights[t]?T.mulVec(i,this.defaultmatrix,e[0],e[1],e[2]):2==this.matrixWeights[t]&&T.mulVec(i,this.defaultviewmatrix,e[0],e[1],e[2])},v.prototype.getLightColor=function(t){return this.colors.subarray(3*t,3*t+3)},v.prototype.setLightColor=function(t,e){this.colors[3*t+0]=e[0],this.colors[3*t+1]=e[1],this.colors[3*t+2]=e[2]},v.prototype.getLightDir=function(t){return this.directionBuffer.subarray(3*t,3*t+3)},v.prototype.getColor=function(t){return t*=3,[this.colors[t],this.colors[t+1],this.colors[t+2]]},v.prototype.update=function(t,e){var i=new T.type(this.matrix);T.rotation(this.matrix,this.rotation,1),T.transpose(this.invMatrix,this.matrix);for(var s=0;s<this.count;++s){var n=this.positions.subarray(4*s,4*s+4),r=this.directions.subarray(3*s,3*s+3),o=this.getLightPos(s),a=this.getLightDir(s);1==this.matrixWeights[s]?(o[0]=n[0],o[1]=n[1],o[2]=n[2],o[3]=n[3],a[0]=r[0],a[1]=r[1],a[2]=r[2]):2==this.matrixWeights[s]?(T.mul4(o,t.transform,n[0],n[1],n[2],n[3]),T.mulVec(a,t.transform,r[0],r[1],r[2]),T.mul4(o,this.matrix,o[0],o[1],o[2],o[3]),T.mulVec(a,this.matrix,a[0],a[1],a[2])):(T.mul4(o,this.matrix,n[0],n[1],n[2],n[3]),T.mulVec(a,this.matrix,r[0],r[1],r[2])),V.normalize(a,a)}r=new Float32Array(this.finalTransformBuffer),o=T.empty(),a=T.empty();var h=T.empty(),l=V.empty(),d=V.empty(),c=V.empty(),u=V.empty(),f=(n=V.empty(),[]),m=[],p=T.create(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1);for(s=0;s<this.count;++s){for(l=this.getLightPos(s),d=this.getLightDir(s),.99<Math.abs(d[1])?V.set(c,1,0,0):V.set(c,0,1,0),V.cross(u,c,d),V.normalize(u,u),V.cross(c,d,u),V.normalize(c,c),T.set(o,u[0],u[1],u[2],-V.dot(u,l),c[0],c[1],c[2],-V.dot(c,l),d[0],d[1],d[2],-V.dot(d,l),0,0,0,1),l=0;l<8;++l)n[0]=1&l?e.max[0]:e.min[0],n[1]=2&l?e.max[1]:e.min[1],n[2]=4&l?e.max[2]:e.min[2],T.mulPoint(n,this.matrix,1.005*n[0],1.005*n[1],1.005*n[2]),T.mulPoint(n,o,n[0],n[1],n[2]),0==l?(f[0]=m[0]=n[0],f[1]=m[1]=n[1],f[2]=m[2]=n[2]):(f[0]=Math.min(f[0],n[0]),f[1]=Math.min(f[1],n[1]),f[2]=Math.min(f[2],n[2]),m[0]=Math.max(m[0],n[0]),m[1]=Math.max(m[1],n[1]),m[2]=Math.max(m[2],n[2]));l=-f[2],d=-m[2];var g=this.spot[3*s];0<g?(l=Math.min(l,1/this.parameters[3*s+2]),d=Math.max(.04*l,d),T.perspective(a,g,1,d,l),s<this.shadowCount&&(l=2*-Math.tan(.00872664625*g),this.shadowTexelPadProjections[4*s+0]=this.modelViewBuffer[16*s+2]*l,this.shadowTexelPadProjections[4*s+1]=this.modelViewBuffer[16*s+6]*l,this.shadowTexelPadProjections[4*s+2]=this.modelViewBuffer[16*s+10]*l,this.shadowTexelPadProjections[4*s+3]=this.modelViewBuffer[16*s+14]*l)):(T.ortho(a,f[0],m[0],f[1],m[1],d,l),s<this.shadowCount&&(this.shadowTexelPadProjections[4*s+0]=this.shadowTexelPadProjections[4*s+1]=this.shadowTexelPadProjections[4*s+2]=0,this.shadowTexelPadProjections[4*s+3]=Math.max(m[0]-f[0],m[1]-f[1]))),T.mul(h,a,o),T.mul(h,p,h),T.copyToBuffer(this.modelViewBuffer,16*s,o),T.copyToBuffer(this.projectionBuffer,16*s,a),T.copyToBuffer(this.finalTransformBuffer,16*s,h),T.invert(h,h),T.copyToBuffer(this.inverseTransformBuffer,16*s,h)}for(n=!1,s=0;s<i.length;++s)if(i[s]!=this.matrix[s]){n=!0;break}for(s=0;s<this.shadowCount;s++)if(n&&1==this.matrixWeights[s])this.shadowsNeedUpdate[s]=1;else for(i=16*s;i<16*s+16;++i)if(r[i]!=this.finalTransformBuffer[i]){this.shadowsNeedUpdate[s]=1;break}},v.prototype.flagUpdateAnimatedLighting=function(){for(var t=0;t<this.shadowCount;t++)this.shadowsNeedUpdate[t]=1},b.prototype.linkControl=function(t){this.controlRect.linkControl(t)},b.prototype.spawnControl=function(e,i,s,n,r,o){var a="backgroundTopLE"+(w=this.guiScreen.imageSetNumber)+"x.png",h="backgroundTopM"+w+"x.png",l="backgroundTopRE"+w+"x.png",d="backgroundMiddleLE"+w+"x.png",c="backgroundMiddleM"+w+"x.png",u="backgroundMiddleRE"+w+"x.png",f="backgroundBottomLE"+w+"x.png",m="backgroundBottomM"+w+"x.png",p="backgroundBottomRE"+w+"x.png",g=3*w,x="backgroundLE"+w+"x.png",y="backgroundM"+w+"x.png",v="backgroundRE"+w+"x.png",b=2*w,S="spacerLE"+w+"x.png",T="spacerM"+w+"x.png",C="spacerRE"+w+"x.png",w=2*w,R=this.controlRect.guiScreen.width,A=this.controlRect.guiScreen.height;if(r){r=this.textEntries.length;var k=s;for(s=0;s<r;s++){var F=8*(this.textEntries[s]?this.textEntries[s].length:0);k<F&&(k=F)}s=k+o}for(o=1/(r=this.textEntries.length+1),this.localPixelsX=s,this.listBoxEntryHeight=n,this.localPixelsY=(this.textEntries.length+1)*this.listBoxEntryHeight,s=8/this.localPixelsY,n=6/this.localPixelsX,k=4/this.localPixelsX,F=o-s/4,this.labelTextHeight=t.largeUI?20:16,this.labelPixelDrop=(this.listBoxEntryHeight-this.labelTextHeight)/2,this.listBoxRegion.controlRect.widthPercent=this.localPixelsX/R,this.listBoxRegion.controlRect.heightPercent=this.localPixelsY/A,this.listBoxRegion.controlRect.xPercent=e/R,this.listBoxRegion.controlRect.yPercent=i/A,this.openBackground=this.listBoxRegion.addTextButton("",0,0,1,1+s,1),this.openBackground.setBackground3x3(this.listBoxRegion,0,0,a,h,l,d,c,u,f,m,p,g,g),this.closedBackground=this.listBoxRegion.addTextButton("",0,0,1,o,1),this.closedBackground.setBackground3x1(this.listBoxRegion,0,0,x,y,v,b),e=this.labelPixelInset+this.textOffsetsX[0],i=this.labelPixelDrop+this.textOffsetsY[0],i/=this.localPixelsY,e/=this.localPixelsX,this.defaultButton=this.listBoxRegion.addTextButton("Selected",e,-i,1,o,.5),this.selectedIndex=0,this.defaultButton.controlRect.linkedControl.innerHTML=this.textEntries[this.selectedIndex],this.defaultButton.linkedBackground=this.closedBackground,this.spacerControl=this.listBoxRegion.addTextButton("",n,F,1-(n+k),s,1),this.spacerControl.defaultAlpha=1,this.spacerControl.setBackground3x1(this.listBoxRegion,0,0,S,T,C,w),this.spacerControl.setVisible(!1),this.spacerControl.linkedBackground=this.openBackground,s=1;s<r;s++)e=this.labelPixelInset+this.textOffsetsX[s-1],i=this.labelPixelDrop+this.textOffsetsY[s-1]-4,e/=this.localPixelsX,i/=this.localPixelsY,S=this.listBoxRegion.addTextButton(this.textEntries[s-1],e,o*s-i,1-e,o,.5),this.listBoxButtons.push(S),S.linkedBackground=this.openBackground;this.showList(!1),this.setupCallbacks()},b.prototype.setControl=function(t,e,i,s,n,r){var o=this.controlRect.guiScreen.width,a=this.controlRect.guiScreen.height;if(n){n=this.textEntries.length;for(var h=0;h<n;h++){var l=8*(this.textEntries[h]?this.textEntries[h].length:0);i<l&&(i=l)}i+=r}this.localPixelsX=i,this.listBoxEntryHeight=s,this.localPixelsY=(this.textEntries.length+1)*this.listBoxEntryHeight,this.listBoxRegion.controlRect.widthPercent=this.localPixelsX/o,this.listBoxRegion.controlRect.heightPercent=this.localPixelsY/a,this.listBoxRegion.controlRect.xPercent=t/o,this.listBoxRegion.controlRect.yPercent=e/a,this.listBoxRegion.controlRect.updateChildElements(),this.spacerControl.alignBackground(),this.openBackground.alignBackground(),this.closedBackground.alignBackground()},b.prototype.addItem=function(t,e,i){this.textEntries.push(t),this.textOffsetsX.push(e),this.textOffsetsY.push(i)},b.prototype.showList=function(t){for(var e=this.listBoxButtons.length,i=0;i<e;i++)this.listBoxButtons[i].setVisible(t);this.closed=!t,this.spacerControl&&this.spacerControl.setVisible(t),this.openBackground&&this.openBackground.setVisible(t),this.closedBackground&&this.closedBackground.setVisible(!t),t?(this.defaultButton.linkedBackground=this.openBackground,this.openBackground.setOpacity(1),this.closedBackground.setOpacity(.5)):this.defaultButton.linkedBackground=this.closedBackground},b.prototype.selectItem=function(t){this.selectedItemText=this.textEntries[t],this.selectedIndex=t,this.defaultButton.controlRect.linkedControl.innerHTML=this.textEntries[this.selectedIndex],t=(this.labelTextHeight-this.listBoxEntryHeight+3)/this.localPixelsY,this.defaultButton.controlRect.xPercent=(this.labelPixelInset+this.textOffsetsX[this.selectedIndex])/this.localPixelsX,this.defaultButton.controlRect.yPercent=t,this.defaultButton.controlRect.updateElement()},b.prototype.setupCallbacks=function(){var t=function(t){var e,i;this.closed?(e=(e=this.closedBackground.controlRect.linkedControl).getBoundingClientRect(),i=t.clientX-e.left,t=t.clientY-e.top,i/=e.width,e=t/e.height,0<=i&&i<=1&&0<=e&&e<=1?this.closedBackground.setOpacity(1):this.closedBackground.setOpacity(.5)):(e=(e=this.openBackground.controlRect.linkedControl).getBoundingClientRect(),i=t.clientX-e.left,t=t.clientY-e.top,i/=e.width,e=t/e.height,0<=i&&i<=1&&0<=e&&e<=1?this.openBackground.setOpacity(1):this.openBackground.setOpacity(.5))}.bind(this);this.defaultButton.controlRect.linkedControl.onclick=function(){this.closed?this.showList(!0):(this.showList(this.closed),this.closedBackground.setOpacity(1),this.defaultButton.setOpacity(1))}.bind(this);for(var e=function(t){this.selectItem(t.id),this.showList(!1),this.defaultButton.setOpacity(.5),this.selectionChangedCallback&&this.selectionChangedCallback(this)}.bind(this),i=function(t){t=this.listBoxButtons.length;for(var e=0;e<t;e++)this.listBoxButtons[e].controlRect.mouseOver&&(this.selectItem(e),e=t,this.selectionChangedCallback&&this.selectionChangedCallback(this));this.showList(!1)}.bind(this),s=this.listBoxButtons.length,n=0;n<s;n++)this.listBoxButtons[n].controlRect.callBack=e,this.listBoxButtons[n].controlRect.id=n,this.listBoxButtons[n].controlRect.linkedControl.addEventListener("mousemove",t);this.guiScreen.ui.viewer.input.element.addEventListener("mousemove",t),this.openBackground.controlRect.linkedControl.addEventListener("mousemove",t),this.closedBackground.controlRect.linkedControl.addEventListener("mousemove",t),this.guiScreen.ui.viewer.input.element.addEventListener("mousedown",i)},S.prototype.bind=function(t,e){if(!this.complete())return!1;var i,s=t.view,n=t.lights,r=t.sky,o=t.shadow,a=t.stripData.active()?this.stripShader:this.shader,h=this.skinParams,l=this.anisoParams,d=this.microfiberParams,c=this.gl,u=a.params,f=this.textures,m=a.samplers;a.bind(),this.blend();var p=e.mesh.displayMatrix,g=T.mul(T.empty(),s.viewMatrix,p),x=T.mul(T.empty(),s.projectionMatrix,s.viewMatrix);g=T.mul(T.empty(),s.projectionMatrix,g),p=T.mul(T.empty(),n.matrix,p);return c.uniformMatrix4fv(u.uModelViewProjectionMatrix,!1,g),c.uniformMatrix4fv(u.uSkyMatrix,!1,p),p=T.mulPoint(V.empty(),n.matrix,s.transform[12],s.transform[13],s.transform[14]),c.uniform3f(u.uCameraPosition,p[0],p[1],p[2]),c.uniform3fv(u.uFresnel,this.fresnel),c.uniform1f(u.uAlphaTest,this.alphaTest),c.uniform1f(u.uHorizonOcclude,this.horizonOcclude),c.uniform1f(u.uHorizonSmoothing,this.horizonSmoothing),c.uniform4fv(u.uDiffuseCoefficients,r.diffuseCoefficients),0<n.count&&(c.uniform4fv(u.uLightPositions,n.positionBuffer),c.uniform3fv(u.uLightDirections,n.directionBuffer),c.uniform3fv(u.uLightColors,n.colors),c.uniform3fv(u.uLightParams,n.parameters),c.uniform3fv(u.uLightSpot,n.spot),p=.392699*t.postRender.currentSample(),c.uniform2f(u.uShadowKernelRotation,.5*Math.cos(p),.5*Math.sin(p)),0<n.shadowCount&&(p=o.depthTextures[0].desc.width,c.uniform2f(u.uShadowMapSize,p,1/p),c.uniformMatrix4fv(u.uShadowMatrices,!1,n.finalTransformBuffer),c.uniformMatrix4fv(u.uInvShadowMatrices,!1,n.inverseTransformBuffer),c.uniform4fv(u.uShadowTexelPadProjections,n.shadowTexelPadProjections),o.bindDepthTexture(m.tDepth0,0),o.bindDepthTexture(m.tDepth1,1),o.bindDepthTexture(m.tDepth2,2))),h&&(c.uniform3fv(u.uSubdermisColor,h.subdermisColor),c.uniform4fv(u.uTransColor,h.transColor),c.uniform1f(u.uTransScatter,h.transScatter),c.uniform4fv(u.uFresnelColor,h.fresnelColor),c.uniform1f(u.uFresnelOcc,h.fresnelOcc),c.uniform1f(u.uFresnelGlossMask,h.fresnelGlossMask),c.uniform1f(u.uFresnelIntegral,h.fresnelIntegral),c.uniform1f(u.uTransIntegral,h.transIntegral),c.uniform1f(u.uSkinTransDepth,h.transDepth),c.uniform1f(u.uTransSky,h.transSky),c.uniform1f(u.uSkinShadowBlur,h.shadowBlur),c.uniform1f(u.uNormalSmooth,h.normalSmooth),(i=this.extrasTexCoordRanges.subdermisTex)&&c.uniform4fv(u.uTexRangeSubdermis,i),(i=this.extrasTexCoordRanges.translucencyTex)&&c.uniform4fv(u.uTexRangeTranslucency,i),(i=this.extrasTexCoordRanges.fuzzTex)&&c.uniform4fv(u.uTexRangeFuzz,i)),d&&(c.uniform4fv(u.uFresnelColor,d.fresnelColor),c.uniform1f(u.uFresnelOcc,d.fresnelOcc),c.uniform1f(u.uFresnelGlossMask,d.fresnelGlossMask),c.uniform1f(u.uFresnelIntegral,d.fresnelIntegral),(i=this.extrasTexCoordRanges.fuzzTex)&&c.uniform4fv(u.uTexRangeFuzz,i)),l&&(c.uniform3fv(u.uAnisoTangent,l.tangent),c.uniform1f(u.uAnisoStrength,l.strength),c.uniform1f(u.uAnisoIntegral,l.integral),(i=this.extrasTexCoordRanges.anisoTex)&&c.uniform4fv(u.uTexRangeAniso,i)),this.usesRefraction&&(t.refractionSurface&&t.refractionSurface.bind(m.tRefraction),n=T.mul(T.empty(),x,n.invMatrix),c.uniformMatrix4fv(u.uRefractionViewProjection,!1,n),c.uniform1f(u.uRefractionRayDistance,this.refractionParams.distantBackground?1e10:4*e.mesh.bounds.maxExtent),c.uniform3fv(u.uRefractionTint,this.refractionParams.tint),c.uniform1f(u.uRefractionAlbedoTint,this.refractionParams.useAlbedoTint?1:0),c.uniform1f(u.uRefractionIOREntry,1/this.refractionParams.IOR),(i=this.extrasTexCoordRanges.refractionMaskTex)&&c.uniform4fv(u.uTexRangeRefraction,i)),(i=this.extrasTexCoordRanges.emissiveTex)&&(c.uniform4fv(u.uTexRangeEmissive,i),c.uniform1f(u.uEmissiveScale,this.emissiveIntensity)),(i=this.extrasTexCoordRanges.aoTex)&&c.uniform4fv(u.uTexRangeAO,i),f.albedo.bind(m.tAlbedo),f.reflectivity.bind(m.tReflectivity),f.normal.bind(m.tNormal),f.extras.bind(m.tExtras),r.specularTexture.bind(m.tSkySpecular),a===this.stripShader&&(c.uniform1fv(u.uStrips,t.stripData.strips),c.uniform2f(u.uStripRes,2/s.size[0],2/s.size[1])),c.uniform2f(u.uUVOffset,this.uOffset,this.vOffset),!0},S.prototype.bindAlphaPrepass=function(t,e){if(!this.complete()||!this.prepassShader)return!1;var i=this.gl,s=this.prepassShader.params,n=this.prepassShader.samplers;this.prepassShader.bind();var r=T.mul(T.empty(),t.view.viewMatrix,e.mesh.displayMatrix);r=T.mul(T.empty(),t.view.projectionMatrix,r);return i.uniformMatrix4fv(s.uModelViewProjectionMatrix,!1,r),i.uniform2f(s.uUVOffset,this.uOffset,this.vOffset),this.textures.albedo.bind(n.tAlbedo),!0},S.prototype.bindWire=function(t,e){if(!this.complete())return!1;var i=this.gl,s=this.wireShader.params,n=t.view;i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.depthMask(!1),this.wireShader.bind();var r=T.mul(T.empty(),t.view.viewMatrix,e.mesh.displayMatrix);r=T.mul(T.empty(),t.view.projectionMatrix,r);return i.uniformMatrix4fv(s.uModelViewProjectionMatrix,!1,r),i.uniform4f(s.uStripParams,2/n.size[0],2/n.size[1],t.stripData.strips[3],t.stripData.strips[4]),!0},S.prototype.complete=function(){return this.wireShader.complete()&&this.shader.complete()&&this.stripShader.complete()&&(!this.prepassShader||this.prepassShader.complete())&&(!this.refractionShader||this.refractionShader.complete())&&this.textures.albedo.complete()&&this.textures.reflectivity.complete()&&this.textures.normal.complete()};var T={type:Float32Array,create:function(t,e,i,s,n,r,o,a,h,l,d,c,u,f,m,p){var g=new T.type(16);return g[0]=t,g[4]=e,g[8]=i,g[12]=s,g[1]=n,g[5]=r,g[9]=o,g[13]=a,g[2]=h,g[6]=l,g[10]=d,g[14]=c,g[3]=u,g[7]=f,g[11]=m,g[15]=p,g},empty:function(){return new T.type(16)},identity:function(){var t=new T.type(16);return t[0]=1,t[4]=0,t[8]=0,t[12]=0,t[1]=0,t[5]=1,t[9]=0,t[13]=0,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1,t},set:function(t,e,i,s,n,r,o,a,h,l,d,c,u,f,m,p,g){t[0]=e,t[4]=i,t[8]=s,t[12]=n,t[1]=r,t[5]=o,t[9]=a,t[13]=h,t[2]=l,t[6]=d,t[10]=c,t[14]=u,t[3]=f,t[7]=m,t[11]=p,t[15]=g},translation:function(t,e,i,s){return T.set(t,1,0,0,e,0,1,0,i,0,0,1,s,0,0,0,1),t},rotation:function(t,e,i){t[0]=1,t[4]=0,t[8]=0,t[12]=0,t[1]=0,t[5]=1,t[9]=0,t[13]=0,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1;var s=.0174532925*e;switch(e=Math.sin(s),s=Math.cos(s),i){case 0:t[5]=s,t[9]=-e,t[6]=e,t[10]=s;break;case 1:t[0]=s,t[8]=e,t[2]=-e,t[10]=s;break;case 2:t[0]=s,t[4]=-e,t[1]=e,t[5]=s}return t},mul:function(t,e,i){var s=e[0],n=e[1],r=e[2],o=e[3],a=e[4],h=e[5],l=e[6],d=e[7],c=e[8],u=e[9],f=e[10],m=e[11],p=e[12],g=e[13],x=e[14];e=e[15];var y=i[0],v=i[1],b=i[2],S=i[3];return t[0]=y*s+v*a+b*c+S*p,t[1]=y*n+v*h+b*u+S*g,t[2]=y*r+v*l+b*f+S*x,t[3]=y*o+v*d+b*m+S*e,y=i[4],v=i[5],b=i[6],S=i[7],t[4]=y*s+v*a+b*c+S*p,t[5]=y*n+v*h+b*u+S*g,t[6]=y*r+v*l+b*f+S*x,t[7]=y*o+v*d+b*m+S*e,y=i[8],v=i[9],b=i[10],S=i[11],t[8]=y*s+v*a+b*c+S*p,t[9]=y*n+v*h+b*u+S*g,t[10]=y*r+v*l+b*f+S*x,t[11]=y*o+v*d+b*m+S*e,y=i[12],v=i[13],b=i[14],S=i[15],t[12]=y*s+v*a+b*c+S*p,t[13]=y*n+v*h+b*u+S*g,t[14]=y*r+v*l+b*f+S*x,t[15]=y*o+v*d+b*m+S*e,t},invert:function(t,e){var i=e[0],s=e[1],n=e[2],r=e[3],o=e[4],a=e[5],h=e[6],l=e[7],d=e[8],c=e[9],u=e[10],f=e[11],m=e[12],p=e[13],g=e[14],x=e[15],y=i*a-s*o,v=i*h-n*o,b=i*l-r*o,S=s*h-n*a,T=s*l-r*a,C=n*l-r*h,w=d*p-c*m,R=d*g-u*m,A=d*x-f*m,k=c*g-u*p,F=c*x-f*p,P=u*x-f*g,I=y*P-v*F+b*k+S*A-T*R+C*w;return I?(I=1/I,t[0]=(a*P-h*F+l*k)*I,t[1]=(n*F-s*P-r*k)*I,t[2]=(p*C-g*T+x*S)*I,t[3]=(u*T-c*C-f*S)*I,t[4]=(h*A-o*P-l*R)*I,t[5]=(i*P-n*A+r*R)*I,t[6]=(g*b-m*C-x*v)*I,t[7]=(d*C-u*b+f*v)*I,t[8]=(o*F-a*A+l*w)*I,t[9]=(s*A-i*F-r*w)*I,t[10]=(m*T-p*b+x*y)*I,t[11]=(c*b-d*T-f*y)*I,t[12]=(a*R-o*k-h*w)*I,t[13]=(i*k-s*R+n*w)*I,t[14]=(p*v-m*S-g*y)*I,t[15]=(d*S-c*v+u*y)*I,t):null},transpose:function(t,e){return t[0]=e[0],t[4]=e[1],t[8]=e[2],t[12]=e[3],t[1]=e[4],t[5]=e[5],t[9]=e[6],t[13]=e[7],t[2]=e[8],t[6]=e[9],t[10]=e[10],t[14]=e[11],t[3]=e[12],t[7]=e[13],t[11]=e[14],t[15]=e[15],t},mul4:function(t,e,i,s,n,r){return t[0]=e[0]*i+e[4]*s+e[8]*n+e[12]*r,t[1]=e[1]*i+e[5]*s+e[9]*n+e[13]*r,t[2]=e[2]*i+e[6]*s+e[10]*n+e[14]*r,t[3]=e[3]*i+e[7]*s+e[11]*n+e[15]*r,t},mulPoint:function(t,e,i,s,n){return t[0]=e[0]*i+e[4]*s+e[8]*n+e[12],t[1]=e[1]*i+e[5]*s+e[9]*n+e[13],t[2]=e[2]*i+e[6]*s+e[10]*n+e[14],t},mulVec:function(t,e,i,s,n){return t[0]=e[0]*i+e[4]*s+e[8]*n,t[1]=e[1]*i+e[5]*s+e[9]*n,t[2]=e[2]*i+e[6]*s+e[10]*n,t},perspective:function(t,e,i,s,n,r){return r=r||0,e=1/Math.tan(.00872664625*e),t[0]=e/i,t[1]=t[2]=t[3]=0,t[5]=e,t[4]=t[6]=t[7]=0,t[8]=t[9]=0,t[10]=(n+s)/(s-n)-30518044e-12*r,t[11]=-1,t[14]=2*n*s/(s-n),t[12]=t[13]=t[15]=0,t},perspectiveInfinite:function(t,e,i,s,n){return n=n||0,e=1/Math.tan(.00872664625*e),t[0]=e/i,t[1]=t[2]=t[3]=0,t[5]=e,t[4]=t[6]=t[7]=0,t[8]=t[9]=0,t[10]=t[11]=-1-30518044e-12*n,t[14]=-2*s,t[12]=t[13]=t[15]=0,t},ortho:function(t,e,i,s,n,r,o,a){var h=1/(i-e),l=1/(n-s),d=1/(o-r);return t[0]=h+h,t[1]=t[2]=t[3]=0,t[5]=l+l,t[4]=t[6]=t[7]=0,t[12]=-(i+e)*h,t[13]=-(n+s)*l,t[10]=-(d+d)-30518044e-12*(a||0),t[14]=-(o+r)*d,t[8]=t[9]=t[11]=0,t[15]=1,t},lookAt:function(t,e,i,s){var n=t.subarray(0,3),r=t.subarray(4,7),o=t.subarray(8,11);V.sub(o,e,i),V.cross(n,s,o),V.normalize(o,o),V.normalize(n,n),V.cross(r,o,n),T.set(t,n[0],n[1],n[2],-V.dot(n,e),r[0],r[1],r[2],-V.dot(r,e),o[0],o[1],o[2],-V.dot(o,e),0,0,0,1)},copy:function(t,e){for(var i=0;i<16;++i)t[i]=e[i]},copyToBuffer:function(t,e,i){for(var s=0;s<16;++s)t[e+s]=i[s]}};function C(t,e,i){this.gl=t;var s=(this.desc=e).isDynamicMesh;this.numSubMeshes=this.dynamicVertexData=0,this.displayMatrix=T.identity(),this.name=e.name,this.modelMatrix=T.identity(),this.origin=e.transform?V.create(e.transform[12],e.transform[13],e.transform[14],1):V.create(0,5,0,1),this.stride=32,(this.vertexColor=e.vertexColor)&&(this.stride+=4),(this.secondaryTexCoord=e.secondaryTexCoord)&&(this.stride+=8),i=new l(i.data),this.indexCount=e.indexCount,this.indexTypeSize=e.indexTypeSize,this.indexType=4==this.indexTypeSize?t.UNSIGNED_INT:t.UNSIGNED_SHORT,this.indexBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer);var n=i.readBytes(this.indexCount*this.indexTypeSize);t.bufferData(t.ELEMENT_ARRAY_BUFFER,n,t.STATIC_DRAW),this.wireCount=e.wireCount,this.wireBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.wireBuffer),n=i.readBytes(this.wireCount*this.indexTypeSize),t.bufferData(t.ELEMENT_ARRAY_BUFFER,n,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.vertexCount=e.vertexCount,this.vertexBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),i=i.readBytes(this.vertexCount*this.stride),s?(this.dynamicVertexData=new Uint8Array(i),t.bufferData(t.ARRAY_BUFFER,i,t.DYNAMIC_DRAW)):t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.bounds=void 0===e.minBound||void 0===e.maxBound?{min:V.create(-10,-10,-10,1),max:V.create(10,10,-0,1)}:{min:V.create(e.minBound[0],e.minBound[1],e.minBound[2],1),max:V.create(e.maxBound[0],e.maxBound[1],e.maxBound[2],1)},this.bounds.maxExtent=Math.max(Math.max(e.maxBound[0]-e.minBound[0],e.maxBound[1]-e.minBound[1]),e.maxBound[2]-e.minBound[2]),this.bounds.averageExtent=(e.maxBound[0]-e.minBound[0]+(e.maxBound[1]-e.minBound[1])+(e.maxBound[2]-e.minBound[2]))/3}function w(t,e,i){this.mesh=t,this.gl=this.mesh.gl,this.indexOffset=e.firstIndex*t.indexTypeSize,this.indexCount=e.indexCount,this.wireIndexOffset=e.firstWireIndex*t.indexTypeSize,this.wireIndexCount=e.wireIndexCount,this.material=i,this.visible=!0}w.prototype.draw=function(t){var e,i,s,n,r=this.gl;this.material.bind(t,this)&&(t=this.material.shader.attribs,e=this.mesh.stride,this.mesh.desc.cullBackFaces?(r.enable(r.CULL_FACE),r.cullFace(r.BACK)):r.disable(r.CULL_FACE),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.mesh.indexBuffer),r.bindBuffer(r.ARRAY_BUFFER,this.mesh.vertexBuffer),r.enableVertexAttribArray(t.vPosition),r.enableVertexAttribArray(t.vTexCoord),r.enableVertexAttribArray(t.vTangent),r.enableVertexAttribArray(t.vBitangent),r.enableVertexAttribArray(t.vNormal),(i=this.mesh.vertexColor&&void 0!==t.vColor)&&r.enableVertexAttribArray(t.vColor),(s=this.mesh.secondaryTexCoord&&void 0!==t.vTexCoord2)&&r.enableVertexAttribArray(t.vTexCoord2),n=0,r.vertexAttribPointer(t.vPosition,3,r.FLOAT,!1,e,n),n+=12,r.vertexAttribPointer(t.vTexCoord,2,r.FLOAT,!1,e,n),n+=8,this.mesh.secondaryTexCoord&&(s&&r.vertexAttribPointer(t.vTexCoord2,2,r.FLOAT,!1,e,n),n+=8),r.vertexAttribPointer(t.vTangent,2,r.UNSIGNED_SHORT,!0,e,n),n+=4,r.vertexAttribPointer(t.vBitangent,2,r.UNSIGNED_SHORT,!0,e,n),n+=4,r.vertexAttribPointer(t.vNormal,2,r.UNSIGNED_SHORT,!0,e,n),i&&r.vertexAttribPointer(t.vColor,4,r.UNSIGNED_BYTE,!0,e,n+4),r.drawElements(r.TRIANGLES,this.indexCount,this.mesh.indexType,this.indexOffset),r.disableVertexAttribArray(t.vPosition),r.disableVertexAttribArray(t.vTexCoord),r.disableVertexAttribArray(t.vTangent),r.disableVertexAttribArray(t.vBitangent),r.disableVertexAttribArray(t.vNormal),i&&r.disableVertexAttribArray(t.vColor),s&&r.disableVertexAttribArray(t.vTexCoord2))},w.prototype.drawShadow=function(t){var e=this.gl;this.mesh.desc.cullBackFaces?(e.enable(e.CULL_FACE),e.cullFace(e.BACK)):e.disable(e.CULL_FACE),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.mesh.indexBuffer),e.bindBuffer(e.ARRAY_BUFFER,this.mesh.vertexBuffer),e.enableVertexAttribArray(t),e.vertexAttribPointer(t,3,e.FLOAT,!1,this.mesh.stride,0),e.drawElements(e.TRIANGLES,this.indexCount,this.mesh.indexType,this.indexOffset),e.disableVertexAttribArray(t)},w.prototype.drawAlphaShadow=function(t,e){var i=this.gl;this.mesh.desc.cullBackFaces?(i.enable(i.CULL_FACE),i.cullFace(i.BACK)):i.disable(i.CULL_FACE),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.mesh.indexBuffer),i.bindBuffer(i.ARRAY_BUFFER,this.mesh.vertexBuffer),i.enableVertexAttribArray(t),i.enableVertexAttribArray(e),i.vertexAttribPointer(t,3,i.FLOAT,!1,this.mesh.stride,0),i.vertexAttribPointer(e,2,i.FLOAT,!1,this.mesh.stride,12),i.drawElements(i.TRIANGLES,this.indexCount,this.mesh.indexType,this.indexOffset),i.disableVertexAttribArray(t),i.disableVertexAttribArray(e)},w.prototype.drawAlphaPrepass=function(t){var e,i=this.gl;this.material.bindAlphaPrepass(t,this)&&(t=this.material.prepassShader.attribs,e=this.mesh.stride,this.mesh.desc.cullBackFaces?(i.enable(i.CULL_FACE),i.cullFace(i.BACK)):i.disable(i.CULL_FACE),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.mesh.indexBuffer),i.bindBuffer(i.ARRAY_BUFFER,this.mesh.vertexBuffer),i.enableVertexAttribArray(t.vPosition),i.enableVertexAttribArray(t.vTexCoord),i.vertexAttribPointer(t.vPosition,3,i.FLOAT,!1,e,0),i.vertexAttribPointer(t.vTexCoord,2,i.FLOAT,!1,e,12),i.drawElements(i.TRIANGLES,this.indexCount,this.mesh.indexType,this.indexOffset),i.disableVertexAttribArray(t.vPosition),i.disableVertexAttribArray(t.vTexCoord))},w.prototype.drawWire=function(t){var e=this.material.wireShader.attribs,i=this.gl;this.material.bindWire(t,this)&&(i.enableVertexAttribArray(e.vPosition),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.mesh.wireBuffer),i.bindBuffer(i.ARRAY_BUFFER,this.mesh.vertexBuffer),i.vertexAttribPointer(e.vPosition,3,i.FLOAT,!1,this.mesh.stride,0),i.drawElements(i.LINES,this.wireIndexCount,this.mesh.indexType,this.wireIndexOffset),i.disableVertexAttribArray(e.vPosition))},w.prototype.complete=function(){return this.material.complete()};var R={fetchImage:function(t,e,i){var s=new Image;s.crossOrigin="Anonymous",s.onload=function(){0<s.width&&0<s.height?e(s):i&&i()},i&&(req.onerror=function(){i()}),s.src=t},fetchText:function(t,e,i,s){var n=new XMLHttpRequest;n.open("GET",t,!0),n.onload=function(){200==n.status?e(n.responseText):i&&i()},i&&(n.onerror=function(){i()}),s&&(n.onprogress=function(t){s(t.loaded,t.total)}),n.send()},fetchBinary:function(t,e,i,s){var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=function(){200==n.status?e(n.response):i&&i()},i&&(n.onerror=function(){i()}),s&&(n.onprogress=function(t){s(t.loaded,t.total)}),n.send()},fetchBinaryIncremental:function(t,e,i,s){var n=new XMLHttpRequest;n.open("HEAD",t,!0),n.onload=function(){var r,o,a;200==n.status&&(r=n.getResponseHeader("Accept-Ranges"))&&"none"!=r?(o=0|n.getResponseHeader("Content-Length"),(a=function(i,n){var r=new XMLHttpRequest;r.open("GET",t,!0),r.setRequestHeader("Range","bytes="+i+"-"+n),r.responseType="arraybuffer",r.onload=function(){(206==r.status||200==r.status)&&e(r.response)&&n<o&&a(i+=s,n=(n+=s)<o-1?n:o-1)},r.send()})(0,s-1)):i&&i()},i&&(n.onerror=function(){i()}),n.send()}};function A(t){this.debugString="",this.init=!1,this.speedList=this.cameraList=this.animationList=this.playButton=this.timelineSlider=this.playbackRegion=this.previousFrameButton=this.nextFrameButton=this.pauseButton=this.playButton=0,this.visible=!1,this.backgroundRegion=this.screenButton=0,this.guiScreen=t,this.playbackRegion=new p(t),this.idealSliderWidth=650,this.totalListBoxPixelsX=0,this.minWidth=500,this.compactMode=!1,this.ui=t.ui;var e="animationpause"+t.imageSetNumber+"x.png",i="animationplay"+t.imageSetNumber+"x.png",s="timelineLE"+t.imageSetNumber+"x.png",n="timelineM"+t.imageSetNumber+"x.png",r="timelineRE"+t.imageSetNumber+"x.png",o=t.ui.viewer.scene.sceneAnimator.animations.length;if(0!=o){var a=this.idealSliderWidth;this.bottomOffset=85,this.centerOffset=60;var l=t.width/2+this.centerOffset,d=l-a/2,c=d-14-32,u=(l+=a/2)-c,f=32/t.height,m=this.bottomOffset/t.height,g=this.playbackRegion;if(g.controlRect.widthPercent=u/t.width,g.controlRect.heightPercent=f,g.controlRect.xPercent=c/t.width,g.controlRect.yPercent=m,f=32/u,this.pauseButton=new h(this.guiScreen),this.pauseButton.controlRect.set(0,.125,f,.75),this.pauseButton.controlRect.opacity=.5,g.controlRect.registerChildControlRect(this.pauseButton.controlRect),this.pauseButton.linkControl(g.addImageElement(this.pauseButton.controlRect,e)),this.playButton=new h(this.guiScreen),this.playButton.controlRect.set(0,.125,f,.75),this.playButton.controlRect.opacity=.5,g.controlRect.registerChildControlRect(this.playButton.controlRect),this.playButton.linkControl(g.addImageElement(this.playButton.controlRect,i)),e=a/u,u=(d-c)/u,this.timelineSlider=new z(this.guiScreen,g),this.timelineSlider.controlRect.set(u,.03125,e,1),g.controlRect.registerChildControlRect(this.timelineSlider.controlRect),this.timelineSlider.setBackground3x1(g,s,n,r),this.pauseButton.controlRect.showControl(!t.ui.viewer.scene.sceneAnimator.paused),this.playButton.controlRect.showControl(t.ui.viewer.scene.sceneAnimator.paused),s=l+14,n=this.bottomOffset+4,r=t.ui.viewer.scene.sceneAnimator.animations[0].cameraObjects.length,t.ui.viewer.scene.sceneAnimator.selectDefaultCamera(),t.ui.viewer.scene.sceneAnimator.setViewFromSelectedCamera(),this.maxListPixelsX=0,1<r){for(this.cameraList=new b(t),u=0;u<r;u++)this.cameraList.addItem(t.ui.viewer.scene.sceneAnimator.animations[0].cameraObjects[u].name,0,0);this.cameraList.spawnControl(s,n,10,24,!0,8),this.cameraList.selectItem(t.ui.viewer.scene.sceneAnimator.selectedCameraIndex),this.maxListPixelsX=this.cameraList.localPixelsX,this.totalListBoxPixelsX+=this.cameraList.localPixelsX+14}if(1<o){for(this.animationList=new b(t),u=0;u<o;u++)this.animationList.addItem(t.ui.viewer.scene.sceneAnimator.animations[u].name,0,0);this.animationList.spawnControl(s,n,10,24,!0,8),this.maxListPixelsX<this.animationList.localPixelsX&&(this.maxListPixelsX=this.animationList.localPixelsX),this.totalListBoxPixelsX+=this.animationList.localPixelsX+14,this.animationList.selectItem(t.ui.viewer.scene.sceneAnimator.selectedAnimationIndex)}u=l-(s=c-44-14)+this.totalListBoxPixelsX,this.speedList=new b(t),this.speedList.addItem("4.0x",4,0),this.speedList.addItem("2.0x",4,0),this.speedList.addItem("1.0x",4,0),this.speedList.addItem("0.5x",4,0),this.speedList.addItem("0.25x",-2,0),this.speedList.spawnControl(s,n,44,24,!1,0),this.speedList.selectItem(2),u>t.width&&(this.idealSliderWidth=t.width-(118+(this.totalListBoxPixelsX+14))-this.centerOffset,t=0,this.cameraList&&t++,this.animationList&&t++,1==t&&(this.idealSliderWidth+=56,this.centerOffset-=14),2==t&&(this.idealSliderWidth+=63,this.centerOffset-=63)),this.setupCallbacks()}}function k(t,e,i){if(this.gl=t,this.desc=e,e=[],0!=this.desc.sharpen&&e.push("#define SHARPEN"),(this.useBloom=0<this.desc.bloomColor[0]*this.desc.bloomColor[3]||0<this.desc.bloomColor[1]*this.desc.bloomColor[3]||0<this.desc.bloomColor[2]*this.desc.bloomColor[3])&&e.push("#define BLOOM"),0!=this.desc.vignette[3]&&e.push("#define VIGNETTE"),1==this.desc.saturation[0]*this.desc.saturation[3]&&1==this.desc.saturation[1]*this.desc.saturation[3]&&1==this.desc.saturation[2]*this.desc.saturation[3]||e.push("#define SATURATION"),1==this.desc.contrast[0]*this.desc.contrast[3]&&1==this.desc.contrast[1]*this.desc.contrast[3]&&1==this.desc.contrast[2]*this.desc.contrast[3]&&1==this.desc.brightness[0]*this.desc.brightness[3]&&1==this.desc.brightness[1]*this.desc.brightness[3]&&1==this.desc.brightness[2]*this.desc.brightness[3]||e.push("#define CONTRAST"),0!=this.desc.grain&&e.push("#define GRAIN"),1==this.desc.toneMap?e.push("#define REINHARD"):2==this.desc.toneMap?e.push("#define HEJL"):3==this.desc.toneMap&&e.push("#define ACES"),this.desc.colorLUT&&e.push("#define COLOR_LUT"),this.sampleIndex=0,this.sampleCount=1,i&&(this.sampleCount=4,this.sampleOffsets=[[-.5,-.5],[.5,-.5],[-.5,.5],[.5,.5]]),this.aaShader=t.shaderCache.fromURLs("postvert.glsl","postaa.glsl"),this.shader=t.shaderCache.fromURLs("postvert.glsl","postfrag.glsl",e),this.plainShader=t.shaderCache.fromURLs("postvert.glsl","postfrag.glsl",[]),this.fullscreenTriangle=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.fullscreenTriangle),i=new Float32Array([0,0,2,0,0,2]),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.useBloom){for(this.bloomTextures=[],this.bloomTargets=[],i=0;i<2;++i)e={width:256,height:256,clamp:!0},this.bloomTextures[i]=new U(t,e),this.bloomTextures[i].loadArray(null,t.RGBA,t.ext.textureHalf&&t.ext.textureHalfLinear?t.ext.textureHalf.HALF_FLOAT_OES:t.UNSIGNED_BYTE),this.bloomTargets[i]=new f(t,{width:e.width,height:e.height,color0:this.bloomTextures[i]});for(this.bloomSamples=64;this.bloomSamples+16>=t.limits.fragmentUniforms;)this.bloomSamples/=2;this.bloomShader=t.shaderCache.fromURLs("postvert.glsl","bloom.glsl",["#define BLOOM_SAMPLES "+this.bloomSamples]),this.shrinkShader=t.shaderCache.fromURLs("postvert.glsl","bloomshrink.glsl")}for(t=new Uint8Array(16384),i=0;i<16384;i++){e=255*Math.random();var s=255*Math.random();t[i]=.5*(e+s)}this.noiseTexture=new U(this.gl,{width:128,height:128}),this.noiseTexture.loadArray(t,this.gl.LUMINANCE),this.desc.colorLUT&&(t=this.desc.colorLUT,this.colorLUT=new U(this.gl,{width:t.length/3|0,height:1,clamp:!0}),this.colorLUT.loadArray(new Uint8Array(t),this.gl.RGB)),this.blackTexture=new U(this.gl,{width:1,height:1}),this.blackTexture.loadArray(new Uint8Array([0,0,0,0])),this.bloomResult=this.blackTexture}function F(t){this.gl=t,this.name="untitled",this.meshes=[],this.meshRenderables=[],this.materials={},this.sky=this.view=null,this.selectedPartIndex=0,this.soloPart=!1,this.miscnotes="",this.nextView=null,this.viewFade=0,this.refractionSurface=this.shadow=this.stripData=this.lights=null,this.sceneAnimator=this.frameCounter=0,this.sceneLoaded=!1,this.debugString=""}function P(t,e,i){if(this.scene=t,this.animations=[],this.skinningRigs=[],this.meshIDs=[],this.lightIDs=[],this.materialIDs=[],this.views=[],this.viewYawOffsets=[],this.viewPitchOffsets=[],this.cameraObjectIndices=[],this.cameraChildrenIndices=[],this.subMeshObjectIndices=[],this.subMeshLiveIndices=[],this.scene=t,this.selectedCameraIndex=-1,this.selectedAnimationIndex=0,this.debugString="",this.scenePlaybackSpeed=this.playbackSpeed=1,this.animationProgress=this.totalSeconds=0,this.paused=this.autoAdvanceNextAnimation=!1,this.animateVisibility=this.drawAnimated=this.linkSceneObjects=this.loadSkinningRigs=this.animateMaterials=this.animateTurntables=this.enableSkinning=this.animateMeshes=this.animateLights=this.playAnimations=this.loadAnimations=!0,this.showDebugInfo=!1,this.loopCount=0,this.loopTurntables=this.lockPlayback=!1,this.fogObjectIndex=-1,this.unitScaleSkinnedMeshes=!0,this.sceneScale=i.sceneScale,this.defaultCameraGlobalIndex=i.selectedCamera,this.selectedAnimationIndex=i.selectedAnimation,this.autoPlayAnims=i.autoPlayAnims,this.showPlayControls=i.showPlayControls,i.scenePlaybackSpeed&&(this.scenePlaybackSpeed=i.scenePlaybackSpeed,0==this.scenePlaybackSpeed&&(this.scenePlaybackSpeed=1)),this.autoPlayAnims||(this.paused=!0),this.loadAnimations){if(i.meshIDs)for(var s=i.meshIDs.length,r=0;r<s;++r){var o=i.meshIDs[r].partIndex;this.meshIDs.push(o)}if(i.lightIDs)for(s=i.lightIDs.length,r=0;r<s;++r)o=(o=i.lightIDs[r]).partIndex,this.lightIDs.push(o);if(i.materialIDs)for(s=i.materialIDs.length,r=0;r<s;++r)o=(o=i.materialIDs[r]).partIndex,this.materialIDs.push(o);if(this.numMatricesInTable=i.numMatrices,o=new l((r=e.get("MatTable.bin")).data),r||(this.numMatricesInTable=0,this.debugString+="<br>No mattable?"),i.skinningRigs&&this.loadSkinningRigs)for(s=i.skinningRigs.length,r=0;r<s;++r){var a=new M(e,i.skinningRigs[r],o);""==a.debugString?this.skinningRigs.push(a):(this.debugString+="<br>Error loading skinning rig "+r+" :"+a.debugString,this.debugString+="<br>Skipping the rest",r=s)}if(i.animations)for(o=i.animations.length,r=0;r<o;++r)s=new n(e,i.animations[r]),this.animations.push(s);if(this.startMS=Date.now(),o=this.animations.length,this.linkSceneObjects&&0!=o){for(r=0;r<o;r++)for(s=(e=this.animations[r]).animatedObjects.length,i=0;i<s;i++)"LightSO"==(a=e.animatedObjects[i]).sceneObjectType&&(a.lightIndex=this.findLightIndexByPartIndex(i),-1!=a.lightIndex?e.lightObjects.push(a):this.debugString+="<br> got light not in scene "+a.name),"FogSO"==a.sceneObjectType&&(this.fogObjectIndex=i),"SubMeshSO"==a.sceneObjectType&&0==r&&(this.subMeshObjectIndices.push(i),this.subMeshLiveIndices.push(-1)),"Material"==a.sceneObjectType&&(a.materialIndex=this.findMaterialIndexByPartIndex(i),-1==a.materialIndex?this.debugString+="<br> can't find material index for object "+i:e.materialObjects.push(a)),"TurnTableSO"==a.sceneObjectType&&e.turnTableObjects.push(a),"MeshSO"==a.sceneObjectType&&(a.meshIndex=this.findMeshIndexByPartIndex(this.scene.meshes,i),-1==a.meshIndex?(this.debugString+="<br> can't find mesh index for object "+i,this.logObjectInfo(i,0)):(e.meshObjects.push(a),a.mesh=this.scene.meshes[a.meshIndex],-1!=a.skinningRigIndex&&a.mesh&&a.skinningRigIndex<this.skinningRigs.length&&(a.skinningRig=this.skinningRigs[a.skinningRigIndex],a.skinningRig.isRigidSkin||(a.mesh.dynamicVertexData?a.skinningRig.useOriginalMeshVertices(a.mesh):(this.debugString+="Skinning object - but mesh is not dynamic",this.debugString+="<br>Rig index "+a.skinningRigIndex,this.debugString+=" not tagged as rigid"))))),"CameraSO"==a.sceneObjectType&&e.cameraObjects.push(a);for(i=(e=this.animations[0]).cameraObjects.length,r=0;r<i;r++)o=e.cameraObjects[r],(s=this.scene.cameras[o.name])?(s=s.view)&&(s=new H(s),this.cameraObjectIndices.push(o.id),this.views.push(s),this.viewYawOffsets.push(0),this.viewPitchOffsets.push(0)):(this.debugString+="<br>no camDesc for "+o.name,this.views.push(t.view));for(t=this.scene.meshes.length,o=this.subMeshObjectIndices.length,r=s=0;r<t;r++)for(a=this.scene.meshes[r],i=0;i<o;i++){var h=this.subMeshObjectIndices[i],d=e.animatedObjects[h],c=e.animatedObjects[d.parentIndex];if(c.mesh||(this.debugString+="<br>submesh parent object has no mesh?",this.debugString+="<br>obj.name "+d.name,this.debugString+="<br>parent.name "+c.name,this.debugString+="<br>submesh index "+i,this.debugString+="<br>obj.index "+h),c.mesh==a){for(h=0;h<a.numSubMeshes;h++)this.subMeshLiveIndices[i+(a.numSubMeshes-1-h)]=s,s++;i=o}}for(r=0;r<o;r++)-1==this.subMeshLiveIndices[r]&&(this.debugString+="<br>Missing mesh? Unused submesh "+r+" of "+o);this.showDebugInfo=this.stopEverything=this.runDebugMode=!1,this.selectDefaultCamera(),this.findCameraChildren(),this.findFixedTransforms(),this.runDebugMode&&(this.setAnimationProgress(0,!0),""!=this.debugString?this.stopEverything=!0:this.checkDebug())}}else this.debugString+="<br>Skip loading animation data"}function I(t){this.gl=t,this.program=null,this.params={},this.samplers={},this.attribs={}}function O(t){this.gl=t,this.cache=[]}function E(t,e){if(this.gl=t,this.shadowCount=e,this.nativeDepth=!!t.ext.textureDepth,this.desc=i,i=this.nativeDepth?["#define SHADOW_NATIVE_DEPTH"]:[],this.shaderSolid=t.shaderCache.fromURLs("shadowvert.glsl","shadowfrag.glsl",i),i.push("#define ALPHA_TEST 1"),this.shaderAlphaTest=t.shaderCache.fromURLs("shadowvert.glsl","shadowfrag.glsl",i),this.depthTextures=[],this.depthTargets=[],0<this.shadowCount){var i={width:2048,height:2048,clamp:!0,mipmap:!1,nofilter:!0};t.hints.mobile&&(i.width=i.height=1536);for(var s,n={width:i.width,height:i.height},r=this.nativeDepth?(s=t.DEPTH_COMPONENT,t.UNSIGNED_SHORT):(n.depthBuffer=f.createDepthBuffer(t,i.width,i.height),s=t.RGB,t.UNSIGNED_BYTE),o=0;o<this.shadowCount;++o)this.depthTextures[o]=new U(t,i),this.depthTextures[o].loadArray(null,s,r),this.nativeDepth?n.depth=this.depthTextures[o]:n.color0=this.depthTextures[o],this.depthTargets[o]=new f(t,n)}}function L(t,e,i,s){this.gl=t,this.desc=e,this.lightCount=s.count,this.shadowCount=i.shadowCount,(e=this.nativeDepth?["#define SHADOW_NATIVE_DEPTH"]:[]).push("#define LIGHT_COUNT "+this.lightCount),e.push("#define SHADOW_COUNT "+this.shadowCount),t.hints.mobile&&e.push("#define MOBILE"),this.shader=t.shaderCache.fromURLs("shadowfloorvert.glsl","shadowfloorfrag.glsl",e),e=new Float32Array([-1,0,-1,-1,0,1,1,0,1,-1,0,-1,1,0,1,1,0,-1]),this.quadGeom=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.quadGeom),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null)}function B(){this.associateObjectIndex=this.linkObjectIndex=this.linkMode=0,this.vertexIndices=[],this.vertexWeights=[],this.matrix=T.identity(),this.defaultAssociateWorldTransform=this.defaultClusterWorldTransform=this.defaultClusterBaseTransform=0,this.defaultClusterWorldTransformInvert=T.identity(),this.defaultAssociateWorldTransformInvert=T.identity(),this.debugString=""}function M(t,e,i){if(this.debugString="",this.skinningClusters=[],this.srcVFile=e.file,t=t.get(this.srcVFile))if(t.data){this.rigByteStream=new l(t.data),t=new Uint32Array(this.rigByteStream.bytes.buffer,0,this.rigByteStream.bytes.length/4),this.expectedNumClusters=t[0],this.expectedNumVertices=t[1],this.numClusterLinks=t[2],this.originalObjectIndex=t[3],this.isRigidSkin=t[4],this.tangentMethod=t[5],e=6+7*this.expectedNumClusters;for(var s=0;s<this.expectedNumClusters;s++){var n=new B;this.skinningClusters.push(n);var r=6+7*s;n.linkMode=t[1+r],n.linkObjectIndex=t[2+r],n.associateObjectIndex=t[3+r];var o=t[5+r];n.defaultClusterWorldTransform=i.getMatrix(t[4+r]),n.defaultClusterBaseTransform=i.getMatrix(o),T.invert(n.defaultClusterWorldTransformInvert,n.defaultClusterWorldTransform),1==n.linkMode&&(n.defaultAssociateWorldTransform=i.getMatrix(t[6+r]),T.invert(n.defaultAssociateWorldTransformInvert,n.defaultAssociateWorldTransform))}t=(e=(i=4*e)+this.expectedNumVertices)+2*this.numClusterLinks,e=new Uint8Array(this.rigByteStream.bytes.subarray(e)),t=new Uint8Array(this.rigByteStream.bytes.subarray(t)),this.linkMapCount=new Uint8Array(this.rigByteStream.bytes.buffer,i,this.expectedNumVertices),this.linkMapClusterIndices=new Uint16Array(e.buffer),this.linkMapWeights=new Float32Array(t.buffer)}else this.debugString+="<br>No data in "+this.srcVFile;else this.debugString+="<br>Error loading buffer for skinning rig "+this.srcVFile}function _(t,e,i){var s;if(this.gl=t,void 0!==(n=e.extract("sky.dat")||e.extract("sky.png"))){this.specularTexture=new U(t,{width:256,height:2048,clamp:!0}),e=n.data;for(var n,r=(n=n.data.length)/4,o=new Uint8Array(n),a=0,h=0;a<n;++h)o[a++]=e[h+2*r],o[a++]=e[h+r],o[a++]=e[h],o[a++]=e[h+3*r];this.specularTexture.loadArray(o)}if(this.diffuseCoefficients=new Float32Array(i.diffuseCoefficients),this.backgroundMode=i.backgroundMode||0,this.backgroundBrightness=i.backgroundBrightness||1,this.backgroundColor=new Float32Array(i.backgroundColor),1<=this.backgroundMode)if(this.backgroundShader=t.shaderCache.fromURLs("skyvert.glsl",3==this.backgroundMode?"skySH.glsl":"sky.glsl",["#define SKYMODE "+this.backgroundMode]),this.vertexBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),i=1/256,n=2.8*(e=.5/256),r=.5*e,i=new Float32Array([0,1,0,.49609375+i,.49609375+i,1,0,0,.9921875+i,.49609375+i,0,0,1,.49609375+i,.9921875+i,-1,0,0,0+i,.49609375+i,0,0,-1,.49609375+i,0+i,0,-1,0,.9921875+i,0+i,0,-1,0,.9921875+i,.9921875+i,0,-1,0,0+i,.9921875+i,0,-1,0,0+i,0+i,n,1-n,-n,.5+e,.5-e,n,1-n,n,.5+e,.5+e,-n,1-n,n,.5-e,.5+e,-n,1-n,-n,.5-e,.5-e,-n,0,-1+n,.5-e,0+i+e,n,0,-1+n,.5+e,0+i+e,1-n,0,-n,.9921875+i-e,.5-e,1-n,0,n,.9921875+i-e,.5+e,n,0,1-n,.5+e,.9921875+i-e,-n,0,1-n,.5-e,.9921875+i-e,-1+n,0,n,0+i+e,.5+e,-1+n,0,-n,0+i+e,.5-e,1,0,0,.9921875+i-r,.49609375+i,0,0,1,.49609375+i,.9921875+i-r,-1,0,0,0+i+r,.49609375+i,0,0,-1,.49609375+i,0+i+r,0,1,0,.49609375+i-r,.49609375+i,0,1,0,.49609375+i,.49609375+i-r,0,1,0,.49609375+i+r,.49609375+i,0,1,0,.49609375+i,.49609375+i+r]),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.indexBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),i=new Uint16Array([2,1,6,3,2,7,8,4,3,4,5,1,9,14,15,17,10,16,18,19,11,20,13,12,28,12,13,13,24,28,28,24,9,9,24,14,25,9,15,25,15,21,10,25,21,10,21,16,22,26,10,22,10,17,18,11,26,22,18,26,19,23,27,19,27,11,23,20,27,27,20,12]),this.skyIndexCount=i.length,t.bufferData(t.ELEMENT_ARRAY_BUFFER,i,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),3==this.backgroundMode)for(this.backgroundCoefficients=new Float32Array(this.diffuseCoefficients),a=0;a<this.backgroundCoefficients.length;++a)this.backgroundCoefficients[a]*=this.backgroundBrightness;else this.backgroundTexture=new U(t,{width:256,height:256,clamp:!0}),i=!1,t.ext.textureHalf&&t.ext.textureHalfLinear&&(this.backgroundTexture.loadArray(null,t.RGB,t.ext.textureHalf.HALF_FLOAT_OES),i=(s=new f(t,{color0:this.backgroundTexture})).valid),!i&&t.ext.textureFloat&&t.ext.textureFloatLinear&&!t.hints.mobile&&(this.backgroundTexture.loadArray(null,t.RGB,t.FLOAT),i=(s=new f(t,{color0:this.backgroundTexture})).valid),i||(this.backgroundTexture.loadArray(),s=new f(t,{color0:this.backgroundTexture})),s.bind(),(s=new I(t)).build("precision highp float; varying vec2 tc; attribute vec4 p; void main(){ gl_Position=p; tc=vec2(0.5,0.5/8.0)*p.xy+vec2(0.5,6.5/8.0); }","precision highp float; varying vec2 tc; uniform sampler2D tex; uniform float b; void main(){vec4 s=texture2D(tex,tc); gl_FragColor.xyz=s.xyz*(b*s.w);}"),s.bind(),t.uniform1f(s.params.b,7*Math.sqrt(this.backgroundBrightness)),this.specularTexture.bind(s.samplers.tex),i=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i),i=new Float32Array([-1,-1,.5,1,3,-1,.5,1,-1,3,.5,1]),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW),t.enableVertexAttribArray(s.attribs.p),t.vertexAttribPointer(s.attribs.p,4,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLES,0,3),t.disableVertexAttribArray(s.attribs.p)}function D(){this.STRIP_NONE=-2,this.STRIP_MENU=-1,this.stripCount=5,this.strips=[0,0,0,0,0],this.labels=["Normals","Albedo","Reflectivity","Gloss","Topology"],this.stripSlant=.25,this.selectedStrip=this.STRIP_NONE,this.animationActive=!1,this.timestamp=Date.now(),this.update(!0)}function U(t,e){this.gl=t,this.id=null,this.type=t.TEXTURE_2D,this.format=t.RGBA,this.componentType=t.UNSIGNED_BYTE,e=e||{},this.desc={width:e.width||1,height:e.height||1,mipmap:e.mipmap,clamp:e.clamp,mirror:e.mirror,aniso:e.aniso,nofilter:e.nofilter}}function N(t){this.gl=t,this.cache=[]}function z(t,e){this.name="none",this.debugString="",this.knobControlRect=new d(t),this.controlRect=new d(t);var i=document.createElement("div");i.id="sliderUI",i.style.position="absolute",i.style.overflow="hidden",i.style["-moz-user-select"]="none",i.style["-khtml-user-select"]="none",i.style["-webkit-user-select"]="none",i.style["-ms-user-select"]="none",this.controlRect.linkedControl=i,this.backgroundControl=0,this.controlRect.registerChildControlRect(this.knobControlRect),this.knobControlRect.setOpacity(.65),this.sliderPercent=this.pixelsY=this.pixelsX=0,this.draggingSlider=!1,this.guiScreen=t,e.addImageElement(this.knobControlRect,"animationknob"+t.imageSetNumber+"x.png")}function j(t){this.viewer=t,this.stripData=t.stripData,(t=this.container=document.createElement("div")).id="marmosetUI",t.style.position="absolute",t.style.overflow="hidden",t.style["-moz-user-select"]="none",t.style["-khtml-user-select"]="none",t.style["-webkit-user-select"]="none",t.style["-ms-user-select"]="none",this.viewer.domRoot.appendChild(t),this.guiScreen=new g(this)}A.prototype.resize=function(t){t.ui.viewer.scene.sceneAnimator.showPlayControls||(t.width=1,t.height=1),this.compactMode=t.width<this.minWidth;var e=this.bottomOffset,i=this.bottomOffset+4,s=0;this.cameraList&&this.animationList?s+=42+this.cameraList.localPixelsX+this.animationList.localPixelsX:this.cameraList?s+=28+this.cameraList.localPixelsX:this.animationList&&(s+=28+this.animationList.localPixelsX);var n=t.width-s-72;0==s&&(n-=14);var r=116,o=r+n+14;this.compactMode&&(r=58,n+=44+s,0<s&&(e+=32),s||(i+=32));var a=(s=32/n)+14/n,h=1-a,l=this.playbackRegion;l.controlRect.widthPercent=n/t.width,l.controlRect.heightPercent=32/t.height,l.controlRect.xPercent=r/t.width,l.controlRect.yPercent=e/t.height,this.pauseButton.controlRect.set(0,.125,s,.75),this.playButton.controlRect.set(0,.125,s,.75),this.timelineSlider.controlRect.set(a,.03125,h,1),this.timelineSlider.setSize(n-46,32),l.controlRect.updateElement(),l.controlRect.updateChildElements(),this.speedList.setControl(58,i,44,24,!1),this.cameraList&&(this.cameraList.setControl(o,i,10,24,!0,8),o+=this.cameraList.localPixelsX+14),this.animationList&&this.animationList.setControl(o,i,10,24,!0,8),this.timelineSlider.backgroundControl.alignBackground()},A.prototype.setupCallbacks=function(){var t=function(t){"0.01x"==this.speedList.selectedItemText&&this.ui.viewer.scene.sceneAnimator.setPlaybackSpeed(.01),"0.05x"==this.speedList.selectedItemText&&this.ui.viewer.scene.sceneAnimator.setPlaybackSpeed(.05),"0.25x"==this.speedList.selectedItemText&&this.ui.viewer.scene.sceneAnimator.setPlaybackSpeed(.25),"0.5x"==this.speedList.selectedItemText&&this.ui.viewer.scene.sceneAnimator.setPlaybackSpeed(.5),"1.0x"==this.speedList.selectedItemText&&this.ui.viewer.scene.sceneAnimator.setPlaybackSpeed(1),"2.0x"==this.speedList.selectedItemText&&this.ui.viewer.scene.sceneAnimator.setPlaybackSpeed(2),"4.0x"==this.speedList.selectedItemText&&this.ui.viewer.scene.sceneAnimator.setPlaybackSpeed(4)}.bind(this),e=function(t){this.ui.viewer.scene.sceneAnimator.selectCamera(this.cameraList.selectedIndex),this.ui.viewer.wake()}.bind(this),i=function(t){this.ui.viewer.scene.sceneAnimator.selectAnimation(this.animationList.selectedIndex),this.ui.viewer.wake()}.bind(this);this.speedList&&(this.speedList.selectionChangedCallback=t),this.cameraList&&(this.cameraList.selectionChangedCallback=e),this.animationList&&(this.animationList.selectionChangedCallback=i),this.playButton.controlRect.linkedControl.onclick=function(){this.ui.viewer.scene.sceneAnimator.pause(!1),this.playButton.controlRect.showControl(!1),this.pauseButton.controlRect.showControl(!0),this.ui.viewer.wake()}.bind(this),this.pauseButton.controlRect.linkedControl.onclick=function(){this.ui.viewer.scene.sceneAnimator.pause(!0),this.playButton.controlRect.showControl(!0),this.pauseButton.controlRect.showControl(!1)}.bind(this)},k.prototype.prepareBloom=function(t){if(this.useBloom&&this.bloomShader.complete()&&this.shrinkShader.complete()){this.shrinkShader.bind(),this.bloomTargets[1].bind(),t.bind(this.shrinkShader.samplers.tInput),this.fillScreen(this.shrinkShader.attribs.vCoord),this.bloomShader.bind();var e=[];this.bloomTargets[0].bind(),this.bloomTextures[1].bind(this.bloomShader.samplers.tInput);for(var i=0,s=0;s<this.bloomSamples;++s){var n=2*s/(this.bloomSamples-1)-1,r=4*n;i+=r=Math.exp(-.5*r*r)/2.50662827463,e[4*s+0]=n*this.desc.bloomSize,e[4*s+1]=0,e[4*s+2]=r,e[4*s+3]=0}for(s=0;s<this.bloomSamples;++s)e[4*s+2]/=i;for(this.gl.uniform4fv(this.bloomShader.params.uKernel,e),this.fillScreen(this.bloomShader.attribs.vCoord),this.bloomTargets[1].bind(),this.bloomTextures[0].bind(this.bloomShader.samplers.tInput),s=0;s<this.bloomSamples;++s)i=e[4*s+0],i*=t.desc.width/t.desc.height,e[4*s+0]=0,e[4*s+1]=i;this.gl.uniform4fv(this.bloomShader.params.uKernel,e),this.fillScreen(this.bloomShader.attribs.vCoord),this.bloomResult=this.bloomTextures[1]}else this.bloomResult=this.blackTexture},k.prototype.computeParams=function(t,e){var i=this.desc,s={};s.scale=[i.contrast[0]*i.contrast[3],i.contrast[1]*i.contrast[3],i.contrast[2]*i.contrast[3]],s.bias=[i.bias[0]*i.bias[3],i.bias[1]*i.bias[3],i.bias[2]*i.bias[3]],s.bias=[-s.bias[0]*s.scale[0]+s.bias[0],-s.bias[1]*s.scale[1]+s.bias[1],-s.bias[2]*s.scale[2]+s.bias[2]];var n=[i.brightness[0]*i.brightness[3],i.brightness[1]*i.brightness[3],i.brightness[2]*i.brightness[3]];s.scale=[s.scale[0]*n[0],s.scale[1]*n[1],s.scale[2]*n[2]],s.bias=[s.bias[0]*n[0],s.bias[1]*n[1],s.bias[2]*n[2]],s.saturation=[i.saturation[0]*i.saturation[3],i.saturation[1]*i.saturation[3],i.saturation[2]*i.saturation[3]],s.bloomColor=[i.bloomColor[0]*i.bloomColor[3],i.bloomColor[1]*i.bloomColor[3],i.bloomColor[2]*i.bloomColor[3]],s.sharpen=[i.sharpen,.25*i.sharpen,i.sharpenLimit],s.sharpenKernel=[1/t,0,0,1/e],n=e<t?t:e,s.vignetteAspect=[t/n,e/n,.5*t/n,.5*e/n],s.vignette=[2*(1-i.vignette[0])*i.vignette[3],2*(1-i.vignette[1])*i.vignette[3],2*(1-i.vignette[2])*i.vignette[3],i.vignetteCurve];n=1/this.noiseTexture.desc.width;var r=1/this.noiseTexture.desc.height,o=1-i.grainSharpness;return s.grainCoord=[n*t,r*e,.5*o*n,.5*o*r],s.grainScaleBias=[2*i.grain,-i.grain],s},k.prototype.present=function(t,e,i,s){var n,r,o,a,h;s||this.prepareBloom(t),1<this.sampleCount&&this.allocAABuffer(e,i),(s=s?this.plainShader:this.shader).bind()&&(n=this.gl,r=s.samplers,o=s.params,a=this.computeParams(e,i),t.bind(r.tInput),this.bloomResult.bind(r.tBloom),this.noiseTexture.bind(r.tGrain),this.colorLUT&&this.colorLUT.bind(r.tLUT),n.uniform3fv(o.uScale,a.scale),n.uniform3fv(o.uBias,a.bias),n.uniform3fv(o.uSaturation,a.saturation),n.uniform4fv(o.uSharpenKernel,a.sharpenKernel),n.uniform3fv(o.uSharpness,a.sharpen),n.uniform3fv(o.uBloomColor,a.bloomColor),n.uniform4fv(o.uVignetteAspect,a.vignetteAspect),n.uniform4fv(o.uVignette,a.vignette),n.uniform4fv(o.uGrainCoord,a.grainCoord),n.uniform2fv(o.uGrainScaleBias,a.grainScaleBias),(t=1<this.sampleCount&&0<=this.sampleIndex)?(h=1/(1+this.sampleIndex),this.sampleIndex+=1,h<1&&(n.enable(n.BLEND),n.blendColor(h,h,h,h),n.blendFunc(n.CONSTANT_ALPHA,n.ONE_MINUS_CONSTANT_ALPHA)),this.aaTarget.bind()):(f.bindNone(n),1<this.sampleCount&&(this.sampleIndex+=1)),n.viewport(0,0,e,i),this.fillScreen(s.attribs.vCoord),t&&(h<1&&n.disable(n.BLEND),f.bindNone(n),this.aaShader.bind(),this.aaBuffer.bind(this.aaShader.samplers.tInput),this.fillScreen(this.aaShader.attribs.vCoord)))},k.prototype.allocAABuffer=function(t,e){this.aaBuffer&&this.aaBuffer.desc.width==t&&this.aaBuffer.desc.height==e||(this.aaBuffer&&this.aaBuffer.destroy(),this.aaBuffer=new U(this.gl,{width:t,height:e,clamp:!0}),this.aaBuffer.loadArray(),this.aaTarget=new f(this.gl,{color0:this.aaBuffer,ignoreStatus:!0}))},k.prototype.adjustProjectionForSupersampling=function(t){var e,i;1<this.sampleCount&&(e=this.currentSample(),i=this.sampleOffsets[e][0]/t.size[0],e=this.sampleOffsets[e][1]/t.size[1],i=T.translation(T.empty(),i,e,0),T.mul(t.projectionMatrix,i,t.projectionMatrix))},k.prototype.discardAAHistory=function(){this.sampleIndex=-1},k.prototype.currentSample=function(){return(this.sampleIndex<0?0:this.sampleIndex)%this.sampleCount},k.prototype.fillScreen=function(t){var e=this.gl;e.bindBuffer(e.ARRAY_BUFFER,this.fullscreenTriangle),e.enableVertexAttribArray(t),e.vertexAttribPointer(t,2,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLES,0,3),e.disableVertexAttribArray(t),e.bindBuffer(e.ARRAY_BUFFER,null)},k.prototype.blitTexture=function(t){this.aaShader.bind(),t.bind(this.aaShader.samplers.tInput),this.fillScreen(this.aaShader.attribs.vCoord)},F.prototype.load=function(t){var e,i=this.gl,s=t.extract("scene.json");if(void 0===s)return!1;if(!t.checkSignature(s))return!1;if(null==(s=new l(s.data).asString())||s.length<=0)return!1;try{e=JSON.parse(s)}catch(t){return console.error(t),!1}for(var n in this.metaData=e.metaData,this.view=new H(e.mainCamera.view),this.sky=new _(this.gl,t,e.sky),this.lights=new v(e.lights,this.view),this.materialsList=[],this.materials={},e.materials){var r=e.materials[n];r.lightCount=this.lights.count,r.shadowCount=this.lights.shadowCount,s=new S(this.gl,t,r),this.materials[r.name]=s,this.materialsList.push(s)}if(e.meshes)for(r=0;r<e.meshes.length;++r){n=e.meshes[r],n=new C(this.gl,n,t.extract(n.file)),this.meshes.push(n);for(var o=0;o<n.desc.subMeshes.length;++o){var h=n.desc.subMeshes[o];(s=this.materials[h.material])&&(n.numSubMeshes++,this.meshRenderables.push(new w(n,h,s)))}}return this.bounds=new a(this.meshes),this.postRender=new k(this.gl,e.mainCamera.post,!0),this.shadow=new E(i,this.lights.shadowCount),this.cameras=e.Cameras,e.AnimData&&(this.sceneAnimator=new P(this,t,e.AnimData)),e.fog&&(this.fog=new u(i,e.fog)),e.shadowFloor&&(this.shadowFloor=new L(i,e.shadowFloor,this.shadow,this.lights)),this.sceneLoaded=!0},F.prototype.update=function(){this.sceneAnimator&&(this.frameCounter++,this.lights.flagUpdateAnimatedLighting(),this.sceneAnimator.drawAnimated&&(1==this.frameCounter?this.sceneAnimator.resetPlayback():this.sceneAnimator.updateAnimationPlayback())),this.lights.update(this.view,this.bounds)},F.prototype.collectShadows=function(t){this.shadow.collect(this,t)},F.prototype.draw=function(t){var e=this.gl;if(this.sceneLoaded){this.sky.setClearColor(),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.enable(e.DEPTH_TEST),this.sky.draw(this),this.shadowFloor&&this.shadowFloor.draw(this);for(var i=0;i<this.meshRenderables.length;++i)this.meshRenderables[i].material.usesBlending||this.meshRenderables[i].material.usesRefraction||!this.meshRenderables[i].visible||this.meshRenderables[i].draw(this);for(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(1,1),e.colorMask(!1,!1,!1,!1),i=0;i<this.meshRenderables.length;++i)this.meshRenderables[i].drawAlphaPrepass(this);for(e.colorMask(!0,!0,!0,!0),e.disable(e.POLYGON_OFFSET_FILL),e.depthFunc(e.LEQUAL),e.depthMask(!1),i=0;i<this.meshRenderables.length;++i)this.meshRenderables[i].material.usesBlending&&this.meshRenderables[i].visible&&this.meshRenderables[i].draw(this);e.disable(e.BLEND),e.depthMask(!0),e.depthFunc(e.LESS);var s=!1;for(i=0;i<this.meshRenderables.length;++i)if(this.meshRenderables[i].material.usesRefraction){s=!0;break}if(s)for(this.refractionSurface&&this.refractionSurface.desc.width==t.color0.desc.width&&this.refractionSurface.desc.height==t.color0.desc.height||(this.refractionSurface=new U(e,t.color0.desc),this.refractionSurface.loadArray(null,t.color0.format,t.color0.componentType),this.refractionBuffer=new f(this.gl,{color0:this.refractionSurface})),this.refractionBuffer.bind(),this.postRender.blitTexture(t.color0),t.bind(),i=0;i<this.meshRenderables.length;++i)this.meshRenderables[i].material.usesRefraction&&this.meshRenderables[i].visible&&this.meshRenderables[i].draw(this);if(this.stripData.activeWireframe()&&0<this.meshRenderables.length){for(i=0;i<this.meshRenderables.length;++i)this.meshRenderables[i].visible&&this.meshRenderables[i].drawWire(this);e.depthMask(!0)}e.disable(e.BLEND)}},F.prototype.drawSecondary=function(t){this.fog&&this.fog.draw(this,t)},F.prototype.complete=function(){if(!this.sky.complete()||!this.shadow.complete()||this.fog&&!this.fog.complete()||this.shadowFloor&&!this.shadowFloor.complete())return!1;for(var t=0;t<this.meshRenderables.length;++t)if(!this.meshRenderables[t].complete())return!1;return!0},P.prototype.logTimes=function(){this.debugString+="<br>Times";var t=this.animations[0],e=t.animatedObjects.length;this.debugString+="<br>Animation totalSeconds "+t.totalSeconds,this.debugString+="<br>Animation totalFrames "+t.totalFrames,this.debugString+="<br>Animation totalObjects "+e;for(var i=0;i<e;i++){var s=t.animatedObjects[i];this.debugString+="<br>Object: "+i,this.debugString+=" End: "+s.endTime,this.debugString+=" Length: "+s.animationLength,this.debugString+=" Frames: "+s.totalFrames}},P.prototype.flagAllForDebugging=function(){for(var t=this.animations.length,e=0;e<t;e++)for(var i=this.animations[e],s=i.animatedObjects.length,n=0;n<s;n++)i.animatedObjects[n].debugMe=!0},P.prototype.checkDebug=function(){this.debugString="<br>--------------------------------------Debug Info:",this.debugString+="<br>this.selectedAnimationIndex :"+this.selectedAnimationIndex;var t=this.animations[this.selectedAnimationIndex],e=t.animatedObjects.length;this.debugString+="<br>numAnimatedObjects :"+e,""!=t.debugString&&(this.debugString+="<br>--------------------------------------------------Got animation bug info:",this.debugString+=t.debugString,this.showDebugInfo=this.stopEverything=!0,t.debugString="");for(var i=0;i<e;i++){var s=t.animatedObjects[i];""==s.debugString&&""==s.animatedLocalTransform.debugString||(this.debugString+="<br>--------------------------------------------------Got object bug info:",this.debugString+=s.debugString,this.debugString+=s.animatedLocalTransform.debugString,this.showDebugInfo=this.stopEverything=!0,s.debugString="",s.animatedLocalTransform.debugString=""),s.skinningRig&&""!=s.skinningRig.debugString&&(this.debugString+="<br>--------------------------------------------------Got skin rig info:",this.debugString+=s.skinningRig.debugString,s.skinningRig.debugString="",this.showDebugInfo=this.stopEverything=!0)}this.debugString+="<br>--------------------------------------Done Debug Info:"},P.prototype.logObjectInfo=function(t,e){var i,s,n,r,o,a,h,l=this.animations[this.selectedAnimationIndex],d=e*l.originalFPS;t>=l.animatedObjects.length?this.debugString+="object index "+t+" exceeds "+l.animatedObjects.length:(i=l.animatedObjects[t],s=l.animatedObjects[i.modelPartIndex],n=l.getObjectAnimationFramePercent(i,e),r=l.getObjectAnimationFramePercent(s,e),this.debugString="",this.debugString+="<br>Object Name: "+i.name,this.debugString+="<br>Object Type: "+i.sceneObjectType,this.debugString+="<br>Object Index: "+i.id,this.debugString+="<br>Part Index: "+i.modelPartIndex,this.debugString+="<br>Part Scale: "+i.modelPartScale,this.debugString+="<br>Mesh Index: "+i.meshIndex,this.debugString+="<br>Light Index: "+i.lightIndex,this.debugString+="<br>Deformer Index: "+i.skinningRigIndex,this.debugString+="<br>Parent Index: "+i.parentIndex,this.debugString+="<br>Scene time "+e,this.debugString+="<br>Scene framepercent "+d,this.debugString+="<br>Object looped framepercent "+n,this.debugString+="<br>Model  looped framepercent "+r,this.debugString+="<br>Object Anim length "+i.animationLength,this.debugString+="<br>Object Total frames "+i.totalFrames,this.debugString+="<br>Object FPS "+i.modelPartFPS,this.debugString+="<br>Model Part Anim length "+s.animationLength,this.debugString+="<br>Model total frames "+s.totalFrames,this.debugString+="<br>Model Part FPS "+s.modelPartFPS,d=T.identity(),l.getWorldTransform(i.id,e,d,this.sceneScale,!0),this.debugString+=i.debugString,l=d[0],i=d[1],s=d[2],n=d[4],r=d[5],o=d[6],a=d[8],h=d[9],d=d[10],Math.sqrt(l*l+i*i+s*s),Math.sqrt(n*n+r*r+o*o),Math.sqrt(a*a+h*h+d*d))},P.prototype.resetPlayback=function(){this.startMS=Date.now(),this.animationProgress=this.totalSeconds=0,this.setAnimationProgress(0,!0)},P.prototype.pause=function(t){this.paused=t,this.startMS=Date.now()-1e3*this.totalSeconds/(this.playbackSpeed*this.scenePlaybackSpeed)},P.prototype.setAnimationProgress=function(t,e){var i=this.animations[this.selectedAnimationIndex];this.animationProgress=t,this.totalSeconds=i.totalSeconds*this.animationProgress,this.totalSeconds-=1/i.originalFPS,this.totalSeconds<0&&(this.totalSeconds=0),this.startMS=Date.now()-1e3*this.totalSeconds/(this.playbackSpeed*this.scenePlaybackSpeed),e&&this.updateScene()},P.prototype.setPlaybackSpeed=function(t){this.playbackSpeed=t,this.startMS=Date.now()-1e3*this.totalSeconds/(this.playbackSpeed*this.scenePlaybackSpeed)},P.prototype.resetCustomView=function(){0<=this.selectedCameraIndex&&this.selectedCameraIndex<this.views.length&&(this.viewYawOffsets[this.selectedCameraIndex]=0,this.viewPitchOffsets[this.selectedCameraIndex]=0,this.scene.view.rotation[1]=this.views[this.selectedCameraIndex].rotation[1],this.scene.view.rotation[0]=this.views[this.selectedCameraIndex].rotation[0],this.setViewFromSelectedCamera())},P.prototype.updateUserCamera=function(){var t,e,i,s,n,r,o,a,h,l,d,c,u,f,m;this.clearCacheForCameraChildren(),0<=this.selectedCameraIndex&&this.selectedCameraIndex<this.views.length&&this.selectedAnimationIndex<this.animations.length&&(l=this.cameraObjectIndices[this.selectedCameraIndex])<(t=this.animations[this.selectedAnimationIndex]).animatedObjects.length&&(e=this.views[this.selectedCameraIndex],i=this.scene.view.rotation[1],n=(s=this.scene.view.rotation[0])-e.rotation[0],this.viewYawOffsets[this.selectedCameraIndex]=i-e.rotation[1],this.viewPitchOffsets[this.selectedCameraIndex]=n,e=t.animatedObjects[l],t.getObjectAnimationFramePercent(e,this.totalSeconds),n=T.identity(),m=T.identity(),e.useFixedWorldTransform=!1,e.useFixedLocalTransform=!1,e.animatedLocalTransform.lockTransform=!1,e.animatedLocalTransform.clearCachedTransforms(),e.cachedFrame0=-1,e.cachedFrame1=-1,e.cachedFrame2=-1,e.cachedFrame3=-1,e.cachedFrameUse0=0,e.cachedFrameUse1=0,e.cachedFrameUse2=0,e.cachedFrameUse3=0,t.getWorldTransform(l,this.totalSeconds,m,this.sceneScale,!1),l=m[0],f=m[1],r=m[2],d=m[4],c=m[5],u=m[6],o=m[8],a=m[9],h=m[10],l=Math.sqrt(l*l+f*f+r*r),d=Math.sqrt(d*d+c*c+u*u),c=Math.sqrt(o*o+a*a+h*h),(u=-(this.scene.view.pivot[0]-m[12]))*o+(f=-(this.scene.view.pivot[1]-m[13]))*a+(m=-(this.scene.view.pivot[2]-m[14]))*h<=0&&(i+=180),i=T.rotation(T.empty(),i,1),s=T.rotation(T.empty(),s,0),T.mul(n,i,s),s=Math.sqrt(u*u+f*f+m*m),i=this.scene.view.pivot[1]+n[9]*s,m=this.scene.view.pivot[2]+n[10]*s,n[12]=this.scene.view.pivot[0]+n[8]*s,n[13]=i,n[14]=m,s=T.identity(),t.getWorldTransform(e.parentIndex,this.totalSeconds,s,this.sceneScale,!1),t=T.identity(),T.invert(t,s),s=T.identity(),T.mul(s,t,n),s[12]/=this.sceneScale,s[13]/=this.sceneScale,s[14]/=this.sceneScale,n[0]*=l,n[1]*=l,n[2]*=l,n[4]*=d,n[5]*=d,n[6]*=d,n[8]*=c,n[9]*=c,n[10]*=c,e.setFixedWorldTransform(n),e.setFixedLocalTransform(s))},P.prototype.setViewFromSelectedCamera=function(){var t,e,i,s;0<=this.selectedCameraIndex&&this.selectedCameraIndex<this.views.length&&(t=this.views[this.selectedCameraIndex],e=this.scene.view,i=this.viewYawOffsets[this.selectedCameraIndex],s=this.viewPitchOffsets[this.selectedCameraIndex],e.pivot[0]=t.pivot[0],e.pivot[1]=t.pivot[1],e.pivot[2]=t.pivot[2],e.rotation[0]=t.rotation[0]+s,e.rotation[1]=t.rotation[1]+i,e.radius=t.radius,e.nearPlane=t.nearPlane,e.fov=t.fov,e.limits=t.limits,e.saveResetView(),e.updateProjection(),e.updateView())},P.prototype.selectDefaultCamera=function(){if(-1!=this.defaultCameraGlobalIndex&&0<this.animations.length)for(var t=this.animations[0],e=t.cameraObjects.length,i=0;i<e;i++)if(t.cameraObjects[i].id==this.defaultCameraGlobalIndex)return void(this.selectedCameraIndex=i);this.selectedCameraIndex=0},P.prototype.updateAnimationPlayback=function(){var t,e,i;this.stopEverything&&this.runDebugMode||(t=this.animations[this.selectedAnimationIndex],this.updateUserCamera(),this.paused||!this.playAnimations?(this.startMS=0<this.playbackSpeed?Date.now()-1e3*this.totalSeconds/(this.playbackSpeed*this.scenePlaybackSpeed):Date.now()-1e3*this.totalSeconds,this.refreshTransformsOnly(),this.runDebugMode&&this.checkDebug(),(t=this.scene.view).saveResetView(),t.updateProjection(),t.updateView()):(this.lockPlayback&&0<this.playbackSpeed&&(this.startMS=Date.now()-1e3*this.totalSeconds/(this.playbackSpeed*this.scenePlaybackSpeed)),e=(Date.now()-this.startMS)/1e3*this.playbackSpeed*this.scenePlaybackSpeed,this.totalSeconds=(Date.now()-this.startMS)/1e3*this.playbackSpeed*this.scenePlaybackSpeed,i=(i=e/t.totalSeconds)-(e=Math.floor(i)),e!=this.loopCount&&(this.loopCount++,this.loopTurntables&&this.rolloverTurntables(),this.autoAdvanceNextAnimation&&(this.nextAnimation(),this.resetPlayback())),this.totalSeconds=t.totalSeconds*i,this.animationProgress=this.totalSeconds/t.totalSeconds-Math.floor(this.totalSeconds/t.totalSeconds),this.updateScene(),this.runDebugMode&&this.checkDebug()))},P.prototype.updateScene=function(){this.lastSceneFramePercent=this.totalSeconds*this.animations[this.selectedAnimationIndex].originalFPS,0!=this.fogObjectIndex&&this.updateFog(),this.animateTurntables&&this.updateTurntables(),this.animateMeshes&&this.poseMeshes(),this.animateLights&&this.updateLights(),this.animateMaterials&&this.updateMaterials(),this.animateVisibility&&this.updateVisibility()},P.prototype.findCameraChildren=function(){for(var t=this.animations[0],e=t.animatedObjects.length,i=0;i<e;i++)t.hasParentTypeInHierarchy(t.animatedObjects[i],"CameraSO")&&this.cameraChildrenIndices.push(i)},P.prototype.findFixedTransforms=function(){for(var t=this.animations.length,e=0;e<t;e++)for(var i=this.animations[e],s=i.animatedObjects.length,n=0;n<s;n++){var r,o,a=i.animatedObjects[n];a.useFixedWorldTransform||i.hasAnimationInHierarchy(a)||("Material"==a.sceneObjectType?(a.setFixedWorldTransform(T.identity()),a.setFixedLocalTransform(T.identity())):(r=T.identity(),o=T.identity(),i.hasParentTypeInHierarchy(a,"SceneRootSO")?(i.getWorldTransform(a.id,0,r,this.sceneScale,!1),a.evaluateLocalTransformAtFramePercent(0,o,!0,!1)):(i.evaluateModelPartTransformAtFrame(a.id,0,r,!1),a.evaluateLocalTransformAtFramePercent(0,o,!1,!1)),a.setFixedWorldTransform(r),a.setFixedLocalTransform(o)))}},P.prototype.clearCacheForCameraChildren=function(){for(var t=this.animations[this.selectedAnimationIndex],e=this.cameraChildrenIndices.length,i=0;i<e;i++){var s=t.animatedObjects[this.cameraChildrenIndices[i]];s.useFixedWorldTransform=!1,s.useFixedLocalTransform=!1,s.cachedFrame0=-10,s.cachedFrame1=-10,s.cachedFrame2=-10,s.cachedFrame3=-10,s.cachedFrameUse0=0,s.cachedFrameUse1=0,s.cachedFrameUse2=0,s.cachedFrameUse3=0,s.animatedLocalTransform.clearCachedTransforms(),s.animatedLocalTransform.lockTransform=!1}},P.prototype.refreshTransformsOnly=function(){for(var t=this.animations[this.selectedAnimationIndex],e=t.meshObjects.length,i=0;i<e;i++){var s,n,r,o,a,h,l,d,c,u=t.meshObjects[i];t.getWorldTransform(u.id,this.totalSeconds,u.mesh.displayMatrix,this.sceneScale,!0),this.enableSkinning&&u.skinningRig&&this.unitScaleSkinnedMeshes&&!u.skinningRig.isRigidSkin&&(l=(u=u.mesh.displayMatrix)[0],s=u[1],n=u[2],d=u[4],r=u[5],o=u[6],c=u[8],a=u[9],h=u[10],c=((l=Math.sqrt(l*l+s*s+n*n))+(d=Math.sqrt(d*d+r*r+o*o))+(c=Math.sqrt(c*c+a*a+h*h)))/2,u[0]/=c,u[1]/=c,u[2]/=c,u[4]/=c,u[5]/=c,u[6]/=c,u[8]/=c,u[9]/=c,u[10]/=c)}if(this.animateLights)for(e=t.lightObjects.length,i=0;i<e;i++)(u=t.lightObjects[i]).useFixedWorldTransform||(c=this.scene.lights.getLightPos(u.lightIndex),a=this.scene.lights.getLightDir(u.lightIndex),h=T.identity(),t.getWorldTransform(u.id,this.totalSeconds,h,this.sceneScale,!0),a[0]=h[8],a[1]=h[9],a[2]=h[10],0!=c[3]?(c[0]=h[12],c[1]=h[13],c[2]=h[14],this.scene.lights.setLightPos(u.lightIndex,c)):this.scene.lights.setLightPos(u.lightIndex,a),this.scene.lights.setLightDir(u.lightIndex,a))},P.prototype.findMeshIndexByPartIndex=function(t,e){for(var i=0;i<this.meshIDs.length;++i)if(e==this.meshIDs[i])return i;return-1},P.prototype.findLightIndexByPartIndex=function(t){for(var e=0;e<this.lightIDs.length;e++)if(t==this.lightIDs[e])return e;return-1},P.prototype.findMaterialIndexByPartIndex=function(t){for(var e=0;e<this.materialIDs.length;e++)if(t==this.materialIDs[e])return e;return-1},P.prototype.nextAnimation=function(){this.selectedAnimationIndex++,this.selectedAnimationIndex>=this.animations.length&&(this.selectedAnimationIndex=0)},P.prototype.selectAnimation=function(t){0<=t&&t<this.animations.length&&(this.selectedAnimationIndex=t),this.paused&&this.setAnimationProgress(this.animationProgress,!0)},P.prototype.selectCamera=function(t){-1!=t&&this.selectedCameraIndex!=t&&(this.selectedCameraIndex=t,this.setViewFromSelectedCamera())},P.prototype.getAnimatedCamera=function(){if(0<=this.selectedCameraIndex&&this.selectedAnimationIndex<this.animations.length){var t=this.animations[this.selectedAnimationIndex];if(this.selectedCameraIndex<t.cameraObjects.length)return t.cameraObjects[this.selectedCameraIndex]}},P.prototype.poseMeshes=function(){for(var t=this.animations[this.selectedAnimationIndex],e=t.meshObjects.length,i=0;i<e;i++){var s,n,r,o,a,h,l,d,c,u,f,m=t.meshObjects[i];this.enableSkinning&&m.skinningRig&&!m.skinningRig.isRigidSkin?(m.setupSkinningRig(t,m.modelPartIndex,this.totalSeconds,m.skinningRig),t.getWorldTransform(m.id,this.totalSeconds,m.mesh.displayMatrix,this.sceneScale,!0),s=m.modelPartScale*this.sceneScale,this.unitScaleSkinnedMeshes&&(c=(n=m.mesh.displayMatrix)[0],r=n[1],o=n[2],u=n[4],a=n[5],h=n[6],f=n[8],l=n[9],d=n[10],f=((c=Math.sqrt(c*c+r*r+o*o))+(u=Math.sqrt(u*u+a*a+h*h))+(f=Math.sqrt(f*f+l*l+d*d)))/2,n[0]/=f,n[1]/=f,n[2]/=f,n[4]/=f,n[5]/=f,n[6]/=f,n[8]/=f,n[9]/=f,n[10]/=f,s*=f),m.skinningRig.deformMesh(m.mesh,s)):t.getWorldTransform(m.id,this.totalSeconds,m.mesh.displayMatrix,this.sceneScale,!0)}},P.prototype.updateLights=function(){for(var t=this.animations[this.selectedAnimationIndex],e=this.totalSeconds*t.originalFPS,i=t.lightObjects.length,s=0;s<i;s++){var n=t.lightObjects[s],r=this.scene.lights.getLightPos(n.lightIndex),o=this.scene.lights.getLightDir(n.lightIndex),a=this.scene.lights.getLightColor(n.lightIndex),h=T.identity(),l=1;n.useFixedWorldTransform||t.getWorldTransform(n.id,this.totalSeconds,h,this.sceneScale,!0),n.redProperty&&(n.redProperty.evaluate(e,a[0],n),a[0]=n.redProperty.lastValue),n.greenProperty&&(n.greenProperty.evaluate(e,a[1],n),a[1]=n.greenProperty.lastValue),n.blueProperty&&(n.blueProperty.evaluate(e,a[2],n),a[2]=n.blueProperty.lastValue),n.brightnessProperty&&(n.brightnessProperty.evaluate(e,l,n),l=n.brightnessProperty.lastValue),a[0]*=l,a[1]*=l,a[2]*=l,0!=r[3]?(n.useFixedWorldTransform||(r[0]=h[12],r[1]=h[13],r[2]=h[14],this.scene.lights.setLightPos(n.lightIndex,r)),n.spotAngleProperty&&0<this.scene.lights.spot[3*n.lightIndex]&&(r=0,n.spotAngleProperty.evaluate(e,r,n),r=n.spotAngleProperty.lastValue,this.scene.lights.setLightSpotAngle(n.lightIndex,r)),n.spotSharpnessProperty&&(r=0,n.spotSharpnessProperty.evaluate(e,r,n),r=n.spotSharpnessProperty.lastValue,this.scene.lights.setLightSpotSharpness(n.lightIndex,r)),n.distanceProperty&&(r=1,n.distanceProperty.evaluate(e,r,n),r=n.distanceProperty.lastValue*this.sceneScale,this.scene.lights.setLightDistance(n.lightIndex,r))):this.scene.lights.setLightPos(n.lightIndex,o),n.useFixedWorldTransform||(o[0]=h[8],o[1]=h[9],o[2]=h[10],this.scene.lights.setLightDir(n.lightIndex,o)),this.scene.lights.setLightColor(n.lightIndex,a)}},P.prototype.updateTurntables=function(){for(var t=this.animations[this.selectedAnimationIndex],e=this.totalSeconds*t.originalFPS,i=t.turnTableObjects.length,s=0;s<i;s++){var n=t.turnTableObjects[s];n.spinProperty.evaluate(e,0,n),n.turnTableSpin=n.turnTableSpinOffset+n.spinProperty.lastValue*this.totalSeconds}},P.prototype.rolloverTurntables=function(){for(var t=this.animations[this.selectedAnimationIndex],e=t.turnTableObjects.length,i=0;i<e;i++){var s=t.turnTableObjects[i];s.turnTableSpinOffset=s.turnTableSpin}},P.prototype.updateMaterials=function(){for(var t=this.animations[this.selectedAnimationIndex],e=this.totalSeconds*t.originalFPS,i=t.materialObjects.length,s=0;s<i;s++){var n=t.materialObjects[s];n.offsetUProperty&&(n.offsetUProperty.evaluate(e,0,n),this.scene.materialsList[n.materialIndex].uOffset=n.offsetUProperty.lastValue),n.offsetVProperty&&(n.offsetVProperty.evaluate(e,0,n),this.scene.materialsList[n.materialIndex].vOffset=n.offsetVProperty.lastValue),n.emissiveProperty&&1<n.emissiveProperty.numKeyframes&&(n.emissiveProperty.evaluate(e,0,n),this.scene.materialsList[n.materialIndex].emissiveIntensity=n.emissiveProperty.lastValue)}},P.prototype.updateFog=function(){var t=this.animations[this.selectedAnimationIndex],e=this.totalSeconds*t.originalFPS;0<=this.fogObjectIndex&&this.fogObjectIndex<t.animatedObjects.length&&this.scene.fog&&((t=t.animatedObjects[this.fogObjectIndex]).redProperty&&(this.scene.fog.desc.color[0]=t.redProperty.evaluate(e,this.scene.fog.desc.color[0],t)),t.greenProperty&&(this.scene.fog.desc.color[1]=t.greenProperty.evaluate(e,this.scene.fog.desc.color[1],t)),t.blueProperty&&(this.scene.fog.desc.color[2]=t.blueProperty.evaluate(e,this.scene.fog.desc.color[2],t)),t.distanceProperty&&(this.scene.fog.desc.distance=t.distanceProperty.evaluate(e,this.scene.fog.desc.distance,t)),t.opacityProperty&&(this.scene.fog.desc.opacity=t.opacityProperty.evaluate(e,this.scene.fog.desc.opacity,t)),t.skyIllumProperty&&(this.scene.fog.desc.skyIllum=t.skyIllumProperty.evaluate(e,this.scene.fog.desc.skyIllum,t)),t.lightIllumProperty&&(this.scene.fog.desc.lightIllum=t.lightIllumProperty.evaluate(e,this.scene.fog.desc.lightIllum,t)),t.dispersionProperty&&(this.scene.fog.desc.dispersion=t.dispersionProperty.evaluate(e,this.scene.fog.desc.dispersion,t)))},P.prototype.updateVisibility=function(){for(var t=this.animations[this.selectedAnimationIndex],e=this.subMeshObjectIndices.length,i=0;i<e;i++){var s,n,r=this.subMeshLiveIndices[i];-1!=r&&(s=this.subMeshObjectIndices[i],r=this.scene.meshRenderables[r],n=t.getObjectAnimationFramePercent(t.animatedObjects[s],this.totalSeconds),r.visible=t.isVisibleAtFramePercent(s,n))}},I.prototype.build=function(e,i){var s=this.gl;this.program=s.createProgram(),this.params={},this.samplers={},this.attribs={};var n=function(t){for(var e="",i=t.indexOf("\n"),s=0;-1!=i;)e+=++s+": ",e+=t.substring(0,i+1),i=(t=t.substring(i+1,t.length)).indexOf("\n");console.log(e)},r=s.createShader(s.VERTEX_SHADER);s.shaderSource(r,e),s.compileShader(r),s.getShaderParameter(r,s.COMPILE_STATUS)||(console.log(s.getShaderInfoLog(r)),t.verboseErrors&&n(e)),s.attachShader(this.program,r),r=s.createShader(s.FRAGMENT_SHADER),s.shaderSource(r,i),s.compileShader(r),s.getShaderParameter(r,s.COMPILE_STATUS)||(console.log(s.getShaderInfoLog(r)),t.verboseErrors&&n(i)),s.attachShader(this.program,r),s.linkProgram(this.program),s.getProgramParameter(this.program,s.LINK_STATUS)||console.log(s.getProgramInfoLog(this.program));r=s.getProgramParameter(this.program,s.ACTIVE_UNIFORMS);var o=0;for(n=0;n<r;++n){var a=s.getActiveUniform(this.program,n),h=a.name,l=h.indexOf("[");0<=l&&(h=h.substring(0,l)),l=s.getUniformLocation(this.program,a.name),a.type==s.SAMPLER_2D||a.type==s.SAMPLER_CUBE?this.samplers[h]={location:l,unit:o++}:this.params[h]=l}for(r=s.getProgramParameter(this.program,s.ACTIVE_ATTRIBUTES),n=0;n<r;++n)o=s.getActiveAttrib(this.program,n),this.attribs[o.name]=s.getAttribLocation(this.program,o.name)},I.prototype.bind=function(){return!!this.program&&(this.gl.useProgram(this.program),!0)},I.prototype.complete=function(){return!!this.program},O.prototype.fromURLs=function(t,e,i){var s="";if(i)for(var n=0;n<i.length;++n)s=i[n]+"\n"+s;if(i=s+":"+t+"|"+e,void 0!==(n=this.cache[i]))return n;function r(){null!=a&&null!=h&&o.build(a,h)}var o=new I(this.gl),a=null,h=null;return this.fetch(t,(function(t){a=s+t,r()})),this.fetch(e,(function(t){h=s+t,r()})),this.cache[i]=o},O.prototype.fetch=function(t,e){void 0!==X?void 0!==X[t]?this.resolveIncludes(new String(X[t]),e):e(""):R.fetchText("src/shader/"+t,function(t){this.resolveIncludes(t,e)}.bind(this),(function(){e("")}))},O.prototype.resolveIncludes=function(t,e){for(var i=[],s=!0,n=function(t,e,n,r,o){return s=!0,i.push({offset:o,path:e.slice(1,e.length-1)}),""};s;)s=!1,t=t.replace(/#include\s((<[^>]+>)|("[^"]+"))/,n);if(0<i.length){var r=i.length;for(n=0;n<i.length;++n)this.fetch(i[n].path,function(s){if(this.src=s,--r<=0){for(s=i.length-1;0<=s;--s)t=t.substring(0,i[s].offset)+i[s].src+t.substring(i[s].offset);e(t)}}.bind(i[n]))}else e(t)},E.prototype.bindDepthTexture=function(t,e){this.shadowCount>e&&this.depthTextures[e].bind(t)},E.prototype.collect=function(t,e){for(var i=this.gl,s=t.lights,n=s.shadowCount,r=s.modelViewBuffer,o=s.projectionBuffer,a=s.matrix,h=0!=t.sceneAnimator,l=T.empty(),d=!1,c=0;c<n;++c)if(s.shadowsNeedUpdate[c]){d=!(s.shadowsNeedUpdate[c]=0),T.mul(l,r.subarray(16*c,16*(c+1)),a),T.mul(l,o.subarray(16*c,16*(c+1)),l),this.depthTargets[c].bind(),i.clearColor(1,1,1,1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);var u=this.shaderSolid;u.bind(),i.uniformMatrix4fv(u.params.uViewProjection,!1,l),i.uniformMatrix4fv(u.params.uMeshTransform,!1,T.identity());for(var f=0;f<t.meshRenderables.length;++f){var m=t.meshRenderables[f],p=m.material;!m.mesh.desc.castShadows||!p.castShadows||0<p.shadowAlphaTest||(h&&i.uniformMatrix4fv(u.params.uMeshTransform,!1,m.mesh.displayMatrix),m.drawShadow(u.attribs.vPosition))}for((u=this.shaderAlphaTest).bind(),i.uniformMatrix4fv(u.params.uViewProjection,!1,l),i.uniformMatrix4fv(u.params.uMeshTransform,!1,T.identity()),f=0;f<t.meshRenderables.length;++f)p=(m=t.meshRenderables[f]).material,m.mesh.desc.castShadows&&p.castShadows&&0<p.shadowAlphaTest&&(p.textures.albedo.bind(u.samplers.tAlbedo),h&&(i.uniform2f(u.params.uUVOffset,p.uOffset,p.vOffset),i.uniformMatrix4fv(u.params.uMeshTransform,!1,m.mesh.displayMatrix)),m.drawAlphaShadow(u.attribs.vPosition,u.attribs.vTexCoord))}d&&(e.bind(),i.enable(i.CULL_FACE),i.cullFace(i.BACK))},E.prototype.complete=function(){return this.shaderSolid.complete()&&this.shaderAlphaTest.complete()},L.prototype.draw=function(t){var e=t.view,i=t.lights,s=t.shadow,n=this.gl,r=this.shader.params,o=this.shader.samplers;this.shader.bind(),e=T.mul(T.empty(),e.projectionMatrix,e.viewMatrix),T.mul(e,e,this.desc.transform),n.uniformMatrix4fv(r.uModelViewProjectionMatrix,!1,e),e=T.mul(T.empty(),i.matrix,this.desc.transform),n.uniformMatrix4fv(r.uModelSkyMatrix,!1,e),0<i.count&&(n.uniform4fv(r.uLightPositions,i.positionBuffer),n.uniform3fv(r.uLightDirections,i.directionBuffer),n.uniform3fv(r.uLightColors,i.colors),n.uniform3fv(r.uLightParams,i.parameters),n.uniform3fv(r.uLightSpot,i.spot),t=.392699*t.postRender.currentSample(),n.uniform2f(r.uShadowKernelRotation,.5*Math.cos(t),.5*Math.sin(t)),0<i.shadowCount&&(t=s.depthTextures[0].desc.width,n.uniform2f(r.uShadowMapSize,t,1/t),n.uniformMatrix4fv(r.uShadowMatrices,!1,i.finalTransformBuffer),n.uniformMatrix4fv(r.uInvShadowMatrices,!1,i.inverseTransformBuffer),n.uniform4fv(r.uShadowTexelPadProjections,i.shadowTexelPadProjections),s.bindDepthTexture(o.tDepth0,0),s.bindDepthTexture(o.tDepth1,1),s.bindDepthTexture(o.tDepth2,2))),n.uniform3f(r.uShadowCatcherParams,this.desc.simple?1:0,this.desc.alpha,this.desc.edgeFade),n.depthMask(!1),n.enable(n.BLEND),n.blendFunc(n.ZERO,n.SRC_COLOR),i=this.shader.attribs.vPosition,n.bindBuffer(n.ARRAY_BUFFER,this.quadGeom),n.enableVertexAttribArray(i),n.vertexAttribPointer(i,3,n.FLOAT,!1,0,0),n.drawArrays(n.TRIANGLES,0,6),n.disableVertexAttribArray(i),n.bindBuffer(n.ARRAY_BUFFER,null),n.disable(n.BLEND),n.depthMask(!0)},L.prototype.complete=function(){return this.shader.complete()},B.prototype.solveAdditiveClusterTransform=function(t,e,i){e=T.identity();var s=T.identity(),n=T.identity();T.mul(e,t,this.defaultClusterBaseTransform),T.mul(s,this.defaultAssociateWorldTransformInvert,e),T.mul(n,this.defaultAssociateWorldTransformInvert,s),T.mul(i,this.defaultClusterWorldTransformInvert,n)},B.prototype.solveSimpleClusterTransform=function(t,e,i){var s=T.identity(),n=T.identity();T.invert(n,e),T.mul(s,n,t),T.mul(i,s,this.defaultClusterBaseTransform)},B.prototype.solveClusterTransformAtFrame=function(t,e,i,s){var n,r;1==this.linkMode?(n=T.identity(),e=T.identity(),t.evaluateModelPartTransformAtFrame(this.linkObjectIndex,i,n,!1),t.evaluateModelPartTransformAtFrame(this.associateObjectIndex,i,e,!1),this.solveAdditiveClusterTransform(n,e,s)):(n=T.identity(),r=T.identity(),t.evaluateModelPartTransformAtFrame(this.linkObjectIndex,i,n,!1),t.evaluateModelPartTransformAtFrame(e,i,r,!1),this.solveSimpleClusterTransform(n,r,s))},M.prototype.unpackUnitVectors=function(t,e,i,s){for(var n=0;n<i;n++){var r=e[s*n],o=e[s*n+1],a=32768<=o;a&&(o-=32768);var h=1-((r=r/32767.4*2-1)*r+(o=o/32767.4*2-1)*o);h=Math.sqrt(h),h=isNaN(h)?0:h;a&&(h=-h),t[3*n]=r,t[3*n+1]=o,t[3*n+2]=h}},M.prototype.copyOriginalVertices=function(t){if(!this.unTransformedVertices)if(this.unTransformedVertices=new Float32Array(3*t.vertexCount),this.unTransformedNormals=new Float32Array(3*t.vertexCount),this.unTransformedTangents=new Float32Array(3*t.vertexCount),this.unTransformedBiTangents=new Float32Array(3*t.vertexCount),this.skinVertexWeights=new Float32Array(t.vertexCount),this.skinVertexTransform4x3=new Float32Array(12),t.dynamicVertexData){var e=new Float32Array(t.dynamicVertexData.buffer);new Uint8Array(t.dynamicVertexData.buffer);var i=s=0,s=s+12+8;t.secondaryTexCoord&&(s+=8);var n=s,r=s+=4,o=(s=s+4,t.stride/2);s=new Uint8Array(t.dynamicVertexData.subarray(s)),s=new Uint16Array(s.buffer),n=new Uint8Array(t.dynamicVertexData.subarray(n)),n=new Uint16Array(n.buffer),r=new Uint8Array(t.dynamicVertexData.subarray(r)),r=new Uint16Array(r.buffer);for(this.unpackUnitVectors(this.unTransformedNormals,s,t.vertexCount,o),this.unpackUnitVectors(this.unTransformedTangents,n,t.vertexCount,o),this.unpackUnitVectors(this.unTransformedBiTangents,r,t.vertexCount,o),o=0;o<t.vertexCount;o++)r=(t.stride*o+i)/4,this.unTransformedVertices[3*o]=e[r],this.unTransformedVertices[3*o+1]=e[r+1],this.unTransformedVertices[3*o+2]=e[r+2]}else this.debugString+="<br>Can't init skinning rig - mesh buffer is not dynamic - rigid is "+this.isRigidSkin},M.prototype.useOriginalMeshVertices=function(t){this.isRigidSkin?this.debugString+="<br>useOriginalMeshVertices for rigid skin?":this.copyOriginalVertices(t)},M.prototype.deformMeshVertices=function(t,e){if(0!=this.skinningClusters.length&&this.unTransformedVertices){var i,s=t.stride/4,n=new Float32Array(t.dynamicVertexData.buffer),r=new Uint16Array(t.dynamicVertexData.buffer);new Uint8Array(t.dynamicVertexData.buffer),i=20,t.secondaryTexCoord&&(i+=8);var o=i,a=i+=4;i+=4;for(var h=this.unTransformedVertices.length/3,l=0,d=0;d<h;++d){var c=d,u=(c*t.stride+o)/2,f=(c*t.stride+a)/2,m=(c*t.stride+i)/2,p=this.linkMapCount[c],g=this.skinVertexTransform4x3;g[this.skinVertexWeights[c]=0]=0,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=0,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=0,g[11]=0;var x,y,v,b,S,T,C,w,R=this.linkMapWeights[l];if(1==p&&1==R){var A=this.linkMapClusterIndices[l],k=(A=this.skinningClusters[A]).matrix;g[0]=k[0],g[1]=k[1],g[2]=k[2],g[3]=k[4],g[4]=k[5],g[5]=k[6],g[6]=k[8],g[7]=k[9],g[8]=k[10],g[9]=k[12],g[10]=k[13],g[11]=k[14],this.skinVertexWeights[c]=1}else for(var F=this.skinVertexWeights[c]=0;F<p;F++)R=this.linkMapWeights[l+F],(A=this.linkMapClusterIndices[l+F])<this.skinningClusters.length&&(k=(A=this.skinningClusters[A]).matrix,g[0]+=R*k[0],g[1]+=R*k[1],g[2]+=R*k[2],g[3]+=R*k[4],g[4]+=R*k[5],g[5]+=R*k[6],g[6]+=R*k[8],g[7]+=R*k[9],g[8]+=R*k[10],g[9]+=R*k[12],g[10]+=R*k[13],g[11]+=R*k[14],this.skinVertexWeights[c]+=R,1==A.linkMode&&(this.skinVertexWeights[c]=1));l+=this.linkMapCount[d],0<this.skinVertexWeights[c]?(x=this.unTransformedVertices[3*d+0],y=this.unTransformedVertices[3*d+1],v=this.unTransformedVertices[3*d+2],b=this.unTransformedNormals[3*d+0],S=this.unTransformedNormals[3*d+1],T=this.unTransformedNormals[3*d+2],A=this.unTransformedTangents[3*d+0],k=this.unTransformedTangents[3*d+1],C=this.unTransformedTangents[3*d+2],p=this.unTransformedBiTangents[3*d+0],g=this.unTransformedBiTangents[3*d+1],R=this.unTransformedBiTangents[3*d+2],F=this.skinVertexTransform4x3,w=1,0<this.skinVertexWeights[c]&&(w=1/this.skinVertexWeights[c]),n[s*d]=w*(x*F[0]+y*F[3]+v*F[6]+F[9])*e,n[s*d+1]=w*(x*F[1]+y*F[4]+v*F[7]+F[10])*e,n[s*d+2]=w*(x*F[2]+y*F[5]+v*F[8]+F[11])*e,x=b*F[0]+S*F[3]+T*F[6],c=b*F[1]+S*F[4]+T*F[7],b=b*F[2]+S*F[5]+T*F[8],S=A*F[0]+k*F[3]+C*F[6],T=A*F[1]+k*F[4]+C*F[7],A=A*F[2]+k*F[5]+C*F[8],k=p*F[0]+g*F[3]+R*F[6],C=p*F[1]+g*F[4]+R*F[7],p=p*F[2]+g*F[5]+R*F[8],c/=g=Math.sqrt(x*x+c*c+b*b),b/=g,g=32767.4*((x/=g)/2+.5),R=32767.4*(c/2+.5),b<0&&(R+=32768),r[m]=Math.floor(g),r[1+m]=Math.floor(R),T/=g=Math.sqrt(S*S+T*T+A*A),A/=g,g=32767.4*((S/=g)/2+.5),R=32767.4*(T/2+.5),A<0&&(R+=32768),r[u]=Math.floor(g),r[1+u]=Math.floor(R),C/=g=Math.sqrt(k*k+C*C+p*p),p/=g,g=32767.4*((k/=g)/2+.5),R=32767.4*(C/2+.5),p<0&&(R+=32768),r[f]=Math.floor(g),r[1+f]=Math.floor(R)):(x=this.unTransformedVertices[3*d+0],y=this.unTransformedVertices[3*d+1],v=this.unTransformedVertices[3*d+2],n[s*d]=x*e,n[s*d+1]=y*e,n[s*d+2]=v*e)}}},M.prototype.deformMesh=function(t,e){var i;0==this.skinningClusters.length||this.isRigidSkin||(this.deformMeshVertices(t,e),(i=t.gl).bindBuffer(i.ARRAY_BUFFER,t.vertexBuffer),i.bufferData(i.ARRAY_BUFFER,t.dynamicVertexData,i.DYNAMIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null))},_.prototype.setClearColor=function(){var e;t.transparentBackground?this.gl.clearColor(0,0,0,0):this.backgroundMode<1?(e=this.backgroundColor,this.gl.clearColor(e[0],e[1],e[2],1)):this.gl.clearColor(.0582,.06772,.07805,1)},_.prototype.draw=function(e){if(this.backgroundMode<1||t.transparentBackground)return!1;var i,s,n,r;this.complete()&&(i=this.gl,s=this.backgroundShader,n=e.view,r=e.lights.invMatrix,s.bind(),i.uniformMatrix4fv(s.params.uInverseSkyMatrix,!1,r),i.uniformMatrix4fv(s.params.uViewProjection,!1,n.viewProjectionMatrix),3==this.backgroundMode?i.uniform4fv(s.params.uSkyCoefficients,this.backgroundCoefficients):this.backgroundTexture.bind(s.samplers.tSkyTexture),e=.07+.94*(1-e.stripData.activeFade()),i.uniform1f(s.params.uAlpha,e),i.bindBuffer(i.ARRAY_BUFFER,this.vertexBuffer),i.enableVertexAttribArray(s.attribs.vPosition),i.vertexAttribPointer(s.attribs.vPosition,3,i.FLOAT,!1,20,0),i.enableVertexAttribArray(s.attribs.vTexCoord),i.vertexAttribPointer(s.attribs.vTexCoord,2,i.FLOAT,!1,20,12),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e<1&&(i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA)),i.depthMask(!1),i.disable(i.DEPTH_TEST),i.drawElements(i.TRIANGLES,this.skyIndexCount,i.UNSIGNED_SHORT,0),i.enable(i.DEPTH_TEST),i.depthMask(!0),e<1&&i.disable(i.BLEND),i.disableVertexAttribArray(s.attribs.vPosition),i.disableVertexAttribArray(s.attribs.vTexCoord))},_.prototype.complete=function(){return!(this.backgroundShader&&!this.backgroundShader.complete())&&this.specularTexture.complete()},D.expDecay=function(t,e){return Math.exp(-.69314718/t*e)},D.prototype.update=function(t){var e=.001*(Date.now()-this.timestamp);this.timestamp=Date.now();for(var i=!1,s=0;s<this.stripCount;++s){var n,r=this.selectedStrip==this.STRIP_MENU?.3*(s+1)-.9:this.selectedStrip<0||s<this.selectedStrip?-2:2;t?this.strips[s]=r:(n=(n=r-this.strips[s])*D.expDecay(.05,e),this.animationActive&&(this.strips[s]=r-n),i=i||.001<Math.abs(n))}this.animationActive=i},D.prototype.active=function(){return this.selectedStrip>=this.STRIP_MENU},D.prototype.activeFade=function(){var t=(this.strips[this.stripCount-1]- -2)/(.3*this.stripCount-.9+2);return(t=1<t?1:t)<0?0:t},D.prototype.activeWireframe=function(){return this.active()&&.01<Math.abs(this.strips[4]-this.strips[3])},D.prototype.toggleMenu=function(){this.selectedStrip=this.selectedStrip==this.STRIP_MENU?this.STRIP_NONE:this.STRIP_MENU},D.prototype.selectStrip=function(t,e){if(this.selectedStrip==this.STRIP_MENU){var i=t+e*this.stripSlant;this.selectedStrip=this.STRIP_NONE;for(var s=0;s<this.stripCount;++s)if(i<this.strips[s]){this.selectedStrip=s;break}}else this.selectedStrip=this.STRIP_MENU},U.prototype.loadImage=function(t,e){var i=this.gl;t&&t.width&&t.height&&(this.desc.width=t.width,this.desc.height=t.height),this.id=i.createTexture(),i.bindTexture(this.type,this.id),this.format=e||i.RGBA,this.componentType=i.UNSIGNED_BYTE,i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),i.texImage2D(this.type,0,this.format,this.format,this.componentType,t),this.setParams(),i.bindTexture(this.type,null)},U.prototype.loadArray=function(t,e,i){var s=this.gl;this.id=s.createTexture(),s.bindTexture(this.type,this.id),this.format=e||s.RGBA,this.componentType=i||s.UNSIGNED_BYTE,s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),s.texImage2D(this.type,0,this.format,this.desc.width,this.desc.height,0,this.format,this.componentType,t||null),this.setParams(),s.bindTexture(this.type,null)},U.prototype.setParams=function(){var t=this.gl,e=function(t){return 0<t&&0==(t&t-1)};e(this.desc.width)&&e(this.desc.height)||(this.desc.clamp=!0,this.desc.mipmap=!1),e=!this.desc.nofilter,this.desc.mipmap?(t.generateMipmap(this.type),t.texParameteri(this.type,t.TEXTURE_MIN_FILTER,e?t.LINEAR_MIPMAP_LINEAR:t.NEAREST_MIPMAP_NEAREST)):t.texParameteri(this.type,t.TEXTURE_MIN_FILTER,e?t.LINEAR:t.NEAREST),t.texParameteri(this.type,t.TEXTURE_MAG_FILTER,e?t.LINEAR:t.NEAREST),(this.desc.clamp||this.desc.mirror)&&(e=this.desc.clamp?t.CLAMP_TO_EDGE:t.MIRRORED_REPEAT,t.texParameteri(this.type,t.TEXTURE_WRAP_S,e),t.texParameteri(this.type,t.TEXTURE_WRAP_T,e)),this.desc.aniso&&t.ext.textureAniso&&t.texParameteri(this.type,t.ext.textureAniso.TEXTURE_MAX_ANISOTROPY_EXT,this.desc.aniso)},U.prototype.rebuildMips=function(){this.desc.mipmap&&(this.gl.bindTexture(this.type,this.id),this.gl.generateMipmap(this.type))},U.prototype.copyColorBuffer=function(){this.gl.bindTexture(this.type,this.id),this.gl.copyTexSubImage2D(this.type,0,0,0,0,0,this.desc.width,this.desc.height)},U.prototype.bind=function(t){var e;t&&((e=this.gl).uniform1i(t.location,t.unit),e.activeTexture(e.TEXTURE0+t.unit),e.bindTexture(this.type,this.id))},U.prototype.destroy=function(){this.gl.deleteTexture(this.id),this.id=null},U.prototype.complete=function(){return!!this.id},N.prototype.fromURL=function(t,e){var i=this.cache[t];if(void 0!==i)return i;var s=new U(this.gl,e);return R.fetchImage(t,(function(t){s.loadImage(t)})),this.cache[t]=s},N.prototype.fromFile=function(t,e){if(!t)return null;var i=this.cache[t.name];if(void 0!==i)return i;var s=new U(this.gl,e);return this.cache[t.name]=s,N.parseFile(t,(function(t){s.loadImage(t),N.closeImage(t)})),s},N.prototype.fromFilesMergeAlpha=function(t,e,i){if(!e)return this.fromFile(t,i);var s=t.name+"|"+e.name,n=this.cache[s];if(void 0!==n)return n;var r=this.gl;this.blitShader||(this.blitShader=new I(this.gl),this.blitShader.build("precision highp float; varying vec2 c; attribute vec2 pos; void main(){ gl_Position.xy = 2.0*pos-vec2(1.0); gl_Position.zw = vec2(0.5,1.0); c=pos; }","precision highp float; varying vec2 c; uniform sampler2D tTex; void main(){ gl_FragColor=texture2D(tTex,c).rgbr; }"),this.mergeVerts=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.mergeVerts),n=new Float32Array([0,0,2,0,0,2]),r.bufferData(r.ARRAY_BUFFER,n,r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null));var o=function(t){this.blitShader.bind(),t.bind(this.blitShader.samplers.tTex),r.bindBuffer(r.ARRAY_BUFFER,this.mergeVerts),r.enableVertexAttribArray(this.blitShader.attribs.pos),r.vertexAttribPointer(this.blitShader.attribs.pos,2,r.FLOAT,!1,0,0),r.drawArrays(r.TRIANGLES,0,3),r.disableVertexAttribArray(this.blitShader.attribs.pos),r.bindBuffer(r.ARRAY_BUFFER,null)}.bind(this),a=new U(this.gl,i);this.cache[s]=a;var h=0,l=0,d=function(){if(h&&l){var t,e=l.width*l.height>h.width*h.height?(t=l.width,l.height):(t=h.width,h.height);if(a.desc.width=t,a.desc.height=e,t<=r.limits.viewportSizes[0]&&e<=r.limits.viewportSizes[1]){var i={clamp:!0};h.width==t&&h.height==e?(a.loadImage(h,r.RGBA),t=new f(r,{color0:a,ignoreStatus:!0}),N.closeImage(h)):((e=new U(r,i)).loadImage(h,r.RGB),N.closeImage(h),a.loadArray(null),(t=new f(r,{color0:a,ignoreStatus:!0})).bind(),o(e),e.destroy()),(e=new U(r,i)).loadImage(l,r.RGB),N.closeImage(l),t.bind(),r.colorMask(!1,!1,!1,!0),o(e),r.colorMask(!0,!0,!0,!0),e.destroy(),f.bindNone(r),a.rebuildMips()}else{(i=document.createElement("canvas")).width=t,i.height=e;var s=i.getContext("2d");for(s.drawImage(h,0,0),N.closeImage(h),i=s.getImageData(0,0,t,e),i=new Uint8Array(i.data.buffer,i.data.byteOffset,i.data.length),s.drawImage(l,0,0),N.closeImage(l),s=s.getImageData(0,0,t,e).data,t=t*e*4,e=0;e<t;e+=4)i[e+3]=s[e];a.loadArray(i)}N.closeImage(l)}}.bind(this);return N.parseFile(t,(function(t){h=t,d()})),N.parseFile(e,(function(t){l=t,d()})),a},N.parseFile=function(t,e,i){var s,n,r=i||new Image;"undefined"!=typeof URL&&void 0!==URL.createObjectURL?(t=new Blob([t.data],{type:t.type}),s=URL.createObjectURL(t),r.onload=function(){URL.revokeObjectURL(s),e&&e(r)},r.src=s):(t=new Blob([t.data],{type:t.type}),(n=new FileReader).onload=function(t){r.src=n.result},r.onload=function(){e&&e(r)},n.readAsDataURL(t))},N.closeImage=function(t){t&&256<t.width*t.height&&(t.onload=null,t.onerror=null,t.src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D")},z.prototype.setBackground3x1=function(t,e,i,s){var n=8/this.controlRect.getScreenHeight();this.backgroundControl=t.addTextButton("",0,(1-n)/2,1,n,1),this.backgroundControl.defaultAlpha=1,this.backgroundControl.setBackground3x1(t,0,0,e,i,s,4),this.backgroundControl.controlRect.xPercent=this.controlRect.xPercent,this.backgroundControl.controlRect.widthPercent=this.controlRect.widthPercent,this.controlRect.linkedControl.style.zIndex="3",this.setupCallbacks()},z.prototype.setSize=function(t,e){this.pixelsX=t;var i=24/(this.pixelsY=e);this.knobWidthPercent=24/t,this.knobControlRect.xPercent=.5-this.knobWidthPercent/2,this.knobControlRect.yPercent=(1-i)/2+-1/e,this.knobControlRect.widthPercent=this.knobWidthPercent,this.knobControlRect.heightPercent=i,this.controlRect.updateElement(),this.backgroundControl.controlRect.xPercent=this.controlRect.xPercent,this.backgroundControl.controlRect.widthPercent=this.controlRect.widthPercent,this.backgroundControl.controlRect.updateElement()},z.prototype.setSliderPercent=function(t){t<0&&(t=0),1<t&&(t=1),this.sliderPercent=t,this.knobControlRect.xPercent=t-this.knobWidthPercent/2,this.knobControlRect.updateElement()},z.prototype.setupCallbacks=function(){var t=function(t){var e;this.draggingSlider&&(e=this.backgroundControl.controlRect.linkedControl.getBoundingClientRect(),this.setSliderPercent((t.clientX-e.left)/e.width),this.guiScreen.ui.viewer.scene.sceneAnimator.setAnimationProgress(this.sliderPercent,!0),this.guiScreen.ui.viewer.scene.sceneAnimator.paused&&(this.guiScreen.ui.viewer.scene.postRender.discardAAHistory(),this.guiScreen.ui.viewer.reDrawScene()))}.bind(this),e=function(t){this.draggingSlider=!0;var e=this.backgroundControl.controlRect.linkedControl.getBoundingClientRect();this.setSliderPercent((t.clientX-e.left)/e.width),this.guiScreen.ui.viewer.scene.sceneAnimator.setAnimationProgress(this.sliderPercent,!0),this.guiScreen.ui.viewer.scene.sceneAnimator.lockPlayback=!0,this.guiScreen.ui.viewer.scene.sceneAnimator.paused&&(this.guiScreen.ui.viewer.scene.postRender.discardAAHistory(),this.guiScreen.ui.viewer.reDrawScene())}.bind(this),i=function(t){this.draggingSlider=!1,this.guiScreen.ui.viewer.scene.sceneAnimator.lockPlayback=!1}.bind(this);this.guiScreen.ui.viewer.input.element.addEventListener("mousemove",t),this.guiScreen.ui.viewer.input.element.addEventListener("mouseup",i),this.backgroundControl.controlRect.linkedControl.addEventListener("mousemove",t),this.backgroundControl.controlRect.linkedControl.addEventListener("mousedown",e),this.backgroundControl.controlRect.linkedControl.addEventListener("mouseup",i),this.controlRect.linkedControl.addEventListener("mouseup",i)},j.prototype.setSize=function(t,e){this.container.width=0|t,this.container.height=0|e,this.container.style.width=t+"px",this.container.style.height=e+"px",this.guiScreen.setSize(this.container.width,this.container.height)},j.prototype.clearView=function(){for(;this.container.hasChildNodes();)this.container.removeChild(this.container.childNodes[0]);delete this.progressBar,delete this.thumbnail,delete this.fadeThumbnail,delete this.playButton,delete this.helpOverlay},j.prototype.bindInput=function(t){t.onSingleTap.push(function(e,i){this.stripData.selectedStrip!=this.stripData.STRIP_NONE&&(e=2/t.element.clientWidth*e-1,i=1-2/t.element.clientHeight*i,this.stripData.selectStrip(e,i),this.stripData.selectedStrip==this.stripData.STRIP_MENU&&this.helpOverlay.active&&this.helpOverlay.toggle(),this.refreshUI(),this.viewer.wake())}.bind(this))},j.sanitize=function(t){return t?t.replace(/<|>|\(|\)|$|%|=/g,""):t},j.sanitizeURL=function(t){return t?0==t.indexOf("http://")||0==t.indexOf("https://")||0==t.indexOf("ftp://")?encodeURI(t):"http://"+encodeURI(t):t},j.prototype.showFailure=function(t){this.container.innerHTML='<br><br><br><p style="text-align:center;color:#aaaaaa"><b>Marmoset Viewer could not initialize.</b><br><i>'+(t||"")+"</i>"},j.prototype.showPreview=function(e){this.clearView(),this.thumbnail=document.createElement("canvas");var i=this.container.width/this.container.height;this.thumbnail.height=this.viewer.mobile?200:300,this.thumbnail.width=this.thumbnail.height*i|0,this.thumbnail.style.width=this.thumbnail.style.height="100%";var s=(i=this.thumbnail.getContext("2d")).fillStyle=i.createRadialGradient(this.thumbnail.width/2,this.thumbnail.height/2,(this.thumbnail.width+this.thumbnail.height)/2,this.thumbnail.width/2,0,0);s.addColorStop(0,"rgb(0,0,0)"),s.addColorStop(1,"rgb(150,150,150)"),i.fillStyle=s,i.fillRect(0,0,this.thumbnail.width,this.thumbnail.height),this.container.appendChild(this.thumbnail),this.playButton=document.createElement("input"),this.playButton.type="image",this.playButton.src=t.dataLocale+"play.png",this.playButton.style.position="absolute",this.playButton.style.left="50%",this.playButton.style.top="50%",this.playButton.style["-webkit-transform"]=this.playButton.style.transform="translate(-50%,-50%) scale(0.5,0.5)",this.playButton.style.opacity=.5,this.playButton.style.outline="0px",this.playButton.onclick=function(){this.viewer.loadScene(this.viewer.sceneURL),this.container.removeChild(this.playButton),delete this.playButton}.bind(this),this.container.appendChild(this.playButton),e||c(this.viewer.sceneURL,function(t){this.loadingImageURL||this.setThumbnail(t)}.bind(this))},j.prototype.setThumbnailURL=function(t){(this.loadingImageURL=t)&&R.fetchImage(this.loadingImageURL,this.setThumbnail.bind(this))},j.prototype.setThumbnail=function(t){if(this.thumbnail)if(t.height>=this.container.height){var e=this.container.height/t.height;t.style.position="absolute",t.style.outline="0px",t.style.left="50%",t.style.top="50%",t.style["-webkit-transform"]=t.style.transform="translate(-50%,-50%) scale("+e+","+e+")",this.container.replaceChild(t,this.thumbnail),this.thumbnail=t}else{var i,s=this.thumbnail.getContext("2d"),n=this.thumbnail.width,r=this.thumbnail.height;e=r/t.height;s.drawImage(t,(n-t.width*e)/2,0,t.width*e,r);try{i=s.getImageData(0,0,n,r)}catch(t){return}t=s.createImageData(n,r);for(var o=0;o<2;++o){e=i.data;for(var a=t.data,h=0,l=0;l<r;++l)for(var d=0;d<n;++d){for(var c=0,u=0,f=0,m=-2;m<=2;++m)for(var p=(p=l+m)<0?0:r<=p?r-1:p,g=-2;g<=2;++g){var x=d+g;c=c+e[x=4*(p*n+(x=x<0?0:n<=x?n-1:x))],u=u+e[x+1],f=f+e[x+2]}a[h++]=c/25,a[h++]=u/25,a[h++]=f/25,a[h++]=255}e=i,i=t,t=e}s.putImageData(i,0,0)}},j.prototype.showActiveView=function(){var e=this.thumbnail;if(this.clearView(),e&&(this.fadeThumbnail=e,this.fadeThumbnail.style.opacity=1,this.container.appendChild(this.fadeThumbnail)),!t.noUserInterface){void 0===t.largeUI&&(t.largeUI=this.viewer.mobile),this.container.width<450&&(t.largeUI=!1),e=1,window.devicePixelRatio&&(2<window.devicePixelRatio?e=4:1<window.devicePixelRatio&&(e=2)),t.largeUI&&e<4&&(e*=2);var i=t.largeUI?.3:.5;this.stripText=[];for(var s=0;s<this.stripData.labels.length;++s)this.stripText[s]=document.createElement("div"),this.stripText[s].style.position="absolute",this.stripText[s].style.cursor="pointer",this.stripText[s].style.pointerEvents="none",this.container.appendChild(this.stripText[s]),(a=document.createElement("div")).style.color="white",a.style.opacity=.5,a.style.fontFamily="Arial",a.style.textShadow="2px 2px 3px #000000",a.innerHTML=this.stripData.labels[s],this.stripText[s].appendChild(a),this.stripText[s].txt=a,(a=document.createElement("div")).style.width="10000px",a.style.height="2px",a.style.backgroundColor="#AAAAAA",a.style.opacity=1,a.style.position="absolute",a.style.left=a.style.top="-1px",this.stripText[s].appendChild(a),this.stripText[s].line=a;this.sigCluster=document.createElement("div"),this.sigCluster.style.position="absolute",this.sigCluster.style.right=t.largeUI?"12px":"9px",this.sigCluster.style.left="0px",this.sigCluster.style.top="6px",this.sigCluster.style.height=t.largeUI?"64px":"32px",this.logo=document.createElement("div"),this.logo.style.position="absolute",this.logo.style.right=t.largeUI?"-4px":"1px",this.logo.style.top=t.largeUI?"0px":"4px",this.logo.title="Made with Marmoset Toolbag",(h=document.createElement("input")).type="image",h.src=t.dataLocale+"logo"+e+"x.png",h.style.border="none",h.style.width=h.style.height=t.largeUI?"72px":"36px",h.style.border="0px",h.style.outline="0px",h.style.opacity=i,h.onmouseover=function(){this.style.opacity=1}.bind(h),h.onmouseout=function(){this.style.opacity=i}.bind(h),h.onclick=function(t){window.open("http://www.marmoset.co/viewer?utm_source=inapp&utm_medium=menu&utm_campaign=viewer","_blank"),this.style.opacity=i}.bind(h,this),(s=new XMLHttpRequest).open("HEAD",h.src,!0),s.onload=function(t){this.logo.appendChild(t)}.bind(this,h),s.send(),this.sigCluster.appendChild(this.logo),(s=this.viewer.scene.metaData).title=j.sanitize(s.title),s.subtitle=j.sanitize(s.subtitle),s.author=j.sanitize(s.author),s.link=j.sanitizeURL(s.link);var n,r,o=s.title&&0<s.title.length,a=s.subtitle&&0<s.subtitle.length,h=s.author&&0<s.author.length,l=s.link&&0<s.link.length;for((o||a||h)&&(o||(s.title="Art"),n=!o&&!a,(r=document.createElement("div")).style.position="absolute",r.style.right=t.largeUI?"74px":"46px",r.style.top="5px",r.style.width="1px",r.style.height=t.largeUI?n?"21px":"35px":n?"18px":"31px",r.style.opacity=.25,r.style.backgroundColor="white",this.sigCluster.appendChild(r),this.sigCluster.line=r,n=document.createElement("a"),l&&(n.href=s.link),n.style.position="absolute",n.style.right=t.largeUI?"86px":"58px",n.style.top="6px",n.style.textAlign="right",n.style.color="white",n.style.fontFamily="Arial",n.style.fontSize=t.largeUI?"14px":"12px",n.style.textDecoration="none",n.target="_blank",(r=document.createElement("font")).style.color="#FFFFFF",r.style.opacity=.5,r.style.textDecoration="none",r.style.textShadow="1px 1px 2px rgba(0,0,0,0.7)",r.innerHTML=s.title,h&&(r.innerHTML=o&&!a?r.innerHTML+"<br>by ":r.innerHTML+" by "),n.appendChild(r),(o=document.createElement("font")).style.color="#FF0044",o.style.opacity=1,o.style.textShadow="1px 1px 2px rgba(0,0,0,0.35)",o.innerHTML=s.author,n.appendChild(o),(h=document.createElement("font")).style.color="#FFFFFF",h.style.opacity=.5,h.style.textShadow="1px 1px 2px rgba(0,0,0,0.7)",a&&(h.innerHTML="<br>",h.innerHTML+=s.subtitle),n.appendChild(h),l&&(n.onmouseover=function(t,e,i){t.style.opacity=i.style.opacity=1,e.style.textDecoration="underline"}.bind(n,r,o,h),n.onmouseout=function(t,e,i){t.style.opacity=i.style.opacity=.5,e.style.textDecoration="none"}.bind(n,r,o,h)),this.sigCluster.appendChild(n),this.sigCluster.sceneTitle=n),this.container.appendChild(this.sigCluster),this.sigCluster.active=!0,this.sigCluster.toggle=function(){this.sceneTitle&&this.line&&(this.active?(this.removeChild(this.sceneTitle),this.removeChild(this.line)):(this.appendChild(this.sceneTitle),this.appendChild(this.line))),this.active=!this.active}.bind(this.sigCluster),this.helpOverlay=document.createElement("div"),this.helpOverlay.style.pointerEvents="none",this.container.appendChild(this.helpOverlay),this.hideSigOnHelp=s=this.container.width<450,this.hideSigOnStrips=!0,o=[8,8],h=s?(a=198+2*o[0],258+2*o[1]):(a=354+2*o[0],218+2*o[1]),(l=document.createElement("div")).style.position="absolute",l.style.width=l.style.height="100%",this.helpOverlay.contents=l,(l=document.createElement("div")).style.position="absolute",l.style.right=t.largeUI?"92px":"54px",l.style.top=s?"16px":"48px",l.style.width=a+"px",l.style.height=h+"px",this.helpOverlay.contents.appendChild(l),(h=document.createElement("div")).style.position="absolute",h.style.width="100%",h.style.height="100%",h.style.backgroundColor="black",h.style.opacity="0.65",h.style.borderRadius="16px",l.appendChild(h),(h=document.createElement("input")).type="button",h.value="x",h.style.position="absolute",h.style.color="#FFFFFF",h.style.fontWeight="bolder",h.style.backgroundColor="rgba(0,0,0,0.0)",h.style.border="0px",h.style.outline="0px",h.style.fontSize=t.largeUI?"16pt":"10pt",h.style.right=t.largeUI?"2px":"8px",h.style.top=t.largeUI?"0px":"4px",h.style.width=h.style.height=t.largeUI?"32px":"16px",h.style.pointerEvents="auto",h.style.cursor="pointer",h.onclick=function(t){this.helpOverlay.toggle(),this.refreshUI()}.bind(this,h),l.appendChild(h),(h=document.createElement("center")).style.position="absolute",h.style.left=o[0]-4+"px",h.style.right=o[0]+4+"px",h.style.top=h.style.bottom=o[1]+"px",h.style.paddingTop="8px",s||(h.style.paddingRight="8px"),l.appendChild(h),l=h,o=(this.viewer.mobile?"M":"PC")+(2<e?4:2)+"x.png",(h=document.createElement("img")).src=t.dataLocale+"helprotate"+o,h.style.width="66px",h.style.height="90px",l.appendChild(h),(h=document.createElement("img")).src=t.dataLocale+"helpzoom"+o,h.style.width="66px",h.style.height="90px",l.appendChild(h),(h=document.createElement("img")).src=t.dataLocale+"helpmove"+o,h.style.width="66px",h.style.height="90px",l.appendChild(h),(h=document.createElement("img")).src=t.dataLocale+"helpreset"+o,h.style.width="66px",h.style.height="90px",l.appendChild(h),(h=document.createElement("img")).src=t.dataLocale+"helplights"+o,h.style.position="relative",s||(h.style.left="8px"),h.style.width="66px",h.style.height="90px",l.appendChild(h),(o=document.createElement("a")).href="http://www.marmoset.co/viewer?utm_source=inapp&utm_medium=menu&utm_campaign=viewer",o.target="_blank",o.style.pointerEvents="auto",l.appendChild(o),(n=document.createElement("img")).src=t.dataLocale+"helpshadow.png",n.style.position="absolute",n.style.left=.5*a-(s?65:116)+"px",n.style.bottom=s?"6px":"8px",n.style.width=s?"116px":"232px",n.style.opacity=0,o.appendChild(n),n.targetOpacity=0,o.onmouseover=function(){this.targetOpacity=.65}.bind(n),o.onmouseout=function(){this.targetOpacity=0}.bind(n),window.setInterval(function(){this.style.opacity=.1*this.targetOpacity+.9*this.style.opacity}.bind(n),20),(h=document.createElement("img")).src=t.dataLocale+"helptitle.png",h.style.position="absolute",h.style.left=.5*a-(s?65:116)+"px",h.style.bottom=s?"8px":"12px",h.style.width=s?"116px":"232px",o.appendChild(h),(a=document.createElement("div")).style.position="absolute",a.style.left=0,a.style.right=s?"30px":"108px",a.style.bottom=s?"-4px":"4px",a.style.textAlign="right",a.style.fontFamilly="Arial",l.appendChild(a),(s=document.createElement("font")).style.fontSize="9pt",s.style.fontFamily="Arial",a.appendChild(s),(o=document.createElement("a")).style.color="#FF0044",o.style.textDecoration="none",o.style.pointerEvents="auto",o.innerHTML="www.marmoset.co/viewer",o.href="http://www.marmoset.co/viewer?utm_source=inapp&utm_medium=menu&utm_campaign=viewer",o.target="_blank",o.onmouseover=function(t){this.style.textDecoration="underline",t.targetOpacity=.65}.bind(o,n),o.onmouseout=function(t){this.style.textDecoration="none",t.targetOpacity=0}.bind(o,n),s.appendChild(o),this.helpOverlay.active=!1,this.helpOverlay.toggle=function(t){this.active?this.removeChild(this.contents):this.appendChild(this.contents),this.active=!this.active}.bind(this.helpOverlay,this.viewer),this.menuCluster=document.createElement("div"),this.menuCluster.style.position="absolute",this.menuCluster.style.right=t.largeUI?"4px":"8px",this.menuCluster.style.top=t.largeUI?"70px":"40px",t.largeUI?(this.menuCluster.style.width="72px",this.menuCluster.style.height="64px"):(this.menuCluster.style.width="36px",this.menuCluster.style.height="36px"),(l=document.createElement("div")).style.left=l.style.top="0px",l.style.width=l.style.height="100%",this.menuCluster.contents=l,this.menuCluster.appendChild(l),s=0,a=function(e,i,s,n,r){var o=document.createElement("input");return o.type="image",o.src=t.dataLocale+s,o.style.position="absolute",o.style.left="0px",o.style.bottom=-100*n+"%",o.style.border="none",o.style.outline="0px",o.title=i,o.style.opacity=r,t.largeUI?(o.style.width="64px",o.style.height="48px"):(o.style.width="32px",o.style.height="24px"),o.onmouseover=function(t){this.style.opacity=t}.bind(o,1),o.onmouseout=function(t){this.style.opacity=t}.bind(o,r),o.onmouseup=function(t){this.style.opacity=t}.bind(o,r),(i=new XMLHttpRequest).open("HEAD",o.src,!0),i.onload=function(t){t.appendChild(this)}.bind(o,e),i.send(),o},m.support()&&((l=a(this.menuCluster.contents,"Full Screen","fullscreen"+e+"x.png",s++,i)).onclick=function(t){m.active()?m.end():m.begin(this.viewer.domRoot,this.viewer.fullscreenChange.bind(this.viewer)),t.style.opacity=i,this.refreshUI()}.bind(this,l)),(l=a(this.menuCluster.contents,"Layer Views","strips"+e+"x.png",s++,i)).onclick=function(t){this.stripData.toggleMenu(),this.helpOverlay.active&&this.helpOverlay.toggle(),this.viewer.wake(),this.refreshUI()}.bind(this,l),(l=a(this.menuCluster.contents,"Help","help"+e+"x.png",s++,i)).onclick=function(t){this.stripData.selectedStrip==this.stripData.STRIP_MENU&&this.stripData.toggleMenu(),this.helpOverlay.toggle(),this.refreshUI()}.bind(this,l),this.guiScreen&&this.guiScreen.setupActiveView(this),this.container.appendChild(this.menuCluster),this.menuCluster.active=!0,this.menuCluster.toggle=function(){this.active?this.removeChild(this.contents):this.appendChild(this.contents),this.active=!this.active}.bind(this.menuCluster),void 0!==t.hostImage&&(t.hostURL&&((o=document.createElement("a")).href=t.hostURL,o.target="_blank"),(h=document.createElement("img")).src=t.hostImage,h.style.position="absolute",h.style.top="4px",h.style.left="4px",h.style.opacity=.65,h.style["-webkit-transform"]=h.style.transform="translate(-50%,-50%) scale(0.5,0.5) translate(50%,50%)",t.hostURL?(h.onmouseover=function(){this.style.opacity=1}.bind(h),h.onmouseout=function(){this.style.opacity=.5}.bind(h),o.appendChild(h),this.hostLogo=o):this.hostLogo=h,(s=new XMLHttpRequest).open("HEAD",h.src,!0),s.onload=function(){this.container.appendChild(this.hostLogo)}.bind(this),s.send()),this.sceneStats=document.createElement("text"),this.sceneStats.style.position="absolute",this.sceneStats.style.left="9px",this.sceneStats.style.bottom="8px",this.sceneStats.style.color="gray",this.sceneStats.style.fontFamily="Arial",this.sceneStats.style.fontSize="75%",a=s=e=0;a<this.viewer.scene.meshes.length;++a)e+=(l=this.viewer.scene.meshes[a]).indexCount/3,s+=l.vertexCount;this.sceneStats.innerHTML="Triangles: "+(0|e).toLocaleString()+"<br>Vertices: "+(0|s).toLocaleString(),t.showFrameTime&&(this.frameTimer=document.createElement("text"),this.frameTimer.style.position="absolute",this.frameTimer.style.left=this.frameTimer.style.top="5px",this.frameTimer.style.color="gray",this.frameTimer.style.fontSize="75%",this.container.appendChild(this.frameTimer),this.frameTimer.innerHTML="--",this.frameCount=1e20),this.animateStrips()}},j.prototype.refreshUI=function(){var t,e;this.sigCluster&&(t=!1,e=this.stripData.selectedStrip==this.stripData.STRIP_MENU,this.hideSigOnStrips&&(t=t||e),this.hideSigOnHelp&&(t=t||this.helpOverlay.active),this.sigCluster.active==t&&this.sigCluster.toggle())},j.prototype.signalLoadProgress=function(t,e){var i;this.thumbnail&&(this.progressBar||((i=document.createElement("div")).style.backgroundColor="rgb(30,30,30)",i.style.opacity=.5,i.style.position="absolute",i.style.left="20%",i.style.width="60%",i.style.bottom="30%",i.style.height="2px",this.progressBar=document.createElement("div"),this.progressBar.style.backgroundColor="white",this.progressBar.style.position="absolute",this.progressBar.style.left=this.progressBar.style.bottom="0px",this.progressBar.style.height="100%",this.progressBar.style.width="0px",i.appendChild(this.progressBar),this.container.appendChild(i),this.playButton&&(this.container.removeChild(this.playButton),delete this.playButton)),this.progressBar.style.width=e<=0?(100*t/(2097152+t)|0)+"%":(100*t/e|0)+"%")},j.prototype.animating=function(){return!!this.fadeThumbnail||!!this.frameTimer},j.prototype.animate=function(){if(this.fadeThumbnail&&(this.fadeThumbnailTimer=this.fadeThumbnailTimer||Date.now(),this.fadeThumbnail.style.opacity=1-.0015*(Date.now()-this.fadeThumbnailTimer),this.fadeThumbnail.style.opacity<.01&&(this.container.removeChild(this.fadeThumbnail),delete this.fadeThumbnail,delete this.fadeThumbnailTimer)),this.frameTimer&&(this.frameCount++,60<=this.frameCount)&&(i=(new Date).getTime(),void 0!==this.frameTime&&(s=(i-this.frameTime)/this.frameCount,s=Math.floor(100*s)/100,this.frameTimer.innerHTML=s+" ms",this.frameTimer.style.color=s<32?"green":"red"),this.frameCount=0,this.frameTime=i),this.guiScreen&&this.guiScreen.playbackControls&&((i=this.guiScreen.playbackControls.timelineSlider).draggingSlider?this.viewer.scene.sceneAnimator.setAnimationProgress(i.sliderPercent,!0):i.setSliderPercent(this.viewer.scene.sceneAnimator.animationProgress)),this.sceneStats){for(var t=s=i=0;t<this.viewer.scene.meshes.length;++t)var e=this.viewer.scene.meshes[t],i=i+e.indexCount/3,s=s+e.vertexCount;this.sceneStats.innerHTML="Triangles: "+(0|i).toLocaleString()+"<br>Vertices: "+(0|s).toLocaleString(),this.viewer.scene.sceneAnimator&&this.viewer.scene.sceneAnimator.showPlayControls&&(this.sceneStats.innerHTML+="<br><br><br><br>"),i=!!this.sceneStats.parentElement,s=this.stripData.active()||!1,i&&!s?(this.container.removeChild(this.sceneStats),this.hostLogo&&this.container.appendChild(this.hostLogo)):!i&&s&&(this.container.appendChild(this.sceneStats),this.hostLogo&&this.container.removeChild(this.hostLogo))}this.refreshUI(),(this.stripData.animationActive||this.stripData.active())&&(this.animateStrips(),this.stripData.animationActive&&this.viewer.wake())},j.prototype.animateStrips=function(){if(this.stripText)for(var t=Math.atan(this.viewer.canvas.height/this.viewer.canvas.width/this.stripData.stripSlant),e=0;e<this.stripData.labels.length;++e){var i=.5+.5*(i=(i=this.stripData.strips[e])-this.stripData.stripSlant);e==this.stripData.selectedStrip?(this.stripText[e].style["-ms-transform"]=this.stripText[e].style["-webkit-transform"]=this.stripText[e].style.transform="none",this.stripText[e].style.top="4px",this.stripText[e].style.left="0px",this.stripText[e].style.width="150px",this.stripText[e].txt.style.textAlign="center",this.stripText[e].txt.style.background="rgba(0, 0, 0, 0.75)",this.stripText[e].txt.style.background="-webkit-linear-gradient(left, rgba(0,0,0,0.75), rgba(0,0,0,0))",this.stripText[e].txt.style.background="-o-linear-gradient(left,      rgba(0,0,0,0.75), rgba(0,0,0,0))",this.stripText[e].txt.style.background="-moz-linear-gradient(left,    rgba(0,0,0,0.75), rgba(0,0,0,0))",this.stripText[e].txt.style.background="linear-gradient(left,         rgba(0,0,0,0.75), rgba(0,0,0,0))",this.stripText[e].txt.style.paddingLeft="32px",this.stripText[e].txt.style.paddingTop="6px",this.stripText[e].txt.style.paddingBottom="4px",this.stripText[e].txt.style.textShadow="1px 1px 2px rgba(0,0,0,0.7)",this.stripText[e].line.style.opacity=.5,this.stripText[e].line.style.top="100%",this.stripText[e].line.style.width="100%",this.stripText[e].line.style.height="1px"):(this.stripText[e].style["-ms-transform"]=this.stripText[e].style["-webkit-transform"]=this.stripText[e].style.transform="translate(-50%, -50%) rotate("+t+"rad) translate(50%, 50%)",this.stripText[e].style.left=100*i+"%",this.stripText[e].style.top="0px",this.stripText[e].style.width="85px",this.stripText[e].txt.style.textAlign="left",this.stripText[e].txt.style.background="none",this.stripText[e].txt.style.paddingLeft="8px",this.stripText[e].txt.style.paddingTop="6px",this.stripText[e].txt.style.paddingBottom="4px",this.stripText[e].txt.style.textShadow="2px 0px 3px rgba(0,0,0,0.7)",this.stripText[e].line.style.opacity=1,this.stripText[e].line.style.top="-1px",this.stripText[e].line.style.width="10000px",this.stripText[e].line.style.height="2px")}};var V={type:Float32Array,create:function(t,e,i,s){var n=new V.type(4);return n[0]=t,n[1]=e,n[2]=i,n[3]=s,n},empty:function(){return new V.type(4)},set:function(t,e,i,s,n){t[0]=e,t[1]=i,t[2]=s,t[3]=n},copy:function(t,e){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t},sub:function(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t},scale:function(t,e,i){return t[0]=i[0]*e,t[1]=i[1]*e,t[2]=i[2]*e,t[3]=i[3]*e,t},mul:function(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t[3]=e[3]*i[3],t},mad:function(t,e,i,s){return t[0]=e[0]*i[0]+s[0],t[1]=e[1]*i[1]+s[1],t[2]=e[2]*i[2]+s[2],t[3]=e[3]*i[3]+s[3],t},smad:function(t,e,i,s){return t[0]=e*i[0]+s[0],t[1]=e*i[1]+s[1],t[2]=e*i[2]+s[2],t[3]=e*i[3]+s[3],t},negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},negate4:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},length:function(t){var e=t[0],i=t[1];return t=t[2],Math.sqrt(e*e+i*i+t*t)},distance:function(t,e){var i=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2];return Math.sqrt(i*i+s*s+n*n)},dot:function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},dot4:function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},normalize:function(t,e){var i=e[0],s=e[1],n=e[2],r=Math.sqrt(i*i+s*s+n*n);return 0==r?V.set(t,0,0,0,0):(r=1/r,t[0]=i*r,t[1]=s*r,t[2]=n*r,t)},cross:function(t,e,i){return t[0]=e[1]*i[2],t[0]+=-e[2]*i[1],t[1]=e[2]*i[0]-e[0]*i[2],t[2]=e[0]*i[1]-e[1]*i[0],t},lerp:function(t,e,i,s){var n=1-s;return t[0]=e[0]*n+i[0]*s,t[1]=e[1]*n+i[1]*s,t[2]=e[2]*n+i[2]*s,t},lerp4:function(t,e,i,s){var n=1-s;return t[0]=e[0]*n+i[0]*s,t[1]=e[1]*n+i[1]*s,t[2]=e[2]*n+i[2]*s,t[3]=e[3]*n+i[3]*s,t},min:function(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t[2]=Math.min(e[2],i[2]),t[3]=Math.min(e[3],i[3]),t},max:function(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t[2]=Math.max(e[2],i[2]),t[3]=Math.max(e[3],i[3]),t},projectOnPlane:function(t,e,i,s){var n=V.empty();return V.sub(n,e,i),i=V.dot(n,s),smad(t,-i,normal,e),t}};function H(t){this.pivot=[0,0,0],this.rotation=[0,0],this.radius=1,this.nearPlane=.3,this.fov=45,this.size=[1,1],this.transform=T.empty(),this.viewMatrix=T.empty(),this.projectionMatrix=T.empty(),this.viewProjectionMatrix=T.empty(),t?this.loadView(t,!0):(this.saveResetView(),this.updateView(),this.updateProjection())}function W(t,e,i,s){var n;if(this.mobile=!!/Android|iPhone|iPod|iPad|Windows Phone|IEMobile|BlackBerry|webOS/.test(navigator.userAgent),this.mobileFast=!!/iPhone|iPad/.test(navigator.userAgent),n=!this.mobile)t:{if((n=document.createElement("canvas")).width=n.height=16,n=n.getContext("webgl",{})||n.getContext("experimental-webgl",{})){var r=n.getExtension("WEBGL_debug_renderer_info");if(r){n=n.getParameter(r.UNMASKED_RENDERER_WEBGL),n=!!/Intel|INTEL/.test(n);break t}}n=!1}this.desktopSlow=n,this.domRoot=document.createElement("div"),this.domRoot.style.width=t+"px",this.domRoot.style.height=e+"px",this.initCanvas(t,e),this.scene=this.input=null,this.sceneURL=i,this.sleepCounter=8,this.onLoad=null,this.stripData=new D,this.ui=new j(this),this.ui.setSize(t,e),this.ui.showPreview(s)}H.prototype.saveResetView=function(){this.resetDesc={angles:[this.rotation[0],this.rotation[1]],pivot:[this.pivot[0],this.pivot[1],this.pivot[2]],limits:this.limits,orbitRadius:this.radius,fov:this.fov}},H.prototype.loadView=function(t,e){t&&(this.rotation[0]=t.angles[0],this.rotation[1]=t.angles[1],this.pivot[0]=t.pivot[0],this.pivot[1]=t.pivot[1],this.pivot[2]=t.pivot[2],this.radius=t.orbitRadius,this.fov=t.fov,this.limits=t.limits,e&&this.saveResetView(),this.updateView(),this.updateProjection())},H.prototype.reset=function(){this.loadView(this.resetDesc)},H.prototype.updateView=function(){var t,e,i;void 0!==this.limits&&(this.limits.angles&&(i=this.limits.angles.x,t=this.limits.angles.y,void 0!==i&&(e=this.rotation[0]-i.offset,i=Math.min(Math.max(e,i.min),i.max),this.rotation[0]+=i-e),void 0!==t&&(e=this.rotation[1]-t.offset,i=Math.min(Math.max(e,t.min),t.max),this.rotation[1]+=i-e)),void 0!==this.limits.orbitRadius&&(t=this.limits.orbitRadius.min,e=this.limits.orbitRadius.max,void 0!==t&&(this.radius=Math.max(this.radius,t)),void 0!==e&&(this.radius=Math.min(this.radius,e))),void 0!==this.limits.pan&&(t=this.limits.pan,e=this.resetDesc.pivot,t.x&&(this.pivot[0]=e[0]),t.y&&(this.pivot[1]=e[1]),t.z&&(this.pivot[2]=e[2]))),T.translation(this.transform,0,0,this.radius),t=T.rotation(T.empty(),this.rotation[0],0),e=T.rotation(T.empty(),this.rotation[1],1),T.mul(t,e,t),T.mul(this.transform,t,this.transform),this.transform[12]+=this.pivot[0],this.transform[13]+=this.pivot[1],this.transform[14]+=this.pivot[2],T.invert(this.viewMatrix,this.transform),T.mul(this.viewProjectionMatrix,this.viewMatrix,this.projectionMatrix)},H.prototype.updateProjection=function(t){T.perspectiveInfinite(this.projectionMatrix,this.fov,this.size[0]/this.size[1],this.nearPlane,t),T.mul(this.viewProjectionMatrix,this.projectionMatrix,this.viewMatrix)},W.prototype.initCanvas=function(t,e){var i;this.canvas&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.canvas=document.createElement("canvas"),this.pixelRatio=window.devicePixelRatio||1,this.mobile?(i=this.mobileFast?1.5:1,this.pixelRatio=this.pixelRatio>i?i:this.pixelRatio):this.desktopSlow&&(this.pixelRatio=1),this.canvas.width=t*this.pixelRatio,this.canvas.height=e*this.pixelRatio,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.canvas.style.position="absolute",this.domRoot.appendChild(this.canvas)},W.prototype.initGL=function(){var e={alpha:!!t.transparentBackground,depth:!1,stencil:!1,antialias:!1,premultipliedAlpha:!!t.transparentBackground,preserveDrawingBuffer:!1};e=this.gl=this.canvas.getContext("webgl",e)||this.canvas.getContext("experimental-webgl",e);return this.gl?(this.canvas.addEventListener("webglcontextlost",function(t){t.preventDefault()}.bind(this),!1),this.canvas.addEventListener("webglcontextrestored",function(t){this.loadScene(this.sceneURL)}.bind(this),!1),e.ext={textureAniso:e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic"),textureFloat:e.getExtension("OES_texture_float"),textureFloatLinear:e.getExtension("OES_texture_float_linear"),textureHalf:e.getExtension("OES_texture_half_float"),textureHalfLinear:e.getExtension("OES_texture_half_float_linear"),textureDepth:e.getExtension("WEBGL_depth_texture"),colorBufferFloat:e.getExtension("WEBGL_color_buffer_float"),colorBufferHalf:e.getExtension("EXT_color_buffer_half_float"),index32bit:e.getExtension("OES_element_index_uint"),loseContext:e.getExtension("WEBGL_lose_context"),derivatives:e.getExtension("OES_standard_derivatives"),renderInfo:e.getExtension("WEBGL_debug_renderer_info")},e.limits={textureSize:e.getParameter(e.MAX_TEXTURE_SIZE),textureCount:e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),varyings:e.getParameter(e.MAX_VARYING_VECTORS),vertexAttribs:e.getParameter(e.MAX_VERTEX_ATTRIBS),vertexUniforms:e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),fragmentUniforms:e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),viewportSizes:e.getParameter(e.MAX_VIEWPORT_DIMS),vendor:e.getParameter(e.VENDOR),version:e.getParameter(e.VERSION)},e.hints={mobile:this.mobile,pixelRatio:this.pixelRatio},e.enable(e.DEPTH_TEST),e.shaderCache=new O(e),e.textureCache=new N(e),this.allocBacking(),!0):(this.ui.showFailure('Please <a href="http://get.webgl.org/" target=_blank>check<a/> to ensure your browser has support for WebGL.'),!1)},W.prototype.allocBacking=function(){var t=this.gl,e=!1,i={width:this.canvas.width,height:this.canvas.height};for(this.mainColor=new U(t,i),this.mainDepth=null,t.ext.textureDepth&&(this.mainDepth=new U(t,{width:this.canvas.width,height:this.canvas.height,nofilter:!0}),this.mainDepth.loadArray(null,t.DEPTH_COMPONENT,t.UNSIGNED_INT)),t.ext.textureHalf&&t.ext.textureHalfLinear&&(this.mainColor.loadArray(null,t.RGBA,t.ext.textureHalf.HALF_FLOAT_OES),this.mainBuffer=new f(t,{color0:this.mainColor,depth:this.mainDepth,createDepth:!this.mainDepth}),e=this.mainBuffer.valid),!e&&t.ext.textureFloat&&t.ext.textureFloatLinear&&!t.hints.mobile&&(this.mainColor.loadArray(null,t.RGBA,t.FLOAT),this.mainBuffer=new f(t,{color0:this.mainColor,depth:this.mainDepth,createDepth:!this.mainDepth}),e=this.mainBuffer.valid);!e;)this.mainColor=new U(t,i),this.mainColor.loadArray(null,t.RGBA,t.UNSIGNED_BYTE),this.mainBuffer=new f(t,{color0:this.mainColor,depth:this.mainDepth,createDepth:!this.mainDepth}),e=this.mainBuffer.valid,i.width/=2,i.height/=2,this.mainDepth&&(this.mainDepth.destroy(),this.mainDepth=null);this.mainBufferNoDepth=new f(t,{color0:this.mainColor})},W.prototype.loadScene=function(t){var e,i;this.sceneURL=t||this.sceneURL,this.scene=this.input=null,this.initGL()&&this.sceneURL&&(e=this.ui.signalLoadProgress.bind(this.ui),t=function(t){e(1,1),this.scene=new F(this.gl),this.scene.stripData=this.stripData,this.scene.load(new r(t))?this.scene.metaData.tbVersion<=2070?this.ui.showFailure("This .mview file is from an out-of-date beta version of Toolbag. Please re-export it with the new version. Thanks!"):(this.bindInput(),this.requestFrame(this.updateLoad.bind(this)),this.onLoad&&this.onLoad()):this.ui.showFailure("Package file could not be read or is invalid.")}.bind(this),i=function(){this.ui.showFailure("Package file ("+this.sceneURL+") could not be retrieved.")}.bind(this),R.fetchBinary(this.sceneURL,t,i,e))},W.prototype.unload=function(){delete this.scene,delete this.input,delete this.ui,delete this.mainColor,delete this.mainBuffer,delete this.gl;var t=this.domRoot.clientWidth,e=this.domRoot.clientHeight;this.initCanvas(t,e),this.ui=new j(this),this.ui.setSize(t,e),this.ui.showPreview(),this.cancelFrame()},W.prototype.bindInput=function(){this.input=new x(this.ui.container),this.input.onDrag.push(function(t,e,i,s){t=1-2.2/(Math.sqrt(i*i+s*s)+2.2),(e=this.scene.view).rotation[1]-=.4*i*t,e.rotation[0]-=.4*s*t,e.rotation[0]=90<e.rotation[0]?90:e.rotation[0],e.rotation[0]=e.rotation[0]<-90?-90:e.rotation[0],e.updateView(),this.wake()}.bind(this)),this.input.onPan.push(function(t,e){var i=this.scene.view,s=-t*(n=i.fov/45*.8*(i.radius/this.domRoot.clientHeight)),n=e*n;i.pivot[0]+=s*i.transform[0]+n*i.transform[4],i.pivot[1]+=s*i.transform[1]+n*i.transform[5],i.pivot[2]+=s*i.transform[2]+n*i.transform[6],i.updateView(),this.wake()}.bind(this)),this.input.onPan2.push(function(t,e){var i=1-2.2/(Math.sqrt(t*t+e*e)+2.2);this.scene.lights.rotation-=.4*t*i,this.wake()}.bind(this)),this.input.onZoom.push(function(t){var e=this.scene.view;e.radius*=1-.002*t,e.radius=e.radius<.001?.001:e.radius,e.radius=1e3<e.radius?1e3:e.radius,e.updateView(),this.wake()}.bind(this)),this.input.onDoubleTap.push(function(t,e){this.scene.view.reset(),this.scene.sceneAnimator&&this.scene.sceneAnimator.resetCustomView(),this.wake()}.bind(this)),this.ui.bindInput(this.input)},W.prototype.wake=function(t){t=t||16,this.sleepCounter=this.sleepCounter<t?t:this.sleepCounter,this.scene.postRender.discardAAHistory(),this.requestFrame(this.update.bind(this))},W.prototype.requestFrame=function(t){var e,i=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;this.frameRequestPending||(e=function(){this.frameRequestPending=0,t()}.bind(this),this.frameRequestPending=i(e,this.canvas))},W.prototype.cancelFrame=function(){this.frameRequestPending&&(window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.msCancelAnimationFrame)(this.frameRequestPending)},W.prototype.fullscreenChange=function(){m.active()?(this.oldRootWidth=this.domRoot.style.width,this.oldRootHeight=this.domRoot.style.height,this.domRoot.style.width="100%",this.domRoot.style.height="100%"):(this.domRoot.style.width=this.oldRootWidth,this.domRoot.style.height=this.oldRootHeight),this.wake()},W.prototype.resize=function(t,e){t&&e?(this.domRoot.style.width=t+"px",this.domRoot.style.height=e+"px"):(t=this.domRoot.clientWidth,e=this.domRoot.clientHeight),this.canvas.width=t*this.pixelRatio,this.canvas.height=e*this.pixelRatio,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.ui.setSize(t,e),this.allocBacking(),this.wake()},W.prototype.updateLoad=function(){this.scene.complete()?this.start():this.requestFrame(this.updateLoad.bind(this)),this.ui.animate()},W.prototype.start=function(){this.scene.view.updateView(),this.ui.showActiveView(),this.requestFrame(this.update.bind(this))},W.prototype.update=function(){var t=this.scene.sceneAnimator&&!this.scene.sceneAnimator.paused;(0<this.sleepCounter||this.ui.animating()||t||this.stripData.animationActive)&&(this.stripData.update(),this.ui.animate(),this.scene.update(),this.drawScene(),this.requestFrame(this.update.bind(this))),t?this.scene.postRender.discardAAHistory():this.sleepCounter--},W.prototype.reDrawScene=function(){this.stripData.update(),this.ui.animate(),this.scene.update(),this.drawScene(),this.requestFrame(this.update.bind(this)),this.scene.postRender.discardAAHistory()},W.prototype.drawScene=function(){this.gl.isContextLost()||(this.domRoot.clientWidth==this.canvas.clientWidth&&this.domRoot.clientHeight==this.canvas.clientHeight||this.resize(),this.scene.view.size=[this.mainBuffer.width,this.mainBuffer.height],this.scene.view.updateProjection(),this.scene.postRender.adjustProjectionForSupersampling(this.scene.view),this.scene.collectShadows(this.mainBuffer),this.mainBuffer.bind(),this.scene.draw(this.mainBuffer),this.mainDepth&&(this.mainBufferNoDepth.bind(),this.scene.drawSecondary(this.mainDepth)),this.scene.postRender.present(this.mainColor,this.canvas.width,this.canvas.height,this.stripData.active()))},(t=void 0===t?{}:t).WebViewer=W,t.dataLocale=(0==window.location.protocol.indexOf("https")?"https:":"http:")+"//viewer.marmoset.co/main/data/";var X={"alphaprepassfrag.glsl":"precision mediump float;\n#include <matdither.glsl>\nuniform sampler2D tAlbedo;varying mediump vec2 d;void main(){float e=texture2D(tAlbedo,d).a;if(e<=f(d.x)){discard;}gl_FragColor=vec4(0.0);}","alphaprepassvert.glsl":"precision highp float;uniform mat4 uModelViewProjectionMatrix;uniform vec2 uUVOffset;attribute vec3 vPosition;attribute vec2 vTexCoord;varying mediump vec2 d;vec4 h(mat4 i,vec3 p){return i[0]*p.x+(i[1]*p.y+(i[2]*p.z+i[3]));}void main(void){gl_Position=h(uModelViewProjectionMatrix,vPosition.xyz);d=vTexCoord+uUVOffset;}","bloom.glsl":"precision mediump float;uniform sampler2D tInput;uniform vec4 uKernel[BLOOM_SAMPLES];varying highp vec2 j;void main(void){vec3 c=vec3(0.0,0.0,0.0);for(int k=0;k<BLOOM_SAMPLES;++k){vec3 l=uKernel[k].xyz;vec3 m=texture2D(tInput,j+l.xy).xyz;m=max(m,vec3(0.0,0.0,0.0));c+=m*l.z;}gl_FragColor.xyz=c;gl_FragColor.w=0.0;}","bloomshrink.glsl":"precision highp float;uniform sampler2D tInput;varying highp vec2 j;void main(void){float o=0.25/256.0;gl_FragColor=0.25*(texture2D(tInput,j+vec2(o,o))+texture2D(tInput,j+vec2(o,-o))+texture2D(tInput,j+vec2(-o,o))+texture2D(tInput,j+vec2(-o,-o)));}","fogfrag.glsl":"precision highp float;uniform sampler2D tDepth;uniform vec3 uDepthToZ;uniform vec4 uUnproject;uniform mat4 uInvViewMatrix;uniform float uFogInvDistance;uniform float uFogOpacity;uniform float uFogDispersion;uniform vec3 uFogType;uniform vec3 uFogColor;uniform float uFogIllum;uniform mat4 uLightMatrix;\n#ifdef FOG_IBL\nuniform vec4 uFogLightSphere[9];\n#else\nuniform vec4 uSpotParams;uniform vec4 uLightPosition;uniform vec3 uLightColor;uniform vec4 uLightAttenuation;\n#ifdef FOG_SHADOWS\nuniform mat4 uShadowProj;uniform sampler2D uShadowMap;uniform float uDitherOffset;uniform vec4 uCylinder;\n#endif\n#endif\nvec4 h(mat4 i,vec3 p){return i[0]*p.x+(i[1]*p.y+(i[2]*p.z+i[3]));}vec3 u(mat4 i,vec3 v){return i[0].xyz*v.x+i[1].xyz*v.y+i[2].xyz*v.z;}float A(float B){B*=uFogInvDistance;float C=uFogType.x*min(B,1.0)+(uFogType.y-uFogType.y/(1.0+16.0*B*B))+(uFogType.z-uFogType.z*exp(-3.0*B));return C*uFogOpacity;}\n#ifdef FOG_SHADOWS\nfloat D(vec3 E){vec4 p=h(uShadowProj,E);vec3 F=p.xyz/p.w;vec4 G=texture2D(uShadowMap,F.xy);float H=(G.x+G.y*(1.0/255.0))+G.z*(1.0/65025.0);return F.z<H || H>=1.0?1.0:0.0;}float f(vec2 I){return fract(sin(dot(I,vec2(12.9898,78.233)))*43758.5453+uDitherOffset);}void J(vec3 K,vec3 L,out float M,out float N){vec3 v=uSpotParams.xyz,p=uCylinder.xyz;vec3 O=L-dot(L,v)*v;vec3 P=(K-p)-dot(K-p,v)*v;float a=dot(O,O);float b=2.0*dot(O,P);float c=dot(P,P)-uCylinder.w;float Q=b*b-4.0*a*c;if(Q>=0.0){Q=sqrt(Q);M=(-b-Q)/(2.0*a);N=(-b+Q)/(2.0*a);}else {M=N=0.0;}}\n#endif\nvarying vec2 j;void main(void){vec3 R=uInvViewMatrix[3].xyz;float H=texture2D(tDepth,j).x;H=min(H,0.9999);vec3 S;S.z=uDepthToZ.y/(uDepthToZ.z*H+uDepthToZ.x);S.xy=S.z*(j*uUnproject.xy+uUnproject.zw);S=h(uInvViewMatrix,S).xyz;vec3 T;T.xy=(j*uUnproject.xy+uUnproject.zw);T.z=1.0;T=normalize(u(uInvViewMatrix,-T).xyz);vec3 U=uFogColor;\n#if defined(FOG_IBL)\nvec3 G=u(uLightMatrix,T);vec3 V=uFogLightSphere[0].xyz;V+=uFogLightSphere[1].xyz*G.y;V+=uFogLightSphere[2].xyz*G.z;V+=uFogLightSphere[3].xyz*G.x;vec3 swz=G.yyz*G.xzx;V+=uFogLightSphere[4].xyz*swz.x;V+=uFogLightSphere[5].xyz*swz.y;V+=uFogLightSphere[7].xyz*swz.z;vec3 sqr=G*G;V+=uFogLightSphere[6].xyz*(3.0*sqr.z-1.0);V+=uFogLightSphere[8].xyz*(sqr.x-sqr.y);U=mix(U,U*V,uFogIllum);float C=A(length(S-R));gl_FragColor.xyz=U*C;gl_FragColor.w=C;return;\n#else\n#if defined(FOG_SPOT) || defined(FOG_OMNI)\nfloat W=0.0,X=0.0;{float r=1.0/(uLightAttenuation.z);float a=1.0;float b=2.0*dot(T,R-uLightPosition.xyz);float c=dot(uLightPosition.xyz,uLightPosition.xyz)+dot(R,R)+-2.0*dot(uLightPosition.xyz,R)+-r*r;float Q=b*b-4.0*a*c;if(Q>=0.0){Q=sqrt(Q);W=(-b-Q)/(2.0*a);X=(-b+Q)/(2.0*a);}}\n#if defined(FOG_SPOT)\n{float Y=uSpotParams.w,Z=1.0-Y;vec3 v=T;vec3 dc=uSpotParams.xyz;vec3 dd=R-uLightPosition.xyz;vec3 de=v-dot(v,dc)*dc,df=dd-dot(dd,dc)*dc;float a=Y*dot(de,de)-Z*dot(v,dc)*dot(v,dc);float b=2.0*Y*dot(de,df)-2.0*Z*dot(v,dc)*dot(dd,dc);float c=Y*dot(df,df)-Z*dot(dd,dc)*dot(dd,dc);float Q=b*b-4.0*a*c;if(Q>=0.0){float dh=(-b-sqrt(Q))/(2.0*a);float di=(-b+sqrt(Q))/(2.0*a);if(di<dh){float de=dh;dh=di;di=de;}bool dj=dot(-uLightPosition.xyz+R+T*dh,uSpotParams.xyz)<=0.0;bool dk=dot(-uLightPosition.xyz+R+T*di,uSpotParams.xyz)<=0.0;if(!dj ||!dk){if(dj){dh=di;di=X;}else if(dk){di=dh;dh=W;}W=max(W,dh);X=min(X,di);}else {X=W=0.0;}}else {X=W=0.0;}}\n#endif\nfloat tx=dot(T,S-R);W=clamp(W,0.0,tx);X=clamp(X,0.0,tx);float dl=0.0;if(X>W){\n#ifdef FOG_SHADOWS\n#ifdef MOBILE\n#define SAMPLES 16\n#else\n#define SAMPLES 32\n#endif\nfloat dm=f(j)*(X-W)/float(SAMPLES-2);\n#else\n#define SAMPLES 8\nfloat dm=0.0;\n#endif\nfor(int k=0;k<SAMPLES;++k){float t=W+(X-W)*float(k)/float(SAMPLES-1);vec3 p=R+(t+dm)*T;float a=clamp(length(p-uLightPosition.xyz)*uLightAttenuation.z,0.0,1.0);a=1.0+uLightAttenuation.x*a+uLightAttenuation.y*a*a;\n#ifdef FOG_SHADOWS\na*=D(p);\n#endif\ndl+=a-a*A(t);}dl*=1.0/float(SAMPLES);dl*=(X-W)*uLightAttenuation.z;dl*=A(X-W);}U*=dl*uFogIllum;\n#elif defined(FOG_DIR)\nfloat C=A(dot(T,S-R));\n#ifdef FOG_SHADOWS\nfloat W,X;J(R,T,W,X);float tx=dot(T,S-R);W=clamp(W,0.0,tx);X=clamp(X,0.0,tx);if(X>W){\n#ifdef MOBILE\n#define SAMPLES 16\n#else\n#define SAMPLES 32\n#endif\nfloat dl=0.0;float dm=f(j)*(X-W)/float(SAMPLES-2);float dn=(X-W)*(1.0/float(SAMPLES));for(int k=0;k<SAMPLES;++k){float t=W+float(k)*dn+dm;vec3 p=R+t*T;float s=D(p);C-=(1.0-s)*(A(t+dn)-A(t));}}\n#endif\nfloat du=0.5+0.5*dot(T,-uSpotParams.xyz);du=1.0+uFogDispersion*(2.0*du*du-1.0);U*=(0.1*C)*(du*uFogIllum);\n#endif\ngl_FragColor.xyz=U*uLightColor;gl_FragColor.w=0.0;\n#endif\n}","fogvert.glsl":"precision highp float;attribute vec2 vCoord;varying vec2 j;void main(void){j=vCoord;gl_Position.xy=2.0*vCoord-vec2(1.0,1.0);gl_Position.zw=vec2(0.0,1.0);}","matdither.glsl":"float f(highp float I){highp float G=0.5*fract(gl_FragCoord.x*0.5)+0.5*fract(gl_FragCoord.y*0.5);return 0.4+0.6*fract(G+3.141592e6*I);}","matfrag.glsl":"\n#extension GL_OES_standard_derivatives : enable\nprecision mediump float;varying highp vec3 dv;varying mediump vec2 d;varying mediump vec3 dA;varying mediump vec3 dB;varying mediump vec3 dC;\n#ifdef VERTEX_COLOR\nvarying lowp vec4 dD;\n#endif\n#ifdef TEXCOORD_SECONDARY\nvarying mediump vec2 dE;\n#endif\nuniform sampler2D tAlbedo;uniform sampler2D tReflectivity;uniform sampler2D tNormal;uniform sampler2D tExtras;uniform sampler2D tSkySpecular;\n#ifdef REFRACTION\nuniform sampler2D tRefraction;\n#endif\nuniform vec4 uDiffuseCoefficients[9];uniform vec3 uCameraPosition;uniform float uAlphaTest;uniform vec3 uFresnel;uniform float uHorizonOcclude;uniform float uHorizonSmoothing;\n#ifdef EMISSIVE\nuniform float uEmissiveScale;uniform vec4 uTexRangeEmissive;\n#endif\n#ifdef AMBIENT_OCCLUSION\nuniform vec4 uTexRangeAO;\n#endif\n#ifdef REFRACTION\nuniform float uRefractionIOREntry;uniform float uRefractionRayDistance;uniform vec3 uRefractionTint;uniform float uRefractionAlbedoTint;uniform mat4 uRefractionViewProjection;uniform vec4 uTexRangeRefraction;\n#endif\n#ifdef LIGHT_COUNT\nuniform vec4 uLightPositions[LIGHT_COUNT];uniform vec3 uLightDirections[LIGHT_COUNT];uniform vec3 uLightColors[LIGHT_COUNT];uniform vec3 uLightParams[LIGHT_COUNT];uniform vec3 uLightSpot[LIGHT_COUNT];\n#endif\n#ifdef ANISO\nuniform float uAnisoStrength;uniform vec3 uAnisoTangent;uniform float uAnisoIntegral;uniform vec4 uTexRangeAniso;\n#endif\n#define saturate(x) clamp( x, 0.0, 1.0 )\n#include <matsampling.glsl>\n#include <matlighting.glsl>\n#include <matshadows.glsl>\n#include <matskin.glsl>\n#include <matmicrofiber.glsl>\n#include <matstrips.glsl>\n#ifdef TRANSPARENCY_DITHER\n#include <matdither.glsl>\n#endif\nvoid main(void){vec4 m=texture2D(tAlbedo,d);vec3 dF=dG(m.xyz);float e=m.w;\n#ifdef VERTEX_COLOR\n{vec3 dH=dD.xyz;\n#ifdef VERTEX_COLOR_SRGB\ndH=dH*(dH*(dH*0.305306011+vec3(0.682171111))+vec3(0.012522878));\n#endif\ndF*=dH;\n#ifdef VERTEX_COLOR_ALPHA\ne*=dD.w;\n#endif\n}\n#endif\n#ifdef ALPHA_TEST\nif(e<uAlphaTest){discard;}\n#endif\n#ifdef TRANSPARENCY_DITHER\ne=(e>f(d.x))?1.0:e;\n#endif\nvec3 dI=dJ(texture2D(tNormal,d).xyz);\n#ifdef ANISO\n#ifdef ANISO_NO_DIR_TEX\nvec3 dK=dL(uAnisoTangent);\n#else\nm=dM(d,uTexRangeAniso);vec3 dK=2.0*m.xyz-vec3(1.0);dK=dL(dK);\n#endif\ndK=dK-dI*dot(dK,dI);dK=normalize(dK);vec3 dN=dK*uAnisoStrength;\n#endif\nvec3 dO=normalize(uCameraPosition-dv);m=texture2D(tReflectivity,d);vec3 dP=dG(m.xyz);float dQ=m.w;float dR=dQ;\n#ifdef HORIZON_SMOOTHING\nfloat dS=dot(dO,dI);dS=uHorizonSmoothing-dS*uHorizonSmoothing;dQ=mix(dQ,1.0,dS*dS);\n#endif\n#ifdef STRIPVIEW\ndT dU;dV(dU,dQ,dP);\n#endif\nfloat dW=1.0;\n#ifdef AMBIENT_OCCLUSION\n#ifdef AMBIENT_OCCLUSION_SECONDARY_UV\ndW=dM(dE,uTexRangeAO).x;\n#else\ndW=dM(d,uTexRangeAO).x;\n#endif\ndW*=dW;\n#endif\n#if defined(SKIN)\ndX dY;dZ(dY);dY.ec*=dW;\n#elif defined(MICROFIBER)\ned ee;ef(ee,dI);ee.eh*=dW;\n#else\nvec3 ei=ej(dI);ei*=dW;\n#endif\nvec3 ek=reflect(-dO,dI);\n#ifdef ANISO\nvec3 rt=ek-(0.5*dN*dot(ek,dK));vec3 el=em(rt,mix(dQ,0.5*dQ,uAnisoStrength));\n#else\nvec3 el=em(ek,dQ);\n#endif\nel*=en(ek,dC);\n#ifdef LIGHT_COUNT\nhighp float eo=10.0/log2(dQ*0.968+0.03);eo*=eo;float eu=eo*(1.0/(8.0*3.1415926))+(4.0/(8.0*3.1415926));eu=min(eu,1.0e3);\n#ifdef SHADOW_COUNT\nev eA;\n#ifdef SKIN\n#ifdef SKIN_VERSION_1\neB(eA,SHADOW_KERNEL+SHADOW_KERNEL*dY.eC);\n#else\neD eE;float eF=SHADOW_KERNEL+SHADOW_KERNEL*dY.eC;eG(eE,eF);eB(eA,eF);\n#endif\n#else\neB(eA,SHADOW_KERNEL);\n#endif\n#endif\n#ifdef ANISO\neu*=uAnisoIntegral;\n#endif\nfor(int k=0;k<LIGHT_COUNT;++k){vec3 eH=uLightPositions[k].xyz-dv*uLightPositions[k].w;float eI=inversesqrt(dot(eH,eH));eH*=eI;float a=saturate(uLightParams[k].z/eI);a=1.0+a*(uLightParams[k].x+uLightParams[k].y*a);float s=saturate(dot(eH,uLightDirections[k]));s=saturate(uLightSpot[k].y-uLightSpot[k].z*(1.0-s*s));vec3 eJ=(a*s)*uLightColors[k].xyz;\n#if defined(SKIN)\n#ifdef SHADOW_COUNT\n#ifdef SKIN_VERSION_1\neK(dY,eA.eL[k],1.0,eH,dI,eJ);\n#else\neK(dY,eA.eL[k],eE.eE[k],eH,dI,eJ);\n#endif\n#else\neK(dY,1.0,0.0,eH,dI,eJ);\n#endif\n#elif defined(MICROFIBER)\n#ifdef SHADOW_COUNT\neM(ee,eA.eL[k],eH,dI,eJ);\n#else\neM(ee,1.0,eH,dI,eJ);\n#endif\n#else\nfloat eN=saturate((1.0/3.1415926)*dot(eH,dI));\n#ifdef SHADOW_COUNT\neN*=eA.eL[k];\n#endif\nei+=eN*eJ;\n#endif\nvec3 eO=eH+dO;\n#ifdef ANISO\neO=eO-(dN*dot(eO,dK));\n#endif\neO=normalize(eO);float eP=eu*pow(saturate(dot(eO,dI)),eo);\n#ifdef SHADOW_COUNT\neP*=eA.eL[k];\n#endif\nel+=eP*eJ;}\n#endif\n#if defined(SKIN)\nvec3 ei,diff_extra;eQ(ei,diff_extra,dY,dO,dI,dQ);\n#elif defined(MICROFIBER)\nvec3 ei,diff_extra;eR(ei,diff_extra,ee,dO,dI,dQ);\n#endif\nvec3 eS=eT(dO,dI,dP,dQ*dQ);el*=eS;\n#ifdef REFRACTION\nvec4 eU;{vec3 G=refract(-dO,dI,uRefractionIOREntry);G=dv+G*uRefractionRayDistance;vec4 eV=uRefractionViewProjection[0]*G.x+(uRefractionViewProjection[1]*G.y+(uRefractionViewProjection[2]*G.z+uRefractionViewProjection[3]));vec2 c=eV.xy/eV.w;c=0.5*c+vec2(0.5,0.5);vec2 i=mod(floor(c),2.0);c=fract(c);c.x=i.x>0.0?1.0-c.x:c.x;c.y=i.y>0.0?1.0-c.y:c.y;eU.rgb=texture2D(tRefraction,c).xyz;eU.rgb=mix(eU.rgb,eU.rgb*dF,uRefractionAlbedoTint);eU.rgb=eU.rgb-eU.rgb*eS;eU.rgb*=uRefractionTint;\n#ifdef REFRACTION_NO_MASK_TEX\neU.a=1.0;\n#else\neU.a=dM(d,uTexRangeRefraction).x;\n#endif\n}\n#endif\n#ifdef DIFFUSE_UNLIT\ngl_FragColor.xyz=dF;\n#else\ngl_FragColor.xyz=ei*dF;\n#endif\n#ifdef REFRACTION\ngl_FragColor.xyz=mix(gl_FragColor.xyz,eU.rgb,eU.a);\n#endif\ngl_FragColor.xyz+=el;\n#if defined(SKIN) || defined(MICROFIBER)\ngl_FragColor.xyz+=diff_extra;\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVE_SECONDARY_UV\nvec2 eW=dE;\n#else\nvec2 eW=d;\n#endif\ngl_FragColor.xyz+=uEmissiveScale*dG(dM(eW,uTexRangeEmissive).xyz);\n#endif\n#ifdef STRIPVIEW\ngl_FragColor.xyz=eX(dU,dI,dF,dP,dR,ei,el,gl_FragColor.xyz);\n#endif\n#ifdef NOBLEND\ngl_FragColor.w=1.0;\n#else\ngl_FragColor.w=e;\n#endif\n}","matlighting.glsl":"vec3 eY(vec3 eZ,float fc){return exp(-0.5*fc/(eZ*eZ))/(eZ*2.5066283);}vec3 fd(vec3 eZ){return vec3(1.0,1.0,1.0)/(eZ*2.5066283);}vec3 fe(vec3 ff){return vec3(-0.5,-0.5,-0.5)/(ff);}vec3 fh(vec3 fi,float fc){return exp(fi*fc);}\n#define SAMPLE_COUNT 21.0\n#define SAMPLE_HALF 10.0\n#define GAUSS_SPREAD 0.05\nvec3 fj(float fk,float fl,vec3 fm){vec3 fn=vec3(fl,fl,fl);fn=0.8*fn+vec3(0.2);vec3 fo=cos(fn*3.14159);vec3 fu=cos(fn*3.14159*0.5);fu*=fu;fu*=fu;fu*=fu;fn=fn+0.05*fo*fu*fm;fu*=fu;fu*=fu;fu*=fu;fn=fn+0.1*fo*fu*fm;fn=saturate(fn);fn*=fn*1.2;return fn;}vec3 fv(vec3 fm){return vec3(1.0,1.0,1.0)/3.1415926;}float fA(float fk,float fm){return saturate(-fk*fm+fk+fm);}vec3 fB(float fk,vec3 fm){return saturate(-fk*fm+vec3(fk)+fm);}float fC(float fm){return-0.31830988618379*fm+0.31830988618379;}vec3 fD(vec3 fm){return-0.31830988618379*fm+vec3(0.31830988618379);}vec3 eT(vec3 dO,vec3 dI,vec3 dP,float fE){float C=1.0-saturate(dot(dO,dI));float fF=C*C;C*=fF*fF;C*=fE;return(dP-C*dP)+C*uFresnel;}vec2 fG(vec2 fH,vec2 fm){fH=1.0-fH;vec2 fI=fH*fH;fI*=fI;fH=mix(fI,fH*0.4,fm);return fH;}vec3 ej(vec3 fJ){\n#define c(n) uDiffuseCoefficients[n].xyz\nvec3 G=(c(0)+fJ.y*((c(1)+c(4)*fJ.x)+c(5)*fJ.z))+fJ.x*(c(3)+c(7)*fJ.z)+c(2)*fJ.z;\n#undef c\nvec3 sqr=fJ*fJ;G+=uDiffuseCoefficients[6].xyz*(3.0*sqr.z-1.0);G+=uDiffuseCoefficients[8].xyz*(sqr.x-sqr.y);return G;}void fK(inout vec3 fL,inout vec3 fM,inout vec3 fN,vec3 fJ){fL=uDiffuseCoefficients[0].xyz;fM=uDiffuseCoefficients[1].xyz*fJ.y;fM+=uDiffuseCoefficients[2].xyz*fJ.z;fM+=uDiffuseCoefficients[3].xyz*fJ.x;vec3 swz=fJ.yyz*fJ.xzx;fN=uDiffuseCoefficients[4].xyz*swz.x;fN+=uDiffuseCoefficients[5].xyz*swz.y;fN+=uDiffuseCoefficients[7].xyz*swz.z;vec3 sqr=fJ*fJ;fN+=uDiffuseCoefficients[6].xyz*(3.0*sqr.z-1.0);fN+=uDiffuseCoefficients[8].xyz*(sqr.x-sqr.y);}vec3 fO(vec3 fL,vec3 fM,vec3 fN,vec3 fP,float fm){fP=mix(vec3(1.0),fP,fm);return(fL+fM*fP.x)+fN*fP.z;}vec3 fQ(vec3 fL,vec3 fM,vec3 fN,vec3 fP,vec3 fR){vec3 fS=mix(vec3(1.0),fP.yyy,fR);vec3 fT=mix(vec3(1.0),fP.zzz,fR);return(fL+fM*fS)+fN*fT;}vec3 em(vec3 fJ,float dQ){fJ/=dot(vec3(1.0),abs(fJ));vec2 fU=abs(fJ.zx)-vec2(1.0,1.0);vec2 fV=vec2(fJ.x<0.0?fU.x:-fU.x,fJ.z<0.0?fU.y:-fU.y);vec2 fW=(fJ.y<0.0)?fV:fJ.xz;fW=vec2(0.5*(254.0/256.0),0.125*0.5*(254.0/256.0))*fW+vec2(0.5,0.125*0.5);float fX=fract(7.0*dQ);fW.y+=0.125*(7.0*dQ-fX);vec2 fY=fW+vec2(0.0,0.125);vec4 fZ=mix(texture2D(tSkySpecular,fW),texture2D(tSkySpecular,fY),fX);vec3 r=fZ.xyz*(7.0*fZ.w);return r*r;}float en(vec3 fJ,vec3 hc){float hd=dot(fJ,hc);hd=saturate(1.0+uHorizonOcclude*hd);return hd*hd;}","matmicrofiber.glsl":"\n#ifdef MICROFIBER\nuniform vec4 uTexRangeFuzz;uniform vec4 uFresnelColor;uniform float uFresnelIntegral;uniform float uFresnelOcc;uniform float uFresnelGlossMask;struct ed{vec3 eh;vec3 eN;vec3 he;vec3 hf;vec3 hh;};void ef(out ed s,vec3 dI){s.eh=s.eN=ej(dI);s.he=vec3(0.0);s.hf=uFresnelColor.rgb;s.hh=uFresnelColor.aaa*vec3(1.0,0.5,0.25);\n#ifndef MICROFIBER_NO_FUZZ_TEX\nvec4 m=dM(d,uTexRangeFuzz);s.hf*=dG(m.rgb);\n#endif\n}void eM(inout ed s,float hi,vec3 eH,vec3 dI,vec3 eJ){float fk=dot(eH,dI);float eN=saturate((1.0/3.1415926)*fk);float hj=fA(fk,s.hh.z);\n#ifdef SHADOW_COUNT\neN*=hi;float hk=mix(1.0,hi,uFresnelOcc);float he=hj*hk;\n#else \nfloat he=hj;\n#endif\ns.he=he*eJ+s.he;s.eN=eN*eJ+s.eN;}void eR(out vec3 ei,out vec3 diff_extra,inout ed s,vec3 dO,vec3 dI,float dQ){s.he*=uFresnelIntegral;float fH=dot(dO,dI);vec2 hl=fG(vec2(fH,fH),s.hh.xy);s.he=s.eh*hl.x+(s.he*hl.y);s.he*=s.hf;float hm=saturate(1.0+-uFresnelGlossMask*dQ);s.he*=hm*hm;ei=s.eN;diff_extra=s.he;}\n#endif\n","matsampling.glsl":"vec3 dG(vec3 c){return c*c;}vec3 dJ(vec3 n){vec3 hn=dA;vec3 ho=dB;vec3 hu=gl_FrontFacing?dC:-dC;\n#ifdef TSPACE_RENORMALIZE\nhu=normalize(hu);\n#endif\n#ifdef TSPACE_ORTHOGONALIZE\nhn-=dot(hn,hu)*hu;\n#endif\n#ifdef TSPACE_RENORMALIZE\nhn=normalize(hn);\n#endif\n#ifdef TSPACE_ORTHOGONALIZE\nho=(ho-dot(ho,hu)*hu)-dot(ho,hn)*hn;\n#endif\n#ifdef TSPACE_RENORMALIZE\nho=normalize(ho);\n#endif\n#ifdef TSPACE_COMPUTE_BITANGENT\nvec3 hv=cross(hu,hn);ho=dot(hv,ho)<0.0?-hv:hv;\n#endif\nn=2.0*n-vec3(1.0);return normalize(hn*n.x+ho*n.y+hu*n.z);}vec3 dL(vec3 t){vec3 hu=gl_FrontFacing?dC:-dC;return normalize(dA*t.x+dB*t.y+hu*t.z);}vec4 dM(vec2 hA,vec4 hB){\n#if GL_OES_standard_derivatives\nvec2 hC=fract(hA);vec2 hD=fwidth(hC);float hE=(hD.x+hD.y)>0.5?-6.0:0.0;return texture2D(tExtras,hC*hB.xy+hB.zw,hE);\n#else\nreturn texture2D(tExtras,fract(hA)*hB.xy+hB.zw);\n#endif\n}vec3 hF(sampler2D hG,vec2 hH,float hI){vec3 n=texture2D(hG,hH,hI*2.5).xyz;return dJ(n);}","matshadows.glsl":"\n#ifdef SHADOW_COUNT\n#ifdef MOBILE\n#define SHADOW_KERNEL (4.0/1536.0)\n#else\n#define SHADOW_KERNEL (4.0/2048.0)\n#endif\nhighp vec4 h(highp mat4 i,highp vec3 p){return i[0]*p.x+(i[1]*p.y+(i[2]*p.z+i[3]));}uniform sampler2D tDepth0;\n#if SHADOW_COUNT > 1\nuniform sampler2D tDepth1;\n#if SHADOW_COUNT > 2\nuniform sampler2D tDepth2;\n#endif\n#endif\nuniform highp vec2 uShadowKernelRotation;uniform highp vec2 uShadowMapSize;uniform highp mat4 uShadowMatrices[SHADOW_COUNT];uniform highp vec4 uShadowTexelPadProjections[SHADOW_COUNT];\n#ifndef MOBILE\nuniform highp mat4 uInvShadowMatrices[SHADOW_COUNT];\n#endif\nhighp float hJ(highp vec3 G){\n#ifdef SHADOW_NATIVE_DEPTH\nreturn G.x;\n#else\nreturn(G.x+G.y*(1.0/255.0))+G.z*(1.0/65025.0);\n#endif\n}\n#ifndef SHADOW_COMPARE\n#define SHADOW_COMPARE(a,b) ((a) < (b) ? 1.0 : 0.0)\n#endif\n#ifndef SHADOW_CLIP\n#define SHADOW_CLIP(c,v) v\n#endif\nfloat hK(sampler2D hL,highp vec2 hA,highp float H){\n#ifndef MOBILE\nhighp vec2 c=hA*uShadowMapSize.x;highp vec2 a=floor(c)*uShadowMapSize.y,b=ceil(c)*uShadowMapSize.y;highp vec4 eE;eE.x=hJ(texture2D(hL,a).xyz);eE.y=hJ(texture2D(hL,vec2(b.x,a.y)).xyz);eE.z=hJ(texture2D(hL,vec2(a.x,b.y)).xyz);eE.w=hJ(texture2D(hL,b).xyz);highp vec4 hM;hM.x=SHADOW_COMPARE(H,eE.x);hM.y=SHADOW_COMPARE(H,eE.y);hM.z=SHADOW_COMPARE(H,eE.z);hM.w=SHADOW_COMPARE(H,eE.w);highp vec2 w=c-a*uShadowMapSize.x;vec2 s=(w.y*hM.zw+hM.xy)-w.y*hM.xy;return(w.x*s.y+s.x)-w.x*s.x;\n#else\nhighp float G=hJ(texture2D(hL,hA.xy).xyz);return SHADOW_COMPARE(H,G);\n#endif\n}highp float hN(sampler2D hL,highp vec3 hA,float hO){highp vec2 l=uShadowKernelRotation*hO;float s;s=hK(hL,hA.xy+l,hA.z);s+=hK(hL,hA.xy-l,hA.z);s+=hK(hL,hA.xy+vec2(-l.y,l.x),hA.z);s+=hK(hL,hA.xy+vec2(l.y,-l.x),hA.z);s*=0.25;return s*s;}struct ev{float eL[LIGHT_COUNT];};void eB(out ev ss,float hO){highp vec3 hP[SHADOW_COUNT];vec3 hu=gl_FrontFacing?dC:-dC;for(int k=0;k<SHADOW_COUNT;++k){vec4 hQ=uShadowTexelPadProjections[k];float hR=hQ.x*dv.x+(hQ.y*dv.y+(hQ.z*dv.z+hQ.w));\n#ifdef MOBILE\nhR*=.001+hO;\n#else\nhR*=.0005+0.5*hO;\n#endif\nhighp vec4 hS=h(uShadowMatrices[k],dv+hR*hu);hP[k]=hS.xyz/hS.w;}float m;\n#if SHADOW_COUNT > 0\nm=hN(tDepth0,hP[0],hO);ss.eL[0]=SHADOW_CLIP(hP[0].xy,m);\n#endif\n#if SHADOW_COUNT > 1\nm=hN(tDepth1,hP[1],hO);ss.eL[1]=SHADOW_CLIP(hP[1].xy,m);\n#endif\n#if SHADOW_COUNT > 2\nm=hN(tDepth2,hP[2],hO);ss.eL[2]=SHADOW_CLIP(hP[2].xy,m);\n#endif\nfor(int k=SHADOW_COUNT;k<LIGHT_COUNT;++k){ss.eL[k]=1.0;}}struct eD{highp float eE[LIGHT_COUNT];};\n#ifdef MOBILE\nvoid eG(out eD ss,float hO){for(int k=0;k<LIGHT_COUNT;++k){ss.eE[k]=1.0;}}\n#else\nhighp vec4 hT(sampler2D hL,highp vec2 hA,highp mat4 hU){highp vec4 E;E.xy=hA;\n#ifndef MOBILE\nhighp vec2 c=hA*uShadowMapSize.x;highp vec2 a=floor(c)*uShadowMapSize.y,b=ceil(c)*uShadowMapSize.y;highp vec4 hM;hM.x=hJ(texture2D(hL,a).xyz);hM.y=hJ(texture2D(hL,vec2(b.x,a.y)).xyz);hM.z=hJ(texture2D(hL,vec2(a.x,b.y)).xyz);hM.w=hJ(texture2D(hL,b).xyz);highp vec2 w=c-a*uShadowMapSize.x;vec2 s=(w.y*hM.zw+hM.xy)-w.y*hM.xy;E.z=(w.x*s.y+s.x)-w.x*s.x;\n#else \nE.z=hJ(texture2D(hL,hA.xy).xyz);\n#endif\nE=h(hU,E.xyz);E.xyz/=E.w;return E;}void eG(out eD ss,float hO){highp vec3 hV[SHADOW_COUNT];vec3 hu=gl_FrontFacing?dC:-dC;hu*=0.6;for(int k=0;k<SHADOW_COUNT;++k){vec4 hQ=uShadowTexelPadProjections[k];float hR=hQ.x*dv.x+(hQ.y*dv.y+(hQ.z*dv.z+hQ.w));\n#ifdef MOBILE\nhR*=.001+hO;\n#else\nhR*=.0005+0.5*hO;\n#endif\nhighp vec4 hS=h(uShadowMatrices[k],dv-hR*hu);hV[k]=hS.xyz/hS.w;}highp vec4 hW;\n#if SHADOW_COUNT > 0\nhW=hT(tDepth0,hV[0].xy,uInvShadowMatrices[0]);ss.eE[0]=length(dv.xyz-hW.xyz);\n#endif\n#if SHADOW_COUNT > 1\nhW=hT(tDepth1,hV[1].xy,uInvShadowMatrices[1]);ss.eE[1]=length(dv.xyz-hW.xyz);\n#endif\n#if SHADOW_COUNT > 2\nhW=hT(tDepth2,hV[2].xy,uInvShadowMatrices[2]);ss.eE[2]=length(dv.xyz-hW.xyz);\n#endif\nfor(int k=SHADOW_COUNT;k<LIGHT_COUNT;++k){ss.eE[k]=1.0;}}\n#endif\n#endif\n","matskin.glsl":"\n#ifdef SKIN\n#ifndef SKIN_NO_SUBDERMIS_TEX\nuniform vec4 uTexRangeSubdermis;\n#endif\n#ifndef SKIN_NO_TRANSLUCENCY_TEX\nuniform vec4 uTexRangeTranslucency;\n#endif\n#ifndef SKIN_NO_FUZZ_TEX\nuniform vec4 uTexRangeFuzz;\n#endif\nuniform vec4 uTransColor;uniform vec4 uFresnelColor;uniform vec3 uSubdermisColor;uniform float uTransScatter;uniform float uFresnelOcc;uniform float uFresnelGlossMask;uniform float uTransSky;uniform float uFresnelIntegral;uniform float uTransIntegral;uniform float uSkinTransDepth;uniform float uSkinShadowBlur;uniform float uNormalSmooth;struct dX{vec3 hX;vec3 hY,hZ,ic,he;vec3 ec,eh,id;vec3 ie;vec3 ih;vec3 ii;vec3 ij;float ik;float il;float im;float eC;};void dZ(out dX s){vec4 m;\n#ifdef SKIN_NO_SUBDERMIS_TEX\ns.hX=uSubdermisColor;s.im=1.0;\n#else \nm=dM(d,uTexRangeSubdermis);s.hX=dG(m.xyz);s.im=m.w*m.w;\n#endif\ns.ij=uTransColor.rgb;s.ik=uTransScatter;\n#ifdef SKIN_VERSION_1\ns.eC=uSkinShadowBlur*s.im;\n#else \ns.il=max(max(s.ij.r,s.ij.g),s.ij.b)*uTransColor.a;float io=max(s.hX.r,max(s.hX.g,s.hX.b));io=1.0-io;io*=io;io*=io;io*=io;io=1.0-(io*io);s.im*=io;s.eC=uSkinShadowBlur*s.im*dot(s.hX.rgb,vec3(0.333,0.334,0.333));\n#endif\n#ifndef SKIN_NO_TRANSLUCENCY_TEX\nm=dM(d,uTexRangeTranslucency);s.ij*=dG(m.xyz);\n#endif\ns.ie=hF(tNormal,d,uNormalSmooth*s.im);vec3 iu,iv,iA;fK(iu,iv,iA,s.ie);s.eh=s.hY=iu+iv+iA;\n#ifdef SKIN_VERSION_1 \ns.ec=fQ(iu,iv,iA,vec3(1.0,0.6667,0.25),s.hX);\n#else\ns.ec=fQ(iu,iv,iA,vec3(1.0,0.6667,0.25),s.hX*0.2+vec3(0.1));\n#endif\n#ifdef SKIN_VERSION_1\nvec3 iB,iC,iD;fK(iB,iC,iD,-s.ie);s.id=fO(iB,iC,iD,vec3(1.0,0.4444,0.0625),s.ik);s.id*=uTransSky;\n#else \ns.id=vec3(0.0);\n#endif\ns.hZ=s.ic=s.he=vec3(0.0);s.hX*=0.5;s.ik*=0.5;s.ih=uFresnelColor.rgb;s.ii=uFresnelColor.aaa*vec3(1.0,0.5,0.25);\n#ifndef SKIN_NO_FUZZ_TEX\nm=dM(d,uTexRangeFuzz);s.ih*=dG(m.rgb);\n#endif\n}void eK(inout dX s,float iE,float iF,vec3 eH,vec3 dI,vec3 eJ){float fk=dot(eH,dI);float fl=dot(eH,s.ie);float eN=saturate((1.0/3.1415926)*fk);float hi=iE*iE;hi*=hi;hi=saturate(6.0*hi);\n#ifdef SKIN_VERSION_1 \nvec3 iG=fB(fl,s.hX);\n#else \nvec3 iG=fj(fk,fl,s.hX);\n#endif\nfloat iH=fA(-fl,s.ik);vec3 ic=vec3(iH*iH);\n#ifdef SKIN_VERSION_1\n#ifdef SHADOW_COUNT\nvec3 iI=vec3(iE);float iJ=saturate(hi-2.0*(iE*iE));iI+=iJ*s.hX;float iK=iE;\n#endif\n#else\n#ifdef SHADOW_COUNT\nvec3 iI;highp vec3 iL=(0.995*s.hX)+vec3(0.005,0.005,0.005);highp vec3 iM=vec3(1.0)-iL;iL=mix(iL,iM,iE);float iN=sqrt(iE);vec3 iO=2.0*vec3(1.0-iN);iN=1.0-iN;iN=(1.0-iN*iN);iI=saturate(pow(iL*iN,iO));highp float iP=0.35/(uSkinTransDepth+0.001);highp float iQ=saturate(iF*iP);iQ=saturate(1.0-iQ);iQ*=iQ;highp vec3 iR=vec3((-3.0*iQ)+3.15);highp vec3 iS=(0.9975*s.ij)+vec3(0.0025,0.0025,0.0025);highp float io=saturate(10.0*dot(iS,iS));vec3 iK=pow(iS*iQ,iR)*io;\n#else \nic=vec3(0.0);\n#endif\n#endif\nfloat hj=fA(fl,s.ii.z);\n#ifdef SHADOW_COUNT\nvec3 hk=mix(vec3(1.0),iI,uFresnelOcc);vec3 he=hj*hk;\n#else\nvec3 he=vec3(hj);\n#endif\n#ifdef SHADOW_COUNT\niG*=iI;eN*=hi;ic*=iK;\n#endif\ns.he=he*eJ+s.he;s.ic=ic*eJ+s.ic;s.hZ=iG*eJ+s.hZ;s.hY=eN*eJ+s.hY;}void eQ(out vec3 ei,out vec3 diff_extra,inout dX s,vec3 dO,vec3 dI,float dQ){s.he*=uFresnelIntegral;float fH=dot(dO,dI);vec2 hl=fG(vec2(fH,fH),s.ii.xy);s.he=s.eh*hl.x+(s.he*hl.y);s.he*=s.ih;float hm=saturate(1.0+-uFresnelGlossMask*dQ);s.he*=hm*hm;s.ic=s.ic*uTransIntegral;\n#ifdef SKIN_VERSION_1\ns.hZ=(s.hZ*fD(s.hX))+s.ec;\n#else\ns.hZ=(s.hZ*fv(s.hX))+s.ec;\n#endif\nei=mix(s.hY,s.hZ,s.im);\n#ifdef SKIN_VERSION_1\ns.ic=(s.ic+s.id)*s.ij;diff_extra=(s.he+s.ic)*s.im;\n#else\nei+=s.ic*s.il;diff_extra=s.he*s.im;\n#endif\n}\n#endif\n","matstrips.glsl":"\n#ifdef STRIPVIEW\nuniform float uStrips[5];uniform vec2 uStripRes;struct dT{float io[5];float bg;};void dV(out dT iT,inout float dQ,inout vec3 dP){highp vec2 hA=gl_FragCoord.xy*uStripRes-vec2(1.0,1.0);hA.x+=0.25*hA.y;iT.io[0]=step(hA.x,uStrips[0]);iT.io[1]=step(hA.x,uStrips[1]);iT.io[2]=step(hA.x,uStrips[2]);iT.io[3]=step(hA.x,uStrips[3]);iT.io[4]=step(hA.x,uStrips[4]);iT.bg=1.0-iT.io[4];iT.io[4]-=iT.io[3];iT.io[3]-=iT.io[2];iT.io[2]-=iT.io[1];iT.io[1]-=iT.io[0];bool iU=iT.io[4]>0.0;dQ=iU?0.5:dQ;dP=iU?vec3(0.1):dP;}vec3 eX(dT iT,vec3 dI,vec3 dF,vec3 dP,float dQ,vec3 ei,vec3 el,vec3 iV){return iT.io[0]*(dI*0.5+vec3(0.5))+iT.io[1]*dF+iT.io[2]*dP+vec3(iT.io[3]*dQ)+iT.io[4]*(vec3(0.12)+0.3*ei+el)+iT.bg*iV;}\n#endif\n","matvert.glsl":"precision highp float;uniform mat4 uModelViewProjectionMatrix;uniform mat4 uSkyMatrix;uniform vec2 uUVOffset;attribute vec3 vPosition;attribute vec2 vTexCoord;attribute vec2 vTangent;attribute vec2 vBitangent;attribute vec2 vNormal;\n#ifdef VERTEX_COLOR\nattribute vec4 vColor;\n#endif\n#ifdef TEXCOORD_SECONDARY\nattribute vec2 vTexCoord2;\n#endif\nvarying highp vec3 dv;varying mediump vec2 d;varying mediump vec3 dA;varying mediump vec3 dB;varying mediump vec3 dC;\n#ifdef VERTEX_COLOR\nvarying lowp vec4 dD;\n#endif\n#ifdef TEXCOORD_SECONDARY\nvarying mediump vec2 dE;\n#endif\nvec3 iW(vec2 v){bool iX=(v.y>(32767.1/65535.0));v.y=iX?(v.y-(32768.0/65535.0)):v.y;vec3 r;r.xy=(2.0*65535.0/32767.0)*v-vec2(1.0);r.z=sqrt(clamp(1.0-dot(r.xy,r.xy),0.0,1.0));r.z=iX?-r.z:r.z;return r;}vec4 h(mat4 i,vec3 p){return i[0]*p.x+(i[1]*p.y+(i[2]*p.z+i[3]));}vec3 u(mat4 i,vec3 v){return i[0].xyz*v.x+i[1].xyz*v.y+i[2].xyz*v.z;}void main(void){gl_Position=h(uModelViewProjectionMatrix,vPosition.xyz);d=vTexCoord+uUVOffset;dA=u(uSkyMatrix,iW(vTangent));dB=u(uSkyMatrix,iW(vBitangent));dC=u(uSkyMatrix,iW(vNormal));dv=h(uSkyMatrix,vPosition.xyz).xyz;\n#ifdef VERTEX_COLOR\ndD=vColor;\n#endif\n#ifdef TEXCOORD_SECONDARY\ndE=vTexCoord2;\n#endif\n}","postaa.glsl":"precision mediump float;uniform sampler2D tInput;varying vec2 j;void main(void){gl_FragColor=texture2D(tInput,j);}","postfrag.glsl":"precision mediump float;uniform sampler2D tInput;\n#ifdef BLOOM\nuniform sampler2D tBloom;\n#endif\n#ifdef GRAIN\nuniform sampler2D tGrain;\n#endif\n#ifdef COLOR_LUT\nuniform sampler2D tLUT;\n#endif\nuniform vec3 uScale;uniform vec3 uBias;uniform vec3 uSaturation;uniform vec4 uSharpenKernel;uniform vec3 uSharpness;uniform vec3 uBloomColor;uniform vec4 uVignetteAspect;uniform vec4 uVignette;uniform vec4 uGrainCoord;uniform vec2 uGrainScaleBias;varying vec2 j;vec3 iY(vec3 c){vec3 iZ=sqrt(c);return(iZ-iZ*c)+c*(0.4672*c+vec3(0.5328));}void main(void){vec4 jc=texture2D(tInput,j);vec3 c=jc.xyz;\n#ifdef SHARPEN\nvec3 hM=texture2D(tInput,j+uSharpenKernel.xy).xyz;hM+=texture2D(tInput,j-uSharpenKernel.xy).xyz;hM+=texture2D(tInput,j+uSharpenKernel.zw).xyz;hM+=texture2D(tInput,j-uSharpenKernel.zw).xyz;vec3 jd=uSharpness.x*c-uSharpness.y*hM;c+=clamp(jd,-uSharpness.z,uSharpness.z);\n#endif\n#ifdef BLOOM\nc+=uBloomColor*texture2D(tBloom,j).xyz;\n#endif\n#ifdef VIGNETTE\nvec2 je=j*uVignetteAspect.xy-uVignetteAspect.zw;vec3 v=clamp(vec3(1.0,1.0,1.0)-uVignette.xyz*dot(je,je),0.0,1.0);vec3 jf=v*v;jf*=v;c*=mix(v,jf,uVignette.w);\n#endif\n#ifdef SATURATION\nfloat gray=dot(c,vec3(0.3,0.59,0.11));c=mix(vec3(gray,gray,gray),c,uSaturation);\n#endif\n#ifdef CONTRAST\nc=c*uScale+uBias;\n#endif\n#ifdef GRAIN\nfloat jh=uGrainScaleBias.x*texture2D(tGrain,j*uGrainCoord.xy+uGrainCoord.zw).x+uGrainScaleBias.y;c+=c*jh;\n#endif\n#ifdef REINHARD\n{c*=1.8;float ji=dot(c,vec3(0.3333));c=clamp(c/(1.0+ji),0.0,1.0);}\n#elif defined(HEJL)\n{const highp float jj=0.22,jk=0.3,jl=.1,jm=0.2,jn=.01,jo=0.3;const highp float ju=1.25;highp vec3 eO=max(vec3(0.0),c-vec3(.004));c=(eO*((ju*jj)*eO+ju*vec3(jl*jk,jl*jk,jl*jk))+ju*vec3(jm*jn,jm*jn,jm*jn))/(eO*(jj*eO+vec3(jk,jk,jk))+vec3(jm*jo,jm*jo,jm*jo))-ju*vec3(jn/jo,jn/jo,jn/jo);}\n#elif defined(ACES)\n{vec3 a=c*(c+0.0245786)-0.000090537;vec3 b=c*(0.983729*c+0.4329510)+0.238081;c=a/b;}\n#endif\n#ifdef COLOR_LUT\nc=clamp(c,0.0,1.0);c=(255.0/256.0)*c+vec3(0.5/256.0);c.x=texture2D(tLUT,c.xx).x;c.y=texture2D(tLUT,c.yy).y;c.z=texture2D(tLUT,c.zz).z;c*=c;\n#endif\ngl_FragColor.xyz=iY(c);gl_FragColor.w=jc.w;}","postvert.glsl":"precision highp float;attribute vec2 vCoord;varying vec2 j;void main(void){j=vCoord;gl_Position.xy=2.0*vCoord-vec2(1.0,1.0);gl_Position.zw=vec2(0.0,1.0);}","shadowfloorfrag.glsl":"precision mediump float;varying highp vec3 dv;varying mediump vec2 jv;varying mediump vec3 dC;uniform vec3 uShadowCatcherParams;\n#ifdef LIGHT_COUNT\nuniform vec4 uLightPositions[LIGHT_COUNT];uniform vec3 uLightDirections[LIGHT_COUNT];uniform vec3 uLightColors[LIGHT_COUNT];uniform vec3 uLightParams[LIGHT_COUNT];uniform vec3 uLightSpot[LIGHT_COUNT];\n#endif\n#define saturate(x) clamp( x, 0.0, 1.0 )\n#define SHADOW_COMPARE(a,b) ((a) < (b) || (b) >= 1.0 ? 1.0 : 0.0)\n#define SHADOW_CLIP(c,v) ((c.x<0.0 || c.x>1.0 || c.y<0.0 || c.y>1.0) ? 1.0 : v)\n#include <matshadows.glsl>\nvoid main(void){ev eA;eB(eA,SHADOW_KERNEL);vec3 jA=vec3(0.0,0.0,0.0);vec3 jB=vec3(0.0,0.0,0.0);for(int k=0;k<SHADOW_COUNT;++k){vec3 eH=uLightPositions[k].xyz-dv*uLightPositions[k].w;float eI=inversesqrt(dot(eH,eH));eH*=eI;float a=saturate(uLightParams[k].z/eI);a=1.0+a*(uLightParams[k].x+uLightParams[k].y*a);float s=saturate(dot(eH,uLightDirections[k]));s=saturate(uLightSpot[k].y-uLightSpot[k].z*(1.0-s*s));vec3 jC=mix(uLightColors[k].xyz,vec3(1.0,1.0,1.0),uShadowCatcherParams.x);vec3 jD=(a*s)*jC;jD*=saturate(dot(eH,dC));jB+=jD;jA+=jD*eA.eL[k];}float jE=1.0e-4;vec3 r=(jA+jE)/(jB+jE);float jF=saturate(dot(jv,jv))*uShadowCatcherParams.z;r=mix(r,vec3(1.0,1.0,1.0),jF);r=mix(vec3(1.0,1.0,1.0),r,uShadowCatcherParams.y);gl_FragColor.xyz=r;gl_FragColor.w=1.0;}","shadowfloorvert.glsl":"precision highp float;uniform mat4 uModelViewProjectionMatrix;uniform mat4 uModelSkyMatrix;uniform float uScale;attribute vec3 vPosition;varying highp vec3 dv;varying mediump vec2 jv;varying mediump vec3 dC;vec4 h(mat4 i,vec3 p){return i[0]*p.x+(i[1]*p.y+(i[2]*p.z+i[3]));}void main(void){jv=vPosition.xz;dC=normalize(uModelSkyMatrix[1].xyz);dv=h(uModelSkyMatrix,vPosition).xyz;gl_Position=h(uModelViewProjectionMatrix,vPosition);}","shadowfrag.glsl":"precision highp float;varying vec2 jG;\n#ifdef ALPHA_TEST\nvarying mediump vec2 d;uniform sampler2D tAlbedo;\n#endif\nvec3 jH(float v){vec4 jI=vec4(1.0,255.0,65025.0,16581375.0)*v;jI=fract(jI);jI.xyz-=jI.yzw*(1.0/255.0);return jI.xyz;}void main(void){\n#ifdef ALPHA_TEST\nfloat e=texture2D(tAlbedo,d).a;if(e<0.5){discard;}\n#endif\n#ifdef SHADOW_NATIVE_DEPTH\ngl_FragColor.xyz=vec3(0.0,0.0,0.0);\n#else\ngl_FragColor.xyz=jH((jG.x/jG.y)*0.5+0.5);\n#endif\ngl_FragColor.w=0.0;}","shadowvert.glsl":"precision highp float;attribute vec3 vPosition;attribute vec2 vTexCoord;uniform mat4 uMeshTransform;uniform mat4 uViewProjection;varying vec2 jG;\n#ifdef ALPHA_TEST\nvarying mediump vec2 d;uniform vec2 uUVOffset;\n#endif\nvec4 h(mat4 i,vec3 p){return i[0]*p.x+(i[1]*p.y+(i[2]*p.z+i[3]));}void main(void){vec3 p=h(uMeshTransform,vPosition).xyz;gl_Position=h(uViewProjection,p);jG=gl_Position.zw;\n#ifdef ALPHA_TEST\nd=vTexCoord+uUVOffset;\n#endif\n}","sky.glsl":"precision highp float;uniform sampler2D tSkyTexture;uniform float uAlpha;varying vec2 d;void main(void){vec3 r=texture2D(tSkyTexture,d).xyz;gl_FragColor.xyz=r*r;gl_FragColor.w=uAlpha;}","skySH.glsl":"precision mediump float;uniform vec4 uSkyCoefficients[9];uniform float uAlpha;varying vec3 jJ;void main(void){vec3 G=normalize(jJ);vec3 r=uSkyCoefficients[0].xyz;r+=uSkyCoefficients[1].xyz*G.y;r+=uSkyCoefficients[2].xyz*G.z;r+=uSkyCoefficients[3].xyz*G.x;vec3 swz=G.yyz*G.xzx;r+=uSkyCoefficients[4].xyz*swz.x;r+=uSkyCoefficients[5].xyz*swz.y;r+=uSkyCoefficients[7].xyz*swz.z;vec3 sqr=G*G;r+=uSkyCoefficients[6].xyz*(3.0*sqr.z-1.0);r+=uSkyCoefficients[8].xyz*(sqr.x-sqr.y);gl_FragColor.xyz=r;gl_FragColor.w=uAlpha;}","skyvert.glsl":"precision highp float;uniform mat4 uInverseSkyMatrix;uniform mat4 uViewProjection;attribute vec3 vPosition;attribute vec2 vTexCoord;\n#if SKYMODE == 3\nvarying vec3 jJ;\n#else\nvarying vec2 d;\n#endif\nvec4 h(mat4 i,vec3 p){return i[0]*p.x+(i[1]*p.y+(i[2]*p.z+i[3]));}vec4 u(mat4 i,vec3 v){return i[0]*v.x+i[1]*v.y+i[2]*v.z;}void main(void){vec3 p=h(uInverseSkyMatrix,vPosition).xyz;gl_Position=u(uViewProjection,p);gl_Position.z-=(1.0/65535.0)*gl_Position.w;\n#if SKYMODE == 3\njJ=vPosition;jJ.xy+=1e-20*vTexCoord;\n#else\nd=vTexCoord;\n#endif\n}","wirefrag.glsl":"precision highp float;uniform vec4 uStripParams;void main(void){vec2 c=gl_FragCoord.xy*uStripParams.xy-vec2(1.0,1.0);c.x+=0.25*c.y;float a=c.x<uStripParams.z?0.0:0.9;a=c.x<uStripParams.w?a:0.0;gl_FragColor=vec4(0.0,0.0,0.0,a);}","wirevert.glsl":"precision highp float;uniform mat4 uModelViewProjectionMatrix;attribute vec3 vPosition;vec4 h(mat4 i,vec3 p){return i[0]*p.x+(i[1]*p.y+(i[2]*p.z+i[3]));}void main(void){gl_Position=h(uModelViewProjectionMatrix,vPosition);gl_Position.z+=-0.00005*gl_Position.w;}",nil:""}}(marmoset)}]);